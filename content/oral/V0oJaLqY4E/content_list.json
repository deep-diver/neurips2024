[{"type": "text", "text": "Maximum Entropy Inverse Reinforcement Learning of Diffusion Models with Energy-Based Models ", "text_level": 1, "page_idx": 0}, {"type": "text", "text": "Sangwoong $\\mathbf{Y00n^{1}}$ , Himchan Hwang2, Dohyun Kwon1,3\u2020, Yung-Kyun $\\mathbf{Noh^{1,4\\dagger}}$ , Frank C. Park2,5\u2020 ", "page_idx": 0}, {"type": "text", "text": "1Korea Institute for Advanced Study, 2Seoul National University, 3University of Seoul, 4Hanyang University, 5Saige Research, $\\mathrm{{}^{\\dag}{\\bf C}o}_{0}.$ -corresponding Authors swyoon@kias.re.kr, himchan@robotics.snu.ac.kr, dhkwon@uos.ac.kr, nohyung@hanyang.ac.kr, fcp@snu.ac.kr ", "page_idx": 0}, {"type": "text", "text": "Abstract ", "text_level": 1, "page_idx": 0}, {"type": "text", "text": "We present a maximum entropy inverse reinforcement learning (IRL) approach for improving the sample quality of diffusion generative models, especially when the number of generation time steps is small. Similar to how IRL trains a policy based on the reward function learned from expert demonstrations, we train (or fine-tune) a diffusion model using the log probability density estimated from training data. Since we employ an energy-based model (EBM) to represent the log density, our approach boils down to the joint training of a diffusion model and an EBM. Our IRL formulation, named Diffusion by Maximum Entropy IRL (DxMI), is a minimax problem that reaches equilibrium when both models converge to the data distribution. The entropy maximization plays a key role in DxMI, facilitating the exploration of the diffusion model and ensuring the convergence of the EBM. We also propose Diffusion by Dynamic Programming $({\\mathrm{DxDP}})$ , a novel reinforcement learning algorithm for diffusion models, as a subroutine in DxMI. DxDP makes the diffusion model update in DxMI efficient by transforming the original problem into an optimal control formulation where value functions replace back-propagation in time. Our empirical studies show that diffusion models fine-tuned using DxMI can generate high-quality samples in as few as 4 and 10 steps. Additionally, DxMI enables the training of an EBM without MCMC, stabilizing EBM training dynamics and enhancing anomaly detection performance. ", "page_idx": 0}, {"type": "text", "text": "1 Introduction ", "text_level": 1, "page_idx": 0}, {"type": "text", "text": "Generative modeling is a form of imitation learning. Just as an imitation learner produces an action that mimics a demonstration from an expert, a generative model synthesizes a sample resembling the training data. In generative modeling, the expert to be imitated corresponds to the underlying data generation process. The intimate connection between generative modeling and imitation learning is already well appreciated in the literature [1, 2]. ", "page_idx": 0}, {"type": "text", "text": "The connection to imitation learning plays a central role in diffusion models [3, 4], which generate samples by transforming a Gaussian noise through iterative additive refinements. The training of a diffusion model is essentially an instance of behavioral cloning [5], a widely adopted imitation learning algorithm that mimics an expert\u2019s action at each state. During training, a diffusion model is optimized to follow a predefined diffusion trajectory that interpolates between noise and data. The trajectory provides a step-by-step demonstration of how to transform Gaussian noise into a sample, allowing diffusion models to achieve a new state-of-the-art in many generation tasks. ", "page_idx": 0}, {"type": "text", "text": "Behavioral cloning is also responsible for the diffusion model\u2019s key limitation, the slow generation speed. A behavior-cloned policy is not reliable when the state distribution deviates from the expert demonstration [6, 7]. Likewise, the sample quality from a diffusion model degrades as the gap ", "page_idx": 0}, {"type": "image", "img_path": "V0oJaLqY4E/tmp/80f78bb162bf2cba74e26d1c6b25a914f2885c36c6ca7ce1e2173d77a7c393c3.jpg", "img_caption": ["Diffusion Model $\\pi(\\mathbf{x})$ "], "img_footnote": [], "page_idx": 1}, {"type": "text", "text": "Figure 1: (Left) Overview of $\\mathrm{DxMI}$ . The diffusion model $\\pi(\\mathbf{x})$ is trained using the energy of $q(\\mathbf{x})$ as a reward. The EBM $q(\\mathbf{x})$ is trained using samples from $\\pi(\\mathbf{x})$ as negative samples. (Right) ImageNet 64 generation examples from a 10-step diffusion model before DxMI fine-tuning (up) and after fine-tuning (down). Only the last six steps out of ten are shown. ", "page_idx": 1}, {"type": "text", "text": "between training and generation grows. A diffusion model is typically trained to follow a fine-grained diffusion trajectory of 1,000 or more steps. Since 1,000 neural network evaluations are prohibitively expensive, fewer steps are often used during generation, incurring the distribution shift from the training phase and thus degraded sample quality. Speeding up a diffusion model while maintaining its high sample quality is a problem of great practical value, becoming an active field of research [8, 9, 10, 11, 12, 13]. ", "page_idx": 1}, {"type": "text", "text": "The slow generation in diffusion models can be addressed by employing inverse reinforcement learning (IRL; [14]), another imitation learning approach. Unlike behavioral cloning, which blindly mimics the expert\u2019s action at each state, the IRL approach first infers the reward function that explains the trajectory. When applied to diffusion models, IRL allows a faster generation trajectory to be found by guiding a sampler using the learned reward [11, 12, 13]. This approach is more frequently referred to as adversarial training because a common choice for the reward function is a discriminator classifying the training data and diffusion model\u2019s samples. However, resembling GAN, this adversarial approach may have similar drawbacks, such as limited exploration. ", "page_idx": 1}, {"type": "text", "text": "The first contribution of this paper is formulating maximum entropy IRL [15, 16, 2] for a diffusion model. Our formulation, named Diffusion by Maximum Entropy IRL (DxMI, pronounced \"diby-me\"), is a minimax problem that jointly optimizes a diffusion model and an energy-based model (EBM). In DxMI, the EBM provides the estimated log density as the reward signal for the diffusion model. Then, the diffusion model is trained to maximize the reward from EBM while simultaneously maximizing the entropy of generated samples. The maximization of entropy in DxMI facilitates exploration and stabilizes the training dynamics, as shown in reinforcement learning (RL) [17], IRL [15], and EBM [18] literature. Furthermore, the entropy maximization lets the minimax problem have an equilibrium when both the diffusion model and the EBM become the data distribution. ", "page_idx": 1}, {"type": "text", "text": "The diffusion model update step in DxMI is equivalent to maximum entropy RL. However, this step is challenging to perform for two reasons. First, the diffusion model update requires the gradient of the marginal entropy of a diffusion model\u2019s samples, which is difficult to estimate for discrete-time diffusion models, such as DDPM [3]. Second, back-propagating the gradient through the whole diffusion model is often infeasible due to memory constraints. Even with sufficient memory, the gradient may explode or vanish during propagation through time, causing training instability [19]. ", "page_idx": 1}, {"type": "text", "text": "Our second contribution is Diffusion by Dynamic Programming (DxDP), a novel maximum entropy RL algorithm for updating a diffusion model without the above-mentioned difficulties. First, DxDP mitigates the marginal entropy estimation issue by optimizing the upper bound of the original objective. In the upper bound, the marginal entropy is replaced by conditional entropies, which are easier to compute for a diffusion model. Then, DxDP removes the need for back-propagation in time by interpreting the objective as an optimal control problem and applying dynamic programming using value functions. The connection between optimal control and diffusion models is increasingly gaining attention [20, 21, 22], but DxDP is the first instance of applying discrete-time dynamic programming directly to train a diffusion model. Compared to policy gradient methods, we empirically find that DxDP converges faster and provides stronger diffusion models. As an RL algorithm, DxDP may have broader utility, such as fine-tuning a diffusion model from human or AI feedback. ", "page_idx": 1}, {"type": "text", "text": "We provide experimental results demonstrating the effectiveness of DxMI in training diffusion models and EBMs. On image generation tasks, DxMI can train strong short-run diffusion models that generate samples in 4 or 10 neural network evaluations. Also, DxMI can be used to train strong energy-based anomaly detectors. Notably, DxMI provides a novel way to train EBM without MCMC, which is computationally demanding and sensitive to the choice of hyperparameters. ", "page_idx": 2}, {"type": "text", "text": "The paper is structured as follows. In Section 2, we introduce the necessary preliminaries. Section 3 presents the DxMI framework, and Section 4 proposes the DxDP algorithm. Experimental results and related work are provided in Sections 5 and 6, respectively. Section 7 concludes the paper. The code for DxMI can be found in https://github.com/swyoon/Diffusion-by-MaxEntIRL.git. ", "page_idx": 2}, {"type": "text", "text": "2 Preliminaries ", "text_level": 1, "page_idx": 2}, {"type": "text", "text": "Diffusion Models. The diffusion model refers to a range of generative models trained by reversing the trajectory from the data distribution to the noise distribution. Among diffusion models, we focus on discrete-time stochastic samplers, such as DDPM [3], which synthesize a sample through the following iteration producing $\\overline{{\\mathbf{x}_{0}}},\\mathbf{x}_{1},\\dots,\\mathbf{x}_{T}\\in\\mathbb{R}^{D}$ : ", "page_idx": 2}, {"type": "equation", "text": "$$\n\\begin{array}{r}{\\mathrm{\\boldmath~\\rho~}_{\\!\\mathrm{\\boldmath~\\rho~}}\\sim\\mathcal{N}(0,I)\\quad\\mathrm{and}\\quad{\\bf x}_{t+1}=a_{t}{\\bf x}_{t}+\\mu({\\bf x}_{t},t)+\\sigma_{t}\\epsilon_{t}\\quad\\mathrm{for}\\quad t=0,1,\\ldots,T-1,}\\end{array}\n$$", "text_format": "latex", "page_idx": 2}, {"type": "text", "text": "where $\\displaystyle\\boldsymbol{\\epsilon}_{t}\\sim\\mathcal{N}(\\boldsymbol{0},I)$ and $\\mu({\\bf x},t)$ is the output of a neural network. The coefficients $a_{t}\\,\\in\\,\\mathbb{R}$ and $\\sigma_{t}\\,\\in\\,\\mathbb{R}_{>0}$ are constants. Note that we reverse the time direction in a diffusion model from the convention to be consistent with RL. The final state $\\mathbf{x}_{T}$ is the sample generated by the diffusion model, and its marginal distribution is $\\pi(\\mathbf{x}_{T})$ . We will often drop the subscript $T$ and write the distribution as $\\pi(\\mathbf{x})$ . The conditional distribution of a transition in Eq. (1) is denoted as $\\pi(\\mathbf{x}_{t+1}|\\mathbf{x}_{t})$ . For continuous-time diffusion models [23], Eq. (1) corresponds to using the Euler-Maruyama solver. ", "page_idx": 2}, {"type": "text", "text": "The generation process in Eq. (1) defines a $T$ -horizon Markov Decision Process (MDP) except for the reward. State $\\mathbf{s}_{t}$ and action ${\\mathbf a}_{t}$ are defined as $\\mathbf{s}_{t}=\\left(\\mathbf{x}_{t},t\\right)$ and $\\mathbf{a}_{t}=\\mathbf{x}_{t+1}$ . The transition dynamics is defined as $p(\\mathbf{s}_{t+1}|\\mathbf{s}_{t},\\mathbf{a}_{t})=\\delta_{(\\mathbf{a}_{t},t+1)}$ , where $\\delta_{(\\mathbf{x}_{t},t)}$ is a Dirac delta function at $\\left(\\mathbf{x}_{t},t\\right)$ . With a reward function defined, a diffusion model can be trained with RL [11, 24, 19, 25]. In this paper, we consider a case where the reward is the log data density $\\log p(\\mathbf{x})$ , which is unknown. ", "page_idx": 2}, {"type": "text", "text": "Energy-Based Models. An energy-based model (EBM) $q(\\mathbf{x})$ uses a scalar function called an energy $E(\\mathbf{x})$ to represent a probability distribution: ", "page_idx": 2}, {"type": "equation", "text": "$$\nq(\\mathbf{x})=\\frac{1}{Z}\\exp(-E(\\mathbf{x})/\\tau),\\quad E:\\mathcal{X}\\to\\mathbb{R},\n$$", "text_format": "latex", "page_idx": 2}, {"type": "text", "text": "where $\\tau>0$ is temperature, $\\mathcal{X}$ is the compact domain of data, and $\\begin{array}{r}{Z=\\int_{\\mathcal{X}}\\exp(-E(\\mathbf{x})/\\tau)d\\mathbf{x}<\\infty}\\end{array}$ is the normalization constant. ", "page_idx": 2}, {"type": "text", "text": "The standard method for training an EBM is by minimizing KL divergence between data $p(\\mathbf{x})$ and EBM $q(\\mathbf{x})$ , i.e., $\\operatorname*{min}_{q}K L(p||q)$ , where $\\begin{array}{r}{K L(p||q):=\\int_{\\mathcal{X}}\\overline{{p(\\mathbf{x})\\log(p(\\mathbf{x})/q(\\mathbf{x}))}}d\\mathbf{x}}\\end{array}$ . Computing the gradient of $K L(p||q)$ with respect to EBM parameters requires MCMC sampling, which is computationally demanding and sensitive to hyperparameters. The algorithm presented in this paper serves as an alternative method for training an EBM without MCMC. ", "page_idx": 2}, {"type": "text", "text": "EBMs have a profound connection to maximum entropy IRL, where Eq. (2) serves as a model for an expert\u2019s policy [15, 16, 2]. In maximum entropy IRL, $\\mathbf{x}$ corresponds to an action (or a sequence of actions), and $E(\\mathbf{x})$ represents the expert\u2019s cost of the action. The expert is then assumed to generate actions following $q(\\mathbf{x})$ . This assumption embodies the maximum entropy principle because Eq. (2) is a distribution that minimizes the cost while maximizing the entropy of the action. Here, $\\tau$ balances cost minimization and entropy maximization. ", "page_idx": 2}, {"type": "text", "text": "3 Diffusion by Maximum Entropy Inverse Reinforcement Learning ", "text_level": 1, "page_idx": 2}, {"type": "text", "text": "3.1 Objective: Generalized Contrastive Divergence ", "text_level": 1, "page_idx": 2}, {"type": "text", "text": "We aim to minimize the (reverse) KL divergence between a diffusion model $\\pi(\\mathbf{x})$ and the data density $p(\\mathbf{x})$ . This minimization can improve the sample quality of $\\pi(\\mathbf{x})$ , particularly when $T$ is small. ", "page_idx": 2}, {"type": "equation", "text": "$$\n\\operatorname*{min}_{\\pi\\in\\Pi}K L(\\pi(\\mathbf{x})||p(\\mathbf{x}))=\\operatorname*{max}_{\\pi\\in\\Pi}\\mathbb{E}_{\\pi}[\\log p(\\mathbf{x})]+\\mathcal{H}(\\pi(\\mathbf{x})),\n$$", "text_format": "latex", "page_idx": 2}, {"type": "text", "text": "where $\\Pi$ is the set of feasible $\\pi(\\mathbf{x})$ \u2019s, and $\\begin{array}{r}{\\mathcal{H}(\\pi)=-\\int\\pi(\\mathbf{x})\\log\\pi(\\mathbf{x})d\\mathbf{x}}\\end{array}$ is the differential entropy. This minimization is a maximum entropy RL problem: The log data density $\\log p(\\mathbf{x})$ is the reward, and $\\pi(\\mathbf{x})$ is the stochastic policy. However, we cannot solve Eq. (3) directly since $\\log p(\\mathbf{x})$ is unknown in a typical generative modeling setting. Instead, training data from $p(\\mathbf{x})$ are available, allowing us to employ an Inverse RL approach. ", "page_idx": 3}, {"type": "text", "text": "In this paper, we present Diffusion by Maximum Entropy IRL $\\left(\\mathbf{D}\\mathbf{x}\\mathbf{M}\\mathbf{I}\\right)$ as an IRL approach for solving Eq. (3). We employ an EBM $q(\\mathbf{x})$ (Eq. (2)) as a surrogate for $p(\\mathbf x)$ and use $\\log q(\\mathbf{x})$ as the reward for training the diffusion model instead of $\\log p(\\mathbf{x})$ . At the same time, we train $q(\\mathbf{x})$ to be close to $p(\\mathbf{x})$ by minimizing the divergence between $p(\\mathbf{x})$ and $q(\\mathbf{x})$ : ", "page_idx": 3}, {"type": "equation", "text": "$$\n\\operatorname*{min}_{\\pi\\in\\Pi}K L(\\pi(\\mathbf{x})||q(\\mathbf{x}))\\quad\\mathrm{and}\\quad\\operatorname*{min}_{q\\in\\mathcal{Q}}K L(p(\\mathbf{x})||q(\\mathbf{x})),\n$$", "text_format": "latex", "page_idx": 3}, {"type": "text", "text": "where $\\mathcal{Q}$ is the feasible set of EBMs. When the two KL divergences become zero, $p(\\mathbf{x})=q(\\mathbf{x})=$ $\\pi(\\mathbf{x})$ is achieved. However, $\\mathrm{min}_{q\\in\\mathcal{Q}}\\,K L(p(\\mathbf{x})||q(\\mathbf{x}))$ is difficult due to the normalization constant of $q(\\mathbf{x})$ . Instead, we consider an alternative minimax formulation inspired by Contrastive Divergence (CD; [26]), a celebrated algorithm for training an EBM. ", "page_idx": 3}, {"type": "text", "text": "Objective. Let $p(\\mathbf{x})$ be the data distribution. Suppose that $\\mathcal{Q}$ and $\\Pi$ are the feasible sets of the EBM $q(\\mathbf{x})$ and the diffusion model $\\pi(\\mathbf{x})$ , respectively. The learning problem of DxMI is formulated as follows: ", "page_idx": 3}, {"type": "equation", "text": "$$\n\\operatorname*{min}_{q\\in\\mathcal{Q}}\\operatorname*{max}_{\\pi\\in\\Pi}K L(p(\\mathbf{x})||q(\\mathbf{x}))-K L(\\pi(\\mathbf{x})||q(\\mathbf{x})).\n$$", "text_format": "latex", "page_idx": 3}, {"type": "text", "text": "eral class of samplers. CD [26] is originally given as We shall call Eq. (5) Generalized CD (GCD), because Eq. (5) generalizes CD by incorporating a gen- $\\begin{array}{r}{\\operatorname*{min}_{q\\in\\mathcal{Q}}\\bar{K}L(p(\\mathbf{x})||q(\\mathbf{x}))\\overset{\\cdot}{-}K L(\\dot{\\nu}_{p,q}^{k}(\\mathbf{x})||q(\\mathbf{\\bar{x}}))}\\end{array}$ . Here, $\\nu_{p,q}^{k}(\\mathbf{x})$ is a $k$ -step MCMC sample distribution where Markov chains having $q(\\mathbf{x})$ as a stationary distribution are initialized from $p(\\mathbf x)$ . GCD replaces $\\nu_{p,q}^{k}(\\mathbf{x})$ with a general sampler $\\pi(\\mathbf{x})$ at the expense of introducing a max operator. ", "page_idx": 3}, {"type": "text", "text": "When the models are well-specified, i.e., $p(\\mathbf{x})\\,\\in\\,\\mathcal{Q}\\,=\\,\\Pi$ , Nash equilibrium of GCD is $p(\\mathbf{x})\\,=$ $q(\\mathbf{x})=\\pi(\\mathbf{x})$ , which is identical to the solution of Eq. (4). Meanwhile, there is no need to compute the normalization constant, as the two KL divergences cancel the normalization constant out. Note that the objective function (Eq. (5)) can be negative, allowing $q(\\mathbf{x})$ be closer to $p(\\mathbf{x})$ than $\\pi(\\mathbf{x})$ . ", "page_idx": 3}, {"type": "text", "text": "Our main contribution is exploring the application of discrete-time diffusion models (Eq. (1)) as $\\pi(\\mathbf{x})$ in GCD and not discovering GCD for the first time. GCD is mathematically equivalent to a formulation called variational maximum likelihood or adversarial EBM, which has appeared several times in EBM literature [27, 28, 29, 30, 31, 32, 33]. However, none of them have investigated the use of a diffusion model as $\\pi(\\mathbf{x})$ , where optimization and entropy estimation are challenging. We discuss the challenges in Section 3.2 and provide a novel algorithm to address them in Section 4. ", "page_idx": 3}, {"type": "text", "text": "3.2 Alternating Update of EBM and Diffusion Model ", "text_level": 1, "page_idx": 3}, {"type": "text", "text": "In DxMI, we update a diffusion model and an EBM in an alternative manner to find the Nash equilibrium. We write $\\theta$ and $\\phi$ as the parameters of the energy $E_{\\theta}(\\mathbf{x})$ and a diffusion model $\\pi_{\\phi}(\\mathbf{x})$ , respectively. While EBM update is straightforward, we require a subroutine described in Section 4 for updating the diffusion model. The entire procedure of $\\mathrm{DxMI}$ is summarized in Algorithm 1. ", "page_idx": 3}, {"type": "text", "text": "EBM Update. The optimization with respect to EBM is written as $\\mathrm{min}_{\\theta}\\,\\mathbb{E}_{p(\\mathbf{x})}[E_{\\theta}(\\mathbf{x})]\\,-$ $\\mathbb{E}_{\\pi_{\\phi}(\\mathbf{x})}[E_{\\theta}(\\mathbf{x})]$ . During the update, we also regularize the energy by the square of energies $\\gamma(\\underline{{\\mathbb{E}}}_{p(\\mathbf{x})}[E_{\\theta}(\\mathbf{x})_{\\:}^{2}]+\\underline{{\\mathbb{E}}}_{\\pi_{\\phi}(\\mathbf{x})}[E_{\\theta}(\\mathbf{x})_{\\:}^{2}])_{.}$ for $\\gamma\\,>\\,0$ to ensure the energy is bounded. We set $\\gamma\\,=\\,1$ unless stated otherwise. This regularizer is widely adopted in EBM [34, 35]. ", "page_idx": 3}, {"type": "text", "text": "Difficulty of Diffusion Model Update. Ideally, diffusion model parameter $\\phi$ should be updated by minimizing $K L(\\pi_{\\phi}||q_{\\theta})=\\mathbb{E}_{\\pi_{\\phi}(\\mathbf{x})}^{-}[E_{\\theta}(\\mathbf{x})/\\tau]-\\mathcal{H}(\\pi_{\\phi}(\\mathbf{x}))$ . However, this update is difficult in practice for two reasons. ", "page_idx": 3}, {"type": "text", "text": "First, marginal entropy $\\mathcal{H}(\\pi_{\\phi}(\\mathbf{x}))$ is difficult to estimate. Discrete-time diffusion models (Eq. (1)) do not provide an efficient way to evaluate $\\log\\pi_{\\phi}(\\mathbf{x})$ required in the computation of $\\mathcal{H}(\\pi_{\\phi}(\\mathbf{x}))$ , unlike some continuous-time models, e.g., continuous normalizing flows [36, 23]. Other entropy estimators based on $\\mathbf{k}$ -nearest neighbors [37] or variational methods [38, 39] do not scale well to ", "page_idx": 3}, {"type": "text", "text": "Algorithm 1 Diffusion by Maximum Entropy IRL ", "text_level": 1, "page_idx": 4}, {"type": "table", "img_path": "V0oJaLqY4E/tmp/35e46f468ac9995e8ab630a9dea9d77ff5529be5cf08cdefa36e367cd2b4f3ea.jpg", "table_caption": [], "table_footnote": [], "page_idx": 4}, {"type": "text", "text": "high-dimensional spaces. Second, propagating the gradient through time in a diffusion model may require significant memory. Also, the gradient may explode or vanish during propagation, making the training unstable [19]. ", "page_idx": 4}, {"type": "text", "text": "4 Diffusion by Dynamic Programming ", "text_level": 1, "page_idx": 4}, {"type": "text", "text": "In this section, we present a novel RL algorithm for a diffusion model, Diffusion by Dynamic Programming (DxDP), which addresses the difficulties in updating a diffusion model for the reward. DxDP leverages optimal control formulation and value functions to perform the diffusion model update in $\\mathrm{DxMI}$ efficiently. Note that DxDP can be used separately from DxMI to train a diffusion model for an arbitrary reward. ", "page_idx": 4}, {"type": "text", "text": "4.1 Optimal Control Formulation ", "text_level": 1, "page_idx": 4}, {"type": "text", "text": "Instead of solving $\\begin{array}{r}{\\operatorname*{min}_{\\phi}K L(\\pi_{\\phi}(\\mathbf{x}_{T})||q_{\\theta}(\\mathbf{x}_{T}))}\\end{array}$ directly, we minimize its upper bound obtained from the data processing inequality: ", "page_idx": 4}, {"type": "equation", "text": "$$\nK L(\\pi_{\\phi}(\\mathbf{x}_{T})||q_{\\theta}(\\mathbf{x}_{T}))\\leq K L(\\pi_{\\phi}(\\mathbf{x}_{0:T})||q_{\\theta}(\\mathbf{x}_{T})\\tilde{q}(\\mathbf{x}_{0:T-1}|\\mathbf{x}_{T})).\n$$", "text_format": "latex", "page_idx": 4}, {"type": "text", "text": "Here, we introduce an auxiliary distribution $\\tilde{q}(\\mathbf{x}_{0:T-1}|\\mathbf{x}_{T})$ , and the inequality holds for an arbitrary choice of $\\tilde{q}(\\mathbf{x}_{0:T-1}|\\mathbf{x}_{T})$ . In this paper, we consider a particularly simple case where $\\tilde{q}(\\mathbf{x}_{0:T-1}|\\mathbf{x}_{T})$ is factorized into conditional Gaussians as follows: ", "page_idx": 4}, {"type": "equation", "text": "$$\n\\tilde{q}(\\mathbf{x}_{0:T-1}|\\mathbf{x}_{T})=\\prod_{t=0}^{T-1}\\tilde{q}(\\mathbf{x}_{t}|\\mathbf{x}_{t+1}),\\mathrm{~where~}\\tilde{q}(\\mathbf{x}_{t}|\\mathbf{x}_{t+1})=\\mathcal{N}(\\mathbf{x}_{t+1},s_{t}^{2}I),\\quad s_{t}>0.\n$$", "text_format": "latex", "page_idx": 4}, {"type": "text", "text": "Now we minimize the right-hand side of Eq. (6): $\\begin{array}{r l}{\\operatorname*{min}_{\\phi}K L(\\pi_{\\phi}(\\mathbf{x}_{0:T})||q_{\\theta}(\\mathbf{x}_{T})\\tilde{q}(\\mathbf{x}_{0:T-1}|\\mathbf{x}_{T}))}&{{}}\\end{array}$ . When we plug in the definitions of each distribution, multiply by $\\tau$ , and discard all constants, we obtain the following problem: ", "page_idx": 4}, {"type": "equation", "text": "$$\n\\operatorname*{min}_{\\phi}\\underset{\\boldsymbol{\\pi}_{\\phi}(\\mathbf{x}_{0:T})}{\\mathbb{E}}\\left[E_{\\theta}(\\mathbf{x}_{T})+\\tau\\sum_{t=0}^{T-1}\\log\\pi_{\\phi}(\\mathbf{x}_{t+1}|\\mathbf{x}_{t})+\\tau\\sum_{t=0}^{T-1}\\frac{1}{2s_{t}^{2}}||\\mathbf{x}_{t+1}-\\mathbf{x}_{t}||^{2}\\right],\n$$", "text_format": "latex", "page_idx": 4}, {"type": "text", "text": "which is an optimal control problem. The controller $\\pi_{\\phi}(\\cdot)$ is optimized to minimize the terminal cost $E_{\\theta}(\\mathbf{x}_{T})$ plus the running costs for each transition $(\\mathbf{x}_{t},\\mathbf{x}_{t+1})$ . The first running cost $\\log\\pi_{\\phi}(\\mathbf{x}_{t+1}|\\mathbf{x}_{t})$ is responsible for conditional entropy maximization, because $\\mathbb{E}_{\\pi}[\\log\\pi_{\\phi}(\\mathbf{x}_{t+1}|\\mathbf{x}_{t})]\\;=\\;-\\mathcal{H}\\big(\\pi_{\\phi}(\\mathbf{x}_{t+1}|\\mathbf{x}_{t})\\big)$ . The second running cost regularizes the \u201cvelocity\" $||\\mathbf{x}_{t+1}-\\mathbf{x}_{t}||^{2}$ . The temperature $\\tau$ balances between the terminal and running costs. ", "page_idx": 4}, {"type": "text", "text": "We have circumvented the marginal entropy computation in GCD, as all terms in Eq. (8) are easily computable. For the diffusion model considered in this paper (Eq. (1)), the conditional entropy has a particularly simple expression $\\begin{array}{r}{\\mathcal{H}(\\pi_{\\phi}(\\mathbf{x}_{t+1}|\\mathbf{x}_{t}))=D\\log\\sigma_{t}+\\bar{0}.5D\\log2\\pi}\\end{array}$ . Therefore, optimizing the entropy running cost amounts to learning $\\sigma_{t}$ \u2019s in diffusion, and we treat $\\sigma_{t}$ \u2019s as a part of the diffusion model parameter $\\phi$ in $\\mathrm{DxMI}$ . ", "page_idx": 4}, {"type": "image", "img_path": "V0oJaLqY4E/tmp/8b805941f6c8035d3fdb530a58884f50faf34cc9bc37c6d44376e9135e9ef6c4.jpg", "img_caption": ["Figure 2: 2D density estimation on 8 Gaussians. Red shades indicate the energy (white is low), and the dots are generated samples. ", "Table 1: Quantitative results for 8 Gaussians experiment. $S W$ denotes the sliced Wasserstein distance between samples and data. AUC is computed for classification between data and uniform noise using the energy. The standard deviation is computed from 5 independent samplings. The ideal maximum value of AUC is about 0.906. "], "img_footnote": [], "page_idx": 5}, {"type": "text", "text": "4.2 Dynamic Programming ", "text_level": 1, "page_idx": 5}, {"type": "table", "img_path": "V0oJaLqY4E/tmp/067488c7514eb57167b20ec188432bc0055dceec92be55926b75dcbf1fccb1a2.jpg", "table_caption": [], "table_footnote": [], "page_idx": 5}, {"type": "text", "text": "We propose a dynamic programming approach for solving Eq. (8). Dynamic programming introduces value functions to break down the problem into smaller problems at each timestep, removing the need for back-propagation in time. Then, a policy, a diffusion model in our case, is optimized through iterative alternating applications of policy evaluation and policy improvement steps. ", "page_idx": 5}, {"type": "text", "text": "Value Function. A value function, or cost-to-go function $V_{\\psi}^{t}(\\mathbf{x}_{t})$ , is defined as the expected sum of the future costs starting from $\\mathbf{x}_{t}$ , following $\\pi$ . We write the parameters of a value function as $\\psi$ . ", "page_idx": 5}, {"type": "equation", "text": "$$\nV_{\\psi}^{t}(\\mathbf{x}_{t})=\\mathbb{E}_{\\boldsymbol\\pi}\\left[E_{\\theta}(\\mathbf{x}_{T})+\\tau\\sum_{t^{\\prime}=t}^{T-1}\\log\\pi_{\\phi}(\\mathbf{x}_{t^{\\prime}+1}|\\mathbf{x}_{t^{\\prime}})+\\sum_{t^{\\prime}=t}^{T-1}\\frac{\\tau}{2s_{t^{\\prime}}^{2}}||\\mathbf{x}_{t^{\\prime}+1}-\\mathbf{x}_{t^{\\prime}}||^{2}\\middle|\\mathbf{x}_{t}\\right],\n$$", "text_format": "latex", "page_idx": 5}, {"type": "text", "text": "for $t=0,\\dots,T-1$ . Note that $V^{T}(\\mathbf{x}_{T})=E(\\mathbf{x}_{T})$ . A value function can be implemented with a neural network, but there are multiple design choices, such as whether to share the parameters with $\\pi(\\mathbf{x})$ or $E(\\mathbf{x})$ , and also whether the parameters should be shared across time. We explore the options in our experiments. ", "page_idx": 5}, {"type": "text", "text": "Policy Evaluation. During policy evaluation, we estimate the value function for the current diffusion model by minimizing the Bellman residual, resulting in the temporal difference update. ", "page_idx": 5}, {"type": "equation", "text": "$$\n\\operatorname*{min}_{\\psi}\\mathbb{E}_{\\mathbf{x}_{t},\\mathbf{x}_{t+1}\\sim\\pi}[(\\mathbf{s}\\mathbf{g}[V_{\\psi}^{t+1}(\\mathbf{x}_{t+1})]+\\tau\\log\\pi_{\\phi}(\\mathbf{x}_{t+1}|\\mathbf{x}_{t})+\\frac{\\tau}{2s_{t}^{2}}||\\mathbf{x}_{t}-\\mathbf{x}_{t+1}||^{2}-V_{\\psi}^{t}(\\mathbf{x}_{t}))^{2}],\n$$", "text_format": "latex", "page_idx": 5}, {"type": "text", "text": "where $\\mathrm{sg}[\\cdot]$ denotes a stop-gradient operator indicating that gradient is not computed for the term. ", "page_idx": 5}, {"type": "text", "text": "Policy Improvement. The estimated value is used to improve the diffusion model. For each $\\mathbf{x}_{t}$ in a trajectory $\\mathbf{x}_{0:T}$ sampled from $\\pi_{\\phi}(\\mathbf{x}_{0:T})$ , the diffusion model is optimized to minimize the next-state value and the running costs. ", "page_idx": 5}, {"type": "equation", "text": "$$\n\\operatorname*{min}_{\\phi}\\mathbb{E}_{\\pi_{\\phi}(\\mathbf{x}_{t+1}|\\mathbf{x}_{t})}\\left[V_{\\psi}^{t+1}(\\mathbf{x}_{t+1})+\\tau\\log\\pi_{\\phi}(\\mathbf{x}_{t+1}|\\mathbf{x}_{t})+\\frac{\\tau}{2s_{t}^{2}}||\\mathbf{x}_{t}-\\mathbf{x}_{t+1}||^{2}\\right]\\!\\mathbf{x}_{t}\\right].\n$$", "text_format": "latex", "page_idx": 5}, {"type": "text", "text": "In practice, each iteration of policy evaluation and improvement involves a single gradient step. ", "page_idx": 5}, {"type": "text", "text": "Adaptive Velocity Regularization (AVR). We additionally propose a method for systematically determining the hyperparameter $s_{t}$ \u2019s of the auxiliary distribution $\\tilde{q}(\\mathbf{x}_{0:T-1}|\\mathbf{x}_{T})$ . We can optimize $s_{t}$ such that the inequality Eq. (6) is as tight as possible by solving $\\begin{array}{r}{\\operatorname*{min}_{s_{0},\\dots,s_{T-1}}K L(\\pi_{\\phi}(\\mathbf{x}_{0:T})||q_{\\theta}(\\mathbf{x}_{T})\\tilde{q}(\\mathbf{x}_{0:T-1}|\\mathbf{x}_{T}))}\\end{array}$ . After calculation (details in Appendix A), the optimal $s_{t}^{*}$ can be obtained analytically: $(s_{t}^{*})^{2}=\\mathbb{E}_{\\mathbf{x}_{t},\\mathbf{x}_{t+1}\\sim\\pi}[||\\mathbf{x}_{t}-\\mathbf{x}_{t+1}||^{2}]/D$ . In practice, we can use exponential moving average to compute the expectation $\\mathbb{E}_{\\mathbf{x}_{t},\\mathbf{x}_{t+1}\\sim\\pi}[||\\mathbf{x}_{t}-\\mathbf{x}_{t+1}||^{2}]$ during training: $s_{t}^{2}\\gets\\alpha s_{t}^{2}+(1-\\alpha)||\\mathbf x_{t}-\\mathbf x_{t+1}||^{2}/D$ where we set $\\alpha=0.99$ for all experiment. ", "page_idx": 5}, {"type": "text", "text": "4.3 Techniques for Image Generation Experiments ", "text_level": 1, "page_idx": 6}, {"type": "text", "text": "When using DxDP for image generation, one of the most common applications of diffusion models, we introduce several design choices to DxDP to enhance performance and training stability. The resulting algorithm is summarized in Algorithm 2. ", "page_idx": 6}, {"type": "text", "text": "Time-Independent Value Function. In image generation experiments (Section 5.2), we let the value function be independent of time, i.e., $V_{\\psi}^{\\bar{t}}(\\mathbf{x}_{t})=V_{\\psi}(\\mathbf{x}_{t})$ . Removing the time dependence reduces the number of parameters to be trained. More importantly, a time-independent value function can learn better representation because the value function is exposed to diverse inputs, including both noisy and clean images. On the contrary, a time-dependent value function $V_{\\psi}^{t}(\\mathbf{x}_{t})$ never observes samples having different noise levels than the noise level of $\\mathbf{x}_{t}$ . ", "page_idx": 6}, {"type": "text", "text": "Time Cost. Also, in the value update (Eq. (10)) step of image generation experiments, we introduce time cost function $R(t)>0$ , which replaces the running cost terms $\\tau\\log\\pi_{\\phi}(\\mathbf{x}_{t+1}|\\mathbf{x}_{t})+$ $\\tau||\\mathbf{x}_{t}-\\mathbf{x}_{t+1}||^{2}/(2s_{t}^{2})$ . The time cost $R(t)$ only depends on time $t$ . The modified value update equation is given as follows: ", "page_idx": 6}, {"type": "equation", "text": "$$\n\\underset{\\psi}{\\operatorname*{min}}\\,\\mathbb{E}_{\\mathbf{x}_{t},\\mathbf{x}_{t+1}\\sim\\pi}[(\\mathbf{sg}[V_{\\psi}(\\mathbf{x}_{t+1})]+R(t)-V_{\\psi}(\\mathbf{x}_{t}))^{2}].\n$$", "text_format": "latex", "page_idx": 6}, {"type": "text", "text": "Meanwhile, we retain the running cost terms in the diffusion model (policy) update step (Eq. (11)). The time cost $R(t)$ is predetermined and fixed throughout training. The introduction of time cost is motivated by the observation that the running costs can fluctuate during the initial stage of training, posing difficulty in value function learning. The time cost stabilizes the training by reducing this variability. Moreover, the time cost ensures that the value function decreases monotonically over time. Such monotonicity is known to be beneficial in IRL for episodic tasks [16]. ", "page_idx": 6}, {"type": "text", "text": "We employ two types of $R(t)$ : \u201clinear\" and \u201csigmoid\". A linear time cost is given as $R(t)=c$ where we use $c=0.05$ . The linear time cost encourages the value to decrease linearly as time progresses. The sigmoid time cost is $R(t)=\\sigma(-t{+}T/2)){-}\\sigma(-t{-}1{+}T/2))$ , where $\\sigma(x)\\stackrel{.}{=}(1\\mathrm{+}\\exp(\\stackrel{.}{-}x))^{-1}$ . With the sigmoid time cost, the value function is trained to follow a sigmoid function centered at $T/2$ when plotted against the time. Other forms of $R(t)$ are also possible. ", "page_idx": 6}, {"type": "text", "text": "Separate tuning of $\\tau$ . In image generation, we assign different values of temperature $\\tau$ for entropy regularization $\\log\\pi_{\\phi}(\\mathbf{x}_{t+\\bar{1}}|\\mathbf{x}_{t})$ and velocity regularization $||\\mathbf{x}_{t}-\\mathbf{x}_{t+1}||^{2}/(\\dot{2}s_{t}^{2})$ , such that the resulting running cost becomes $\\tau_{1}\\log\\pi_{\\phi}(\\mathbf{x}_{t+1}|\\mathbf{x}_{t})+\\tau_{2}||\\mathbf{x}_{t}-\\mathbf{x}_{t+1}||^{2}/(2s_{t}^{2})$ . Typically, we found $\\tau_{1}>\\tau_{2}$ beneficial, indicating the benefit of exploration. Setting $\\tau_{1}\\neq\\tau_{2}$ does not violate our maximum entropy formulation, as scaling $\\tau_{2}$ is equivalent to scaling $s_{t}^{2}\\bar{\\mathrm{s}}$ , which can be set arbitrarily. ", "page_idx": 6}, {"type": "text", "text": "5 Experiments ", "text_level": 1, "page_idx": 6}, {"type": "text", "text": "In this section, we provide empirical studies that demonstrate the effectiveness of $\\mathrm{DxMI}$ in training a diffusion model and an EBM. We first present a 2D example, followed by image generation and anomaly detection experiments. More details on experiments can be found in Appendix C. ", "page_idx": 6}, {"type": "text", "text": "5.1 2D Synthetic Data ", "text_level": 1, "page_idx": 6}, {"type": "text", "text": "We illustrate how DxMI works on 2D 8 Gaussians data. DxMI is applied to train a five-step diffusion model $\\mathcal{T}=5\\$ ) with a corresponding time-dependent value network, both parametrized by timeconditioned multi-layer perceptron (MLP). The last time step $T=5$ ) of the value network is treated as the energy. The sample quality is measured with sliced Wasserstein distance (SW) to test data. Also, we quantify the quality of an energy function through the classification performance to uniform noise samples (Table 1). ", "page_idx": 6}, {"type": "text", "text": "First, we investigate the effect of maximum entropy regularization $\\tau$ . Setting an appropriate value for $\\tau$ greatly benefits the quality of both the energy and the samples. When $\\tau=0.1$ , the samples from $\\mathrm{DxMI}$ have smaller SW than the samples from a full-length DDPM do. The energy also accurately captures the data distribution, scoring high AUC against the uniform noise. Without entropy regularization $\\tau=0$ ), DxMI becomes similar to GAN [40]. The generated samples align moderately well with the training data, but the energy does not reflect the data distribution. When $\\tau$ is too large $\\left[\\tau=1\\right]$ ), the generated samples are close to noise. In this regime, DxMI behaves similarly to Noise Contrastive Estimation [41], enabling energy function learning to a certain extent. These effects are visualized in Fig. 2. ", "page_idx": 6}, {"type": "table", "img_path": "V0oJaLqY4E/tmp/5798f938bc82971ec7bfbfea5273144bad8f12d49a1f10af7223a409b5d79b82.jpg", "table_caption": ["Table 2: CIFAR-10 unconditional image generation. $^{\\dagger}$ : the starting point of $\\mathrm{DxMI}$ fine-tuning. "], "table_footnote": [], "page_idx": 7}, {"type": "table", "img_path": "V0oJaLqY4E/tmp/14d1d144c17dc9154556108fcb8b8588f1c901095f4ee2b2fb1e492750c87e74.jpg", "table_caption": ["Table 3: ImageNet $64\\!\\times\\!64$ conditional image generation. \u2020: the starting point of $\\mathrm{DxMI}$ fine-tuning. "], "table_footnote": [], "page_idx": 7}, {"type": "text", "text": "", "page_idx": 7}, {"type": "text", "text": "Next, we experiment on whether pre-training a sampler as DDPM helps DxMI. Table 1 suggests that the pre-training is beneficial but not necessary to make DxMI work. We also visualize the value functions in Fig. 3 and find that the time evolution of value interpolates the data distribution and a Gaussian distribution. ", "page_idx": 7}, {"type": "text", "text": "5.2 Image Generation: Training Diffusion Models with Small $T$ ", "text_level": 1, "page_idx": 7}, {"type": "text", "text": "On image generation tasks, we show that DxMI can be used to fine-tune a diffusion model with reduced generation steps, such as $T=4$ or 10. We test DxMI on unconditional CIFAR-10 [52] $(32\\times32)$ , conditional ImageNet [53] downsampled to $64\\times64$ , and LSUN Bedroom [54] $(256\\!\\times\\!256)$ , using three diffusion model backbones, DDPM [3], DDGAN [46], and variance exploding version of EDM [50]. The results can be found in Table 2, 3, and 4. Starting from ", "page_idx": 7}, {"type": "table", "img_path": "V0oJaLqY4E/tmp/513d6096a3955d0c7a69c5a3301245b0d4240b237428cb6cc4a66cbfbe85e18c.jpg", "table_caption": ["Table 4: LSUN Bedroom $256\\times256$ unconditional image generation. "], "table_footnote": [], "page_idx": 7}, {"type": "text", "text": "a publicly available checkpoint of each pretrained backbone, we first adjust the noise schedule for the target sampling steps $T$ . When adjusting the noise, for DDPM, we follow the schedule of FastDPM [8], and for EDM, we use Eq. (5) of [50]. No adjustment is made for DDGAN, which was originally built for $T=4$ . The adjusted models are used as the starting point of DxMI training. A single CIFAR-10 run reaches the best FID in less than 4 hours on four A100 GPUs. We set $\\tau_{1}=0.1$ and $\\tau_{2}=0.01$ . The sigmoid time cost is used for all image generation experiments. The sample quality is measured by FID [55], Precision (Prec., [56]), and Recall (Rec., [56]). ResNet is used as our value function and is trained from scratch. More experimental details are in Appendix C.2. ", "page_idx": 7}, {"type": "text", "text": "Short-run diffusion models fine-tuned by DxMI display competitive sample quality. Unlike distillation methods, which are often limited by their teacher model\u2019s performance, DxMI can surpass the pretrained starting point. Although DxMI does not support single-step generation, DxMI offers a principled approach to training a high-quality generative model with a moderate computation burden (Appendix D). Note that DDGAN does not fti the formulation of $\\mathrm{DxMI}$ , as $\\pi(\\mathbf{x}_{t+1}|\\mathbf{x}_{t})$ in DDGAN is not Gaussian. Nevertheless, DxMI can still enhance sample quality, showing its robustness. ", "page_idx": 7}, {"type": "text", "text": "", "page_idx": 8}, {"type": "text", "text": "Furthermore, DxMI outperforms SFT-PG [11], another IRL approach implemented with a policy gradient. For a fair comparison, we have ensured that the backbone and the initial checkpoint of SFT-PG and DxMI are identical. Thus, the performance gap can be attributed to the two differences between SFT-PG and DxMI. First, DxMI uses dynamic programming instead of policy gradient. In DxDP, the value function is more directly utilized to guide the learning of the diffusion model. Meanwhile, in policy gradient, the role of the value function is variance reduction. As SFT-PG also requires a value function during training, the computational overhead of $\\mathrm{DxMI}$ is nearly identical to SFT-PG. Second, DxMI incorporates the maximum entropy principle, which facilitates exploration. ", "page_idx": 8}, {"type": "text", "text": "We also conduct ablation studies for the components of DxMI and append the results in Table 2 and 3. First, the temperature parameters are set to zero $\\tau_{1}=\\tau_{2}=0$ in the sampler update (11). Then, we compare the linear time cost to the sigmoid time cost. In both cases, We observe the increase in FID and the decrease in Recall. ", "page_idx": 8}, {"type": "text", "text": "To investigate whether the trained value function captures useful information, we implement value guidance, where we shift the trajectory of generation slightly along the value function gradient, similarly to classifier guidance [47] and discriminator guidance [57]. When sampling the next step $\\mathbf x_{t+1}$ , we add a small drift with coefficient $\\lambda$ , i.e., $\\mathbf{x}_{t+1}\\leftarrow\\mathbf{x}_{t+1}-\\lambda\\sigma_{t}\\nabla_{\\mathbf{x}_{t+1}}V_{\\psi}(\\mathbf{x}_{t+1})$ . We observe sample quality metric improvement until $\\lambda$ is 0.5. This observation suggests that the value function gradient is aligned well with the data density gradient. ", "page_idx": 8}, {"type": "text", "text": "5.3 Energy-Based Anomaly Detection and Localization ", "text_level": 1, "page_idx": 8}, {"type": "text", "text": "We demonstrate the ability of $\\mathrm{DxMI}$ to train an accurate energy function on an anomaly detection task using the MVTec-AD dataset [61], which contains $224\\!\\times\\!224$ RGB images of 15 object categories. We follow the multi-class problem setup proposed by [60]. The training dataset contains normal object images from 15 categories without any labels. The test set consists of both normal and defective object images, each provided with an anomaly label and a mask indicating the defect location. The goal is to detect and localize anomalies, with performance measured by AUC computed per object category. This setting is challenging because the energy function should reflect the multi-modal data distribution. Following the preprocessing protocol in [60, 59], each image is transformed into a $272\\!\\times\\!14\\!\\times\\!14$ vector using a pre-trained EfficientNet-b4 [62]. DxMI is conducted in a 272-dimensional space, treating each spatial coordinate independently. With the trained energy function, we can evaluate the energy value of $14\\mathrm{x}14$ spatial features and use max pooling and bilinear interpolation for anomaly detection and localization, respectively. ", "page_idx": 8}, {"type": "table", "img_path": "V0oJaLqY4E/tmp/3c79be4e99ae52b60818f95194512d7792791bc52b387be278eb3527e4ad56bf.jpg", "table_caption": ["Table 5: MVTec-AD multi-class anomaly detection and localization experiment. Anomaly detection (DET) and localization (LOC) performance are measured in AUC. Due to the space constraint, only the average AUC over 15 classes is presented. The full results are provided in Table 6. "], "table_footnote": [], "page_idx": 8}, {"type": "text", "text": "", "page_idx": 8}, {"type": "text", "text": "We use separate networks for the energy function and the value function in this experiment, as the primary goal is to obtain an accurate energy function. We employ an autoencoder architecture for the energy function, treating the reconstruction error of a sample as its energy [63]. The diffusion model and the value function are five-step time-conditioned MLPs. Unlike conventional diffusion models, DxMI allows for a flexible choice of $\\pi(\\mathbf{x}_{0})$ . We set the initial distribution for the sampler to the data distribution applied with noise, aiming to identify the energy value more precisely near the data distribution. More experimental details can be found in Appendix C.3. ", "page_idx": 8}, {"type": "text", "text": "DxMI demonstrates strong anomaly classification and localization performance, as shown in Table 5. This result indicates that the trained energy function effectively captures the boundary of normal data. When entropy maximization is disabled by $\\tau=0$ , the diffusion model fails to explore and only exploits regions of minimum energy, resulting in poor performance. We observe that a moderate level of $\\tau=0.1$ benefits both the sampler and the energy function, as it encourages exploration and provides a suitable level of diversity in negative samples. ", "page_idx": 8}, {"type": "text", "text": "6 Related Work ", "text_level": 1, "page_idx": 9}, {"type": "text", "text": "Faster Diffusion Models. Significant effort has been dedicated to reducing the number of generation steps in diffusion models during sampling while preserving sample quality. One popular approach is to keep the trained diffusion model unchanged and improve the sampling phase independently by tuning the noise schedule [8, 64, 65, 9], improving differential equation solvers [50, 66, 67, 68], and utilizing non-Markovian formulations [45, 69, 70]. While these methods are training-free, the sample quality can be further improved when the neural network is directly tuned for short-run sampling. Distillation methods train a faster diffusion sampler using training signal from a longer-run diffusion model, showing strong performance [10, 71, 72, 48, 73, 43, 42, 74]. A distilled model usually cannot outperform the teacher model, but adversarial or IRL methods may exceed full-length diffusion models. Hybrid methods [13, 12] combine distillation with adversarial loss, while other methods [46, 75] apply adversarial training to each denoising step. DxMI and SFT-PG [11] rely fully on adversarial training for final samples, allowing beneficial deviations from the diffusion path and reducing statistical distance from the data. ", "page_idx": 9}, {"type": "text", "text": "RL for Diffusion Model. RL is often employed to fine-tune diffusion models for a reward function. The source of the reward signal can be a computer program [24, 76, 20, 77, 78], or a human evaluator [19, 79, 25]. DxMI focuses on a setting where the estimated log data density is the reward. When RL is applied to diffusion models, the policy gradient [80] is the dominant choice [24, 76, 11, 77]. DxMI offers a value function-based approach as an alternative to the policy gradient. Maximum entropy RL for diffusion models is investigated in [20, 81, 82] but only in the continuous-time setting. DxDP investigates the discrete-time setting, which is more suitable for accelerating generation speed. ", "page_idx": 9}, {"type": "text", "text": "Energy-Based Models. DxMI provides a method of utilizing a diffusion model to eliminate the need for MCMC. Many existing EBM training algorithms rely on MCMC, which is computationally expensive and difficult to optimize for hyperparameters [34, 83, 18, 84, 85, 35, 63, 59]. Joint training of an EBM with a separate generative model is a widely employed strategy to avoid MCMC. EBMs can be trained jointly with a normalizing flow [86, 87], a generator [30, 88, 89], or a diffusion model [90, 33]. DxMI shares the objective function with several prior works in EBM [27, 28, 29, 30, 31, 33]. However, none of the works use a diffusion model directly as a sampler. ", "page_idx": 9}, {"type": "text", "text": "Related Theoretical Analyses. The convergence guarantees of entropy-regularized IRL are provided in [91, 92] under the assumption of a linear reward and the infinite time horizon. Their guarantees are not directly applicable to a practical instance of DxMI, mainly due to the nonlinearity of the reward function, the continuous state and action spaces, and the finite-horizon setting. Establishing the convergence guarantee for DxMI could be an important future research direction. On the other hand, theoretical analyses have been conducted on MaxEnt RL under finite state and action spaces [93], which is relevant for the discrete version of DxDP. More focused analysis on entropy regularized RL for diffusion models is provided in [94]. ", "page_idx": 9}, {"type": "text", "text": "7 Conclusion ", "text_level": 1, "page_idx": 9}, {"type": "text", "text": "In this paper, we leverage techniques from sequential decision making to tackle challenges in generative modeling, revealing a significant connection between these two fields. We anticipate that this connection will spur a variety of algorithmic innovations and find numerous practical applications. ", "page_idx": 9}, {"type": "text", "text": "Broader Impacts. DxMI may facilitate deep fakes or fake news. However, trained on relatively low-resolution academic datasets, the models created during our experiments are not capable enough to cause realistic harm. Generative models trained solely using DxMI may possess fairness issues. ", "page_idx": 9}, {"type": "text", "text": "Limitations. Training multiple components simultaneously, DxMI introduces several hyperparameters. To reduce the overhead of practitioners, we provide a hyperparameter exploration guideline in Appendix B. DxMI is not directly applicable to training a single-step generator. However, a diffusion model fine-tuned by DxMI can be distilled to a single-step generator. DxMI does not offer the flexibility of using a different value of generation steps $T$ during the test time. Direct theoretical analysis of DxMI is challenging since the models are built on deep neural networks. Theoretical analysis that rationalizes the empirical results will be an important direction for future work. ", "page_idx": 9}, {"type": "text", "text": "Acknowledgments and Disclosure of Funding ", "text_level": 1, "page_idx": 10}, {"type": "text", "text": "S. Yoon is supported by a KIAS Individual Grant (AP095701) via the Center for AI and Natural Sciences at Korea Institute for Advanced Study and IITP/MSIT (RS-2023-00220628). H. Hwang and F. Park are supported in part by IITP-MSIT grant RS-2021-II212068 (SNU AI Innovation Hub), IITP-MSIT grant 2022-220480, RS-2022-II220480 (Training and Inference Methods for Goal Oriented AI Agents), MSIT(Ministry of Science, ICT), Korea, under the Global Research Support Program in the Digital Field program(RS-2024-00436680) supervised by the IITP(Institute for Information & Communications Technology Planning & Evaluation), KIAT grant P0020536 (HRD Program for Industrial Innovation), SRRC NRF grant RS-2023-00208052, SNU-AIIS, SNU-IPAI, SNU-IAMD, SNU $B{\\bf K}21+$ Program in Mechanical Engineering, SNU Institute for Engineering Research, Microsoft Research Asia, and SNU Interdisciplinary Program in Artificial Intelligence. D. Kwon is partially supported by the National Research Foundation of Korea (NRF) grant funded by the Korea government (MSIT) (No. RS-2023-00252516 and No. RS-2024-00408003) and the POSCO Science Fellowship of POSCO TJ Park Foundation. Y.-K. Noh was partly supported by NRF/MSIT (No.RS-2024-00421203)) and IITP/MSIT (2020-0-01373). ", "page_idx": 10}, {"type": "text", "text": "References ", "text_level": 1, "page_idx": 10}, {"type": "text", "text": "[1] Chelsea Finn, Paul Christiano, Pieter Abbeel, and Sergey Levine. A connection between generative adversarial networks, inverse reinforcement learning, and energy-based models. arXiv preprint arXiv:1611.03852, 2016.   \n[2] Jonathan Ho and Stefano Ermon. Generative adversarial imitation learning. Advances in neural information processing systems, 29, 2016.   \n[3] Jonathan Ho, Ajay Jain, and Pieter Abbeel. Denoising diffusion probabilistic models. In H. Larochelle, M. Ranzato, R. Hadsell, M.F. Balcan, and H. Lin, editors, Advances in Neural Information Processing Systems, volume 33, pages 6840\u20136851. Curran Associates, Inc., 2020.   \n[4] Jascha Sohl-Dickstein, Eric Weiss, Niru Maheswaranathan, and Surya Ganguli. Deep unsupervised learning using nonequilibrium thermodynamics. In Francis Bach and David Blei, editors, Proceedings of the 32nd International Conference on Machine Learning, volume 37 of Proceedings of Machine Learning Research, pages 2256\u20132265, Lille, France, 07\u201309 Jul 2015. PMLR.   \n[5] Dean A. Pomerleau. Alvinn: An autonomous land vehicle in a neural network. In D. Touretzky, editor, Advances in Neural Information Processing Systems, volume 1. Morgan-Kaufmann, 1988.   \n[6] Stephane Ross, Geoffrey Gordon, and Drew Bagnell. A reduction of imitation learning and structured prediction to no-regret online learning. In Geoffrey Gordon, David Dunson, and Miroslav Dud\u00edk, editors, Proceedings of the Fourteenth International Conference on Artificial Intelligence and Statistics, volume 15 of Proceedings of Machine Learning Research, pages 627\u2013635, Fort Lauderdale, FL, USA, 11\u201313 Apr 2011. PMLR.   \n[7] Siddharth Reddy, Anca D. Dragan, and Sergey Levine. {SQIL}: Imitation learning via reinforcement learning with sparse rewards. In International Conference on Learning Representations, 2020.   \n[8] Zhifeng Kong and Wei Ping. On fast sampling of diffusion probabilistic models. arXiv preprint arXiv:2106.00132, 2021.   \n[9] Robin San-Roman, Eliya Nachmani, and Lior Wolf. Noise estimation for generative diffusion models. arXiv preprint arXiv:2104.02600, 2021.   \n[10] Tim Salimans and Jonathan Ho. Progressive distillation for fast sampling of diffusion models. In International Conference on Learning Representations, 2022.   \n[11] Ying Fan and Kangwook Lee. Optimizing DDPM sampling with shortcut fine-tuning. In Andreas Krause, Emma Brunskill, Kyunghyun Cho, Barbara Engelhardt, Sivan Sabato, and Jonathan Scarlett, editors, Proceedings of the 40th International Conference on Machine Learning, volume 202 of Proceedings of Machine Learning Research, pages 9623\u20139639. PMLR, 23\u201329 Jul 2023.   \n[12] Yanwu Xu, Yang Zhao, Zhisheng Xiao, and Tingbo Hou. Ufogen: You forward once large scale text-toimage generation via diffusion gans. arXiv preprint arXiv:2311.09257, 2023.   \n[13] Axel Sauer, Dominik Lorenz, Andreas Blattmann, and Robin Rombach. Adversarial diffusion distillation. arXiv preprint arXiv:2311.17042, 2023.   \n[14] Andrew $\\mathrm{~Y~Ng~}$ and Stuart J Russell. Algorithms for inverse reinforcement learning. In Proceedings of the Seventeenth International Conference on Machine Learning, pages 663\u2013670, 2000.   \n[15] Brian D Ziebart, Andrew L Maas, J Andrew Bagnell, Anind K Dey, et al. Maximum entropy inverse reinforcement learning. In AAAI, volume 8, pages 1433\u20131438. Chicago, IL, USA, 2008.   \n[16] Chelsea Finn, Sergey Levine, and Pieter Abbeel. Guided cost learning: Deep inverse optimal control via policy optimization. In Maria Florina Balcan and Kilian Q. Weinberger, editors, Proceedings of The 33rd International Conference on Machine Learning, volume 48 of Proceedings of Machine Learning Research, pages 49\u201358, New York, New York, USA, 20\u201322 Jun 2016. PMLR.   \n[17] Tuomas Haarnoja, Aurick Zhou, Pieter Abbeel, and Sergey Levine. Soft actor-critic: Off-policy maximum entropy deep reinforcement learning with a stochastic actor. In Jennifer Dy and Andreas Krause, editors, Proceedings of the 35th International Conference on Machine Learning, volume 80 of Proceedings of Machine Learning Research, pages 1861\u20131870. PMLR, 10\u201315 Jul 2018.   \n[18] Yilun Du, Shuang Li, B. Joshua Tenenbaum, and Igor Mordatch. Improved contrastive divergence training of energy based models. In Proceedings of the 38th International Conference on Machine Learning (ICML-21), 2021.   \n[19] Kevin Clark, Paul Vicol, Kevin Swersky, and David J Fleet. Directly fine-tuning diffusion models on differentiable rewards. arXiv preprint arXiv:2309.17400, 2023.   \n[20] Masatoshi Uehara, Yulai Zhao, Kevin Black, Ehsan Hajiramezanali, Gabriele Scalia, Nathaniel Lee Diamant, Alex M Tseng, Tommaso Biancalani, and Sergey Levine. Fine-tuning of continuous-time diffusion models as entropy-regularized control. arXiv preprint arXiv:2402.15194, 2024.   \n[21] Julius Berner, Lorenz Richter, and Karen Ullrich. An optimal control perspective on diffusion-based generative modeling. arXiv preprint arXiv:2211.01364, 2022.   \n[22] Qinsheng Zhang and Yongxin Chen. Path integral sampler: A stochastic control approach for sampling. In International Conference on Learning Representations, 2022.   \n[23] Yang Song, Jascha Sohl-Dickstein, Diederik P Kingma, Abhishek Kumar, Stefano Ermon, and Ben Poole. Score-based generative modeling through stochastic differential equations. In International Conference on Learning Representations, 2021.   \n[24] Ying Fan, Olivia Watkins, Yuqing Du, Hao Liu, Moonkyung Ryu, Craig Boutilier, Pieter Abbeel, Mohammad Ghavamzadeh, Kangwook Lee, and Kimin Lee. Reinforcement learning for fine-tuning text-to-image diffusion models. In Thirty-seventh Conference on Neural Information Processing Systems, 2023.   \n[25] Bram Wallace, Meihua Dang, Rafael Rafailov, Linqi Zhou, Aaron Lou, Senthil Purushwalkam, Stefano Ermon, Caiming Xiong, Shafiq Joty, and Nikhil Naik. Diffusion model alignment using direct preference optimization. In Proceedings of the IEEE/CVF Conference on Computer Vision and Pattern Recognition (CVPR), pages 8228\u20138238, June 2024.   \n[26] Geoffrey E Hinton. Training products of experts by minimizing contrastive divergence. Neural computation, 14(8):1771\u20131800, 2002.   \n[27] M. Ehsan Abbasnejad, Qinfeng Shi, Anton van den Hengel, and Lingqiao Liu. A generative adversarial density estimator. In Proceedings of the IEEE/CVF Conference on Computer Vision and Pattern Recognition (CVPR), June 2019.   \n[28] Bo Dai, Zhen Liu, Hanjun Dai, Niao He, Arthur Gretton, Le Song, and Dale Schuurmans. Exponential family estimation via adversarial dynamics embedding. In H. Wallach, H. Larochelle, A. Beygelzimer, F. d'Alch\u00e9-Buc, E. Fox, and R. Garnett, editors, Advances in Neural Information Processing Systems, volume 32. Curran Associates, Inc., 2019.   \n[29] Zihang Dai, Amjad Almahairi, Philip Bachman, Eduard Hovy, and Aaron Courville. Calibrating energybased generative adversarial networks. In International Conference on Learning Representations, 2017.   \n[30] Will Sussman Grathwohl, Jacob Jin Kelly, Milad Hashemi, Mohammad Norouzi, Kevin Swersky, and David Duvenaud. No {mcmc} for me: Amortized sampling for fast and stable training of energy-based models. In International Conference on Learning Representations, 2021.   \n[31] Rithesh Kumar, Sherjil Ozair, Anirudh Goyal, Aaron Courville, and Yoshua Bengio. Maximum entropy generators for energy-based models. arXiv preprint arXiv:1901.08508, 2019.   \n[32] Cong Geng, Jia Wang, Zhiyong Gao, Jes Frellsen, and S\u00f8 ren Hauberg. Bounds all around: training energy-based models with bidirectional bounds. In M. Ranzato, A. Beygelzimer, Y. Dauphin, P.S. Liang, and J. Wortman Vaughan, editors, Advances in Neural Information Processing Systems, volume 34, pages 19808\u201319821. Curran Associates, Inc., 2021.   \n[33] Cong Geng, Tian Han, Peng-Tao Jiang, Hao Zhang, Jinwei Chen, S\u00f8ren Hauberg, and Bo Li. Improving adversarial energy-based model via diffusion process. arXiv preprint arXiv:2403.01666, 2024.   \n[34] Yilun Du and Igor Mordatch. Implicit generation and modeling with energy based models. In H. Wallach, H. Larochelle, A. Beygelzimer, F. d Alche-Buc, E. Fox, and R. Garnett, editors, Advances in Neural Information Processing Systems 32, pages 3608\u20133618. Curran Associates, Inc., 2019.   \n[35] Hankook Lee, Jongheon Jeong, Sejun Park, and Jinwoo Shin. Guiding energy-based models via contrastive latent variables. In International Conference on Learning Representations, 2023.   \n[36] Ricky T. Q. Chen, Yulia Rubanova, Jesse Bettencourt, and David K Duvenaud. Neural ordinary differential equations. In S. Bengio, H. Wallach, H. Larochelle, K. Grauman, N. Cesa-Bianchi, and R. Garnett, editors, Advances in Neural Information Processing Systems, volume 31. Curran Associates, Inc., 2018.   \n[37] Lyudmyla F Kozachenko and Nikolai N Leonenko. Sample estimate of the entropy of a random vector. Problemy Peredachi Informatsii, 23(2):9\u201316, 1987.   \n[38] Mohamed Ishmael Belghazi, Aristide Baratin, Sai Rajeshwar, Sherjil Ozair, Yoshua Bengio, Aaron Courville, and Devon Hjelm. Mutual information neural estimation. In Jennifer Dy and Andreas Krause, editors, Proceedings of the 35th International Conference on Machine Learning, volume 80 of Proceedings of Machine Learning Research, pages 531\u2013540. PMLR, 10\u201315 Jul 2018.   \n[39] XuanLong Nguyen, Martin J Wainwright, and Michael I Jordan. Estimating divergence functionals and the likelihood ratio by convex risk minimization. IEEE Transactions on Information Theory, 56(11):5847\u20135861, 2010.   \n[40] Ian Goodfellow, Jean Pouget-Abadie, Mehdi Mirza, Bing Xu, David Warde-Farley, Sherjil Ozair, Aaron Courville, and Yoshua Bengio. Generative adversarial nets. In Z. Ghahramani, M. Welling, C. Cortes, N. Lawrence, and K.Q. Weinberger, editors, Advances in Neural Information Processing Systems, volume 27. Curran Associates, Inc., 2014.   \n[41] Michael Gutmann and Aapo Hyv\u00e4rinen. Noise-contrastive estimation: A new estimation principle for unnormalized statistical models. In Yee Whye Teh and Mike Titterington, editors, Proceedings of the Thirteenth International Conference on Artificial Intelligence and Statistics, volume 9 of Proceedings of Machine Learning Research, pages 297\u2013304, Chia Laguna Resort, Sardinia, Italy, 13\u201315 May 2010. PMLR.   \n[42] Yang Song, Prafulla Dhariwal, Mark Chen, and Ilya Sutskever. Consistency models. In Andreas Krause, Emma Brunskill, Kyunghyun Cho, Barbara Engelhardt, Sivan Sabato, and Jonathan Scarlett, editors, Proceedings of the 40th International Conference on Machine Learning, volume 202 of Proceedings of Machine Learning Research, pages 32211\u201332252. PMLR, 23\u201329 Jul 2023.   \n[43] Xingchao Liu, Chengyue Gong, and qiang liu. Flow straight and fast: Learning to generate and transfer data with rectified flow. In The Eleventh International Conference on Learning Representations, 2023.   \n[44] Axel Sauer, Katja Schwarz, and Andreas Geiger. Stylegan-xl: Scaling stylegan to large diverse datasets. In ACM SIGGRAPH 2022 conference proceedings, pages 1\u201310, 2022.   \n[45] Jiaming Song, Chenlin Meng, and Stefano Ermon. Denoising diffusion implicit models. In International Conference on Learning Representations, 2021.   \n[46] Zhisheng Xiao, Karsten Kreis, and Arash Vahdat. Tackling the generative learning trilemma with denoising diffusion GANs. In International Conference on Learning Representations, 2022.   \n[47] Prafulla Dhariwal and Alexander Nichol. Diffusion models beat gans on image synthesis. In M. Ranzato, A. Beygelzimer, Y. Dauphin, P.S. Liang, and J. Wortman Vaughan, editors, Advances in Neural Information Processing Systems, volume 34, pages 8780\u20138794. Curran Associates, Inc., 2021.   \n[48] Hongkai Zheng, Weili Nie, Arash Vahdat, Kamyar Azizzadenesheli, and Anima Anandkumar. Fast sampling of diffusion models via operator learning. In Andreas Krause, Emma Brunskill, Kyunghyun Cho, Barbara Engelhardt, Sivan Sabato, and Jonathan Scarlett, editors, Proceedings of the 40th International Conference on Machine Learning, volume 202 of Proceedings of Machine Learning Research, pages 42390\u201342402. PMLR, 23\u201329 Jul 2023.   \n[49] Andrew Brock, Jeff Donahue, and Karen Simonyan. Large scale GAN training for high fidelity natural image synthesis. In International Conference on Learning Representations, 2019.   \n[50] Tero Karras, Miika Aittala, Timo Aila, and Samuli Laine. Elucidating the design space of diffusion-based generative models. In S. Koyejo, S. Mohamed, A. Agarwal, D. Belgrave, K. Cho, and A. Oh, editors, Advances in Neural Information Processing Systems, volume 35, pages 26565\u201326577. Curran Associates, Inc., 2022.   \n[51] Tero Karras, Samuli Laine, Miika Aittala, Janne Hellsten, Jaakko Lehtinen, and Timo Aila. Analyzing and improving the image quality of stylegan. In Proceedings of the IEEE/CVF Conference on Computer Vision and Pattern Recognition (CVPR), June 2020.   \n[52] A Krizhevsky. Learning multiple layers of features from tiny images. Master\u2019s thesis, University of Tronto, 2009.   \n[53] Jia Deng, Wei Dong, Richard Socher, Li-Jia Li, Kai Li, and Li Fei-Fei. Imagenet: A large-scale hierarchical image database. In 2009 IEEE conference on computer vision and pattern recognition, pages 248\u2013255. Ieee, 2009.   \n[54] Fisher Yu, Ari Seff, Yinda Zhang, Shuran Song, Thomas Funkhouser, and Jianxiong Xiao. Lsun: Construction of a large-scale image dataset using deep learning with humans in the loop. arXiv preprint arXiv:1506.03365, 2015.   \n[55] Martin Heusel, Hubert Ramsauer, Thomas Unterthiner, Bernhard Nessler, and Sepp Hochreiter. Gans trained by a two time-scale update rule converge to a local nash equilibrium. In I. Guyon, U. Von Luxburg, S. Bengio, H. Wallach, R. Fergus, S. Vishwanathan, and R. Garnett, editors, Advances in Neural Information Processing Systems, volume 30. Curran Associates, Inc., 2017.   \n[56] Tuomas Kynk\u00e4\u00e4nniemi, Tero Karras, Samuli Laine, Jaakko Lehtinen, and Timo Aila. Improved precision and recall metric for assessing generative models. In H. Wallach, H. Larochelle, A. Beygelzimer, F. d'Alch\u00e9- Buc, E. Fox, and R. Garnett, editors, Advances in Neural Information Processing Systems, volume 32. Curran Associates, Inc., 2019.   \n[57] Dongjun Kim, Yeongmin Kim, Se Jung Kwon, Wanmo Kang, and Il-Chul Moon. Refining generative process with discriminator guidance in score-based diffusion models. In Andreas Krause, Emma Brunskill, Kyunghyun Cho, Barbara Engelhardt, Sivan Sabato, and Jonathan Scarlett, editors, Proceedings of the 40th International Conference on Machine Learning, volume 202 of Proceedings of Machine Learning Research, pages 16567\u201316598. PMLR, 23\u201329 Jul 2023.   \n[58] Vitjan Zavrtanik, Matej Kristan, and Danijel Sko\u02c7caj. Draem - a discriminatively trained reconstruction embedding for surface anomaly detection. In Proceedings of the IEEE/CVF International Conference on Computer Vision (ICCV), pages 8330\u20138339, October 2021.   \n[59] Sangwoong Yoon, Young-Uk Jin, Yung-Kyun Noh, and Frank C. Park. Energy-based models for anomaly detection: A manifold diffusion recovery approach. In Thirty-seventh Conference on Neural Information Processing Systems, 2023.   \n[60] Zhiyuan You, Lei Cui, Yujun Shen, Kai Yang, Xin Lu, Yu Zheng, and Xinyi Le. A unified model for multiclass anomaly detection. In S. Koyejo, S. Mohamed, A. Agarwal, D. Belgrave, K. Cho, and A. Oh, editors, Advances in Neural Information Processing Systems, volume 35, pages 4571\u20134584. Curran Associates, Inc., 2022.   \n[61] Paul Bergmann, Kilian Batzner, Michael Fauser, David Sattlegger, and Carsten Steger. The mvtec anomaly detection dataset: a comprehensive real-world dataset for unsupervised anomaly detection. International Journal of Computer Vision, 129(4):1038\u20131059, 2021.   \n[62] Mingxing Tan and Quoc Le. Efficientnet: Rethinking model scaling for convolutional neural networks. In International conference on machine learning, pages 6105\u20136114. PMLR, 2019.   \n[63] Sangwoong Yoon, Yung-Kyun Noh, and Frank Park. Autoencoding under normalization constraints. In Marina Meila and Tong Zhang, editors, Proceedings of the 38th International Conference on Machine Learning, volume 139 of Proceedings of Machine Learning Research, pages 12087\u201312097. PMLR, 18\u201324 Jul 2021.   \n[64] Fan Bao, Chongxuan Li, Jun Zhu, and Bo Zhang. Analytic-DPM: an analytic estimate of the optimal reverse variance in diffusion probabilistic models. In International Conference on Learning Representations, 2022.   \n[65] Alexander Quinn Nichol and Prafulla Dhariwal. Improved denoising diffusion probabilistic models. In Marina Meila and Tong Zhang, editors, Proceedings of the 38th International Conference on Machine Learning, volume 139 of Proceedings of Machine Learning Research, pages 8162\u20138171. PMLR, 18\u201324 Jul 2021.   \n[66] Alexia Jolicoeur-Martineau, Ke Li, R\u00e9mi Pich\u00e9-Taillefer, Tal Kachman, and Ioannis Mitliagkas. Gotta go fast when generating data with score-based models. arXiv preprint arXiv:2105.14080, 2021.   \n[67] Cheng Lu, Yuhao Zhou, Fan Bao, Jianfei Chen, Chongxuan LI, and Jun Zhu. Dpm-solver: A fast ode solver for diffusion probabilistic model sampling in around 10 steps. In S. Koyejo, S. Mohamed, A. Agarwal, D. Belgrave, K. Cho, and A. Oh, editors, Advances in Neural Information Processing Systems, volume 35, pages 5775\u20135787. Curran Associates, Inc., 2022.   \n[68] Qinsheng Zhang and Yongxin Chen. Fast sampling of diffusion models with exponential integrator. In The Eleventh International Conference on Learning Representations, 2023.   \n[69] Qinsheng Zhang, Molei Tao, and Yongxin Chen. gDDIM: Generalized denoising diffusion implicit models. In The Eleventh International Conference on Learning Representations, 2023.   \n[70] Daniel Watson, William Chan, Jonathan Ho, and Mohammad Norouzi. Learning fast samplers for diffusion models by differentiating through sample quality. In International Conference on Learning Representations, 2022.   \n[71] David Berthelot, Arnaud Autef, Jierui Lin, Dian Ang Yap, Shuangfei Zhai, Siyuan Hu, Daniel Zheng, Walter Talbott, and Eric Gu. Tract: Denoising diffusion models with transitive closure time-distillation. arXiv preprint arXiv:2303.04248, 2023.   \n[72] Eric Luhman and Troy Luhman. Knowledge distillation in iterative generative models for improved sampling speed, 2021.   \n[73] Wujie Sun, Defang Chen, Can Wang, Deshi Ye, Yan Feng, and Chun Chen. Accelerating diffusion sampling with classifier-based feature distillation. In 2023 IEEE International Conference on Multimedia and Expo (ICME), pages 810\u2013815, 2023.   \n[74] Michael Samuel Albergo and Eric Vanden-Eijnden. Building normalizing flows with stochastic interpolants. In The Eleventh International Conference on Learning Representations, 2023.   \n[75] yanwu xu, Mingming Gong, Shaoan Xie, Wei Wei, Matthias Grundmann, Kayhan Batmanghelich, and Tingbo Hou. Semi-implicit denoising diffusion models (siddms). In A. Oh, T. Naumann, A. Globerson, K. Saenko, M. Hardt, and S. Levine, editors, Advances in Neural Information Processing Systems, volume 36, pages 17383\u201317394. Curran Associates, Inc., 2023.   \n[76] Kevin Black, Michael Janner, Yilun Du, Ilya Kostrikov, and Sergey Levine. Training diffusion models with reinforcement learning. arXiv preprint arXiv:2305.13301, 2023.   \n[77] Seung Hyun Lee, Yinxiao Li, Junjie Ke, Innfarn Yoo, Han Zhang, Jiahui Yu, Qifei Wang, Fei Deng, Glenn Entis, Junfeng He, et al. Parrot: Pareto-optimal multi-reward reinforcement learning framework for text-to-image generation. arXiv preprint arXiv:2401.05675, 2024.   \n[78] Jianshu Guo, Wenhao Chai, Jie Deng, Hsiang-Wei Huang, Tian Ye, Yichen Xu, Jiawei Zhang, Jenq-Neng Hwang, and Gaoang Wang. Versat2i: Improving text-to-image models with versatile reward. arXiv preprint arXiv:2403.18493, 2024.   \n[79] Shu Zhang, Xinyi Yang, Yihao Feng, Can Qin, Chia-Chih Chen, Ning Yu, Zeyuan Chen, Huan Wang, Silvio Savarese, Stefano Ermon, Caiming Xiong, and Ran Xu. Hive: Harnessing human feedback for instructional visual editing. arXiv preprint arXiv:2303.09618, 2023.   \n[80] Ronald J Williams. Simple statistical gradient-following algorithms for connectionist reinforcement learning. Reinforcement learning, pages 5\u201332, 1992.   \n[81] Masatoshi Uehara, Yulai Zhao, Kevin Black, Ehsan Hajiramezanali, Gabriele Scalia, Nathaniel Lee Diamant, Alex M Tseng, Sergey Levine, and Tommaso Biancalani. Feedback efficient online fine-tuning of diffusion models. arXiv preprint arXiv:2402.16359, 2024.   \n[82] Masatoshi Uehara, Yulai Zhao, Ehsan Hajiramezanali, Gabriele Scalia, G\u00f6kcen Eraslan, Avantika Lal, Sergey Levine, and Tommaso Biancalani. Bridging model-based optimization and generative modeling via conservative fine-tuning of diffusion models. arXiv preprint arXiv:2405.19673, 2024.   \n[83] Erik Nijkamp, Mitch Hill, Song-Chun Zhu, and Ying Nian Wu. Learning non-convergent non-persistent short-run mcmc toward energy-based model. In H. Wallach, H. Larochelle, A. Beygelzimer, F. d'Alch\u00e9-Buc, E. Fox, and R. Garnett, editors, Advances in Neural Information Processing Systems, volume 32, pages 5232\u20135242. Curran Associates, Inc., 2019.   \n[84] Zhisheng Xiao, Karsten Kreis, Jan Kautz, and Arash Vahdat. {VAEBM}: A symbiosis between variational autoencoders and energy-based models. In International Conference on Learning Representations, 2021.   \n[85] Ruiqi Gao, Yang Song, Ben Poole, Ying Nian Wu, and Diederik P Kingma. Learning energy-based models by diffusion recovery likelihood. In International Conference on Learning Representations, 2021.   \n[86] Jianwen Xie, Yaxuan Zhu, Jun Li, and Ping Li. A tale of two flows: Cooperative learning of langevin flow and normalizing flow toward energy-based model. In International Conference on Learning Representations, 2022.   \n[87] Ruiqi Gao, Erik Nijkamp, Diederik P Kingma, Zhen Xu, Andrew M Dai, and Ying Nian Wu. Flow contrastive estimation of energy-based models. In Proceedings of the IEEE/CVF Conference on Computer Vision and Pattern Recognition, pages 7518\u20137528, 2020.   \n[88] Will Grathwohl, Kuan-Chieh Wang, Joern-Henrik Jacobsen, David Duvenaud, and Richard Zemel. Learning the stein discrepancy for training and evaluating energy-based models without sampling. In Hal Daum\u00e9 III and Aarti Singh, editors, Proceedings of the 37th International Conference on Machine Learning, volume 119 of Proceedings of Machine Learning Research, pages 3732\u20133747. PMLR, 13\u201318 Jul 2020.   \n[89] Tian Han, Erik Nijkamp, Xiaolin Fang, Mitch Hill, Song-Chun Zhu, and Ying Nian Wu. Divergence triangle for joint training of generator model, energy-based model, and inferential model. In Proceedings of the IEEE/CVF Conference on Computer Vision and Pattern Recognition (CVPR), June 2019.   \n[90] Peiyu Yu, Yaxuan Zhu, Sirui Xie, Xiaojian (Shawn) Ma, Ruiqi Gao, Song-Chun Zhu, and Ying Nian Wu. Learning energy-based prior model with diffusion-amortized mcmc. In A. Oh, T. Naumann, A. Globerson, K. Saenko, M. Hardt, and S. Levine, editors, Advances in Neural Information Processing Systems, volume 36, pages 42717\u201342747. Curran Associates, Inc., 2023.   \n[91] Siliang Zeng, Chenliang Li, Alfredo Garcia, and Mingyi Hong. Maximum-likelihood inverse reinforcement learning with finite-time guarantees. Advances in Neural Information Processing Systems, 35:10122\u201310135, 2022.   \n[92] Titouan Renard, Andreas Schlaginhaufen, Tingting Ni, and Maryam Kamgarpour. Convergence of a modelfree entropy-regularized inverse reinforcement learning algorithm. arXiv preprint arXiv:2403.16829, 2024.   \n[93] Matthieu Geist, Bruno Scherrer, and Olivier Pietquin. A theory of regularized Markov decision processes. In Kamalika Chaudhuri and Ruslan Salakhutdinov, editors, Proceedings of the 36th International Conference on Machine Learning, volume 97 of Proceedings of Machine Learning Research, pages 2160\u20132169. PMLR, 09\u201315 Jun 2019.   \n[94] Wenpin Tang. Fine-tuning of diffusion models via stochastic control: entropy regularization and beyond. arXiv preprint arXiv:2403.06279, 2024. ", "page_idx": 10}, {"type": "text", "text": "", "page_idx": 11}, {"type": "text", "text": "", "page_idx": 12}, {"type": "text", "text": "", "page_idx": 13}, {"type": "text", "text": "", "page_idx": 14}, {"type": "text", "text": "", "page_idx": 15}, {"type": "text", "text": "A Adaptive Velocity Regularization ", "text_level": 1, "page_idx": 16}, {"type": "text", "text": "We are interested in the following optimization problem: ", "page_idx": 16}, {"type": "equation", "text": "$$\n\\operatorname*{min}_{s_{0},\\ldots,s_{T-1}}K L(\\pi_{\\phi}(\\mathbf{x}_{0:T})||q_{\\theta}(\\mathbf{x}_{T})\\tilde{q}(\\mathbf{x}_{0:T-1}|\\mathbf{x}_{T})).\n$$", "text_format": "latex", "page_idx": 16}, {"type": "text", "text": "Plugging in our choice of $\\begin{array}{r}{\\log\\tilde{q}(\\mathbf{x}_{t}|\\mathbf{x}_{t+1})=-\\frac{||\\mathbf{x}_{t}-\\mathbf{x}_{t+1}||^{2}}{2s_{t}^{2}}-D\\log s_{t}.}\\end{array}$ , we can rewrite the optimization problem as follows. ", "page_idx": 16}, {"type": "equation", "text": "$$\n\\operatorname*{min}_{s_{0},\\ldots,s_{T-1}}\\sum_{t=0}^{T-1}\\mathbb{E}_{\\mathbf{x}_{t},\\mathbf{x}_{t+1}\\sim\\pi}\\left[\\frac{||\\mathbf{x}_{t}-\\mathbf{x}_{t+1}||^{2}}{2s_{t}^{2}}+\\frac{D}{2}\\log s_{t}^{2}\\right],\n$$", "text_format": "latex", "page_idx": 16}, {"type": "text", "text": "where constant term with respect to $s_{t}$ is omitted. Since the object function is separable, we can solve the optimization for each $s_{t}$ independently. ", "page_idx": 16}, {"type": "equation", "text": "$$\n\\operatorname*{min}_{s_{t}}\\frac{\\mathbb{E}_{\\mathbf{x}_{t},\\mathbf{x}_{t+1}\\sim\\pi}\\left[||\\mathbf{x}_{t}-\\mathbf{x}_{t+1}||^{2}\\right]}{2s_{t}^{2}}+D\\log s_{t},\\quad t=0,...,T-1.\n$$", "text_format": "latex", "page_idx": 16}, {"type": "text", "text": "This optimization has an analytic solution: $\\begin{array}{r}{\\left(s_{t}^{*}\\right)^{2}=\\mathbb{E}_{\\mathbf{x}_{t},\\mathbf{x}_{t+1}\\sim\\pi}\\left[\\vert\\vert\\mathbf{x}_{t}-\\mathbf{x}_{t+1}\\vert\\vert^{2}\\right]/D.}\\end{array}$ ", "page_idx": 16}, {"type": "text", "text": "B Guideline for Hyperparameters ", "text_level": 1, "page_idx": 16}, {"type": "text", "text": "Value function. The most crucial design decision in DxMI is how to construct the value function. This design revolves around two primary axes. The first axis is whether the value function should be time-dependent or time-independent. The second axis is whether the value function should share model parameters with other networks, such as the sampler or the energy network. ", "page_idx": 16}, {"type": "text", "text": "Our experiments demonstrate various combinations of these design choices. In a 2D experiment, the time-dependent value function shares parameters with the EBM, which is a recommended approach for smaller problems. In an image experiment, we employ a time-independent value function that shares parameters with the energy network, effectively making the value function and the energy function identical. This design choice promotes monotonicity and efficient sample usage, as a single value function learns from all intermediate samples. ", "page_idx": 16}, {"type": "text", "text": "In an anomaly detection experiment, we use a time-dependent value function that does not share parameters with any other network. This design is suitable when a specific structure needs to be enforced on the energy function, such as with an autoencoder, and when making the structure time-dependent is not straightforward. ", "page_idx": 16}, {"type": "text", "text": "While these are the options we have explored, there are likely other viable possibilities for designing the value function. ", "page_idx": 16}, {"type": "text", "text": "Coefficient $\\tau$ . Although the coefficient $\\tau$ plays an important role in DxMI, we recommend running DxMI with $\\tau=0$ when implementing the algorithm for the first time. If everything is in order, DxMI should function to some extent. During normal training progression, the energy values of positive and negative samples should converge as iterations proceed. ", "page_idx": 16}, {"type": "text", "text": "After confirming that the training is progressing smoothly, you can start experimenting with increasing the value of $\\tau$ . Since $\\gamma$ determines the absolute scale of the energy, the magnitude of $\\tau$ should be adjusted accordingly. We set $\\gamma=1$ in all our experiments and recommend this value. In such a case, the optimal $\\tau$ is likely to be less than 0.5. ", "page_idx": 16}, {"type": "text", "text": "Learning rate. As done in two time-scale optimization [55], we use a larger learning rate for the value function than for the sampler. When training the noise parameters $\\sigma_{t}$ in the diffusion model, we also assign a learning rate 100 times larger than that of the sampler. ", "page_idx": 16}, {"type": "text", "text": "C Details on Implementations and Additional Results ", "text_level": 1, "page_idx": 16}, {"type": "text", "text": "C.1 2D Experiment ", "text_level": 1, "page_idx": 16}, {"type": "text", "text": "Sample quality is quantified using sliced Wasserstein-2 distance $(S W)$ with 1,000 projections of 10k samples. The standard deviation is computed from 5 independent samplings. Density estimation ", "page_idx": 16}, {"type": "text", "text": "Algorithm 2 Diffusion by Maximum Entropy IRL for Image Generation ", "page_idx": 17}, {"type": "text", "text": "1: Input: Dataset $\\mathcal{D}$ , Energy $E_{\\theta}(\\mathbf{x})$ , Value $V_{\\psi}(\\mathbf{x}_{t})$ , and Sampler $\\pi_{\\phi}(\\mathbf{x}_{0:T})$   \n2: $s_{t}\\gets\\sigma_{t}$ // AVR initialization   \n3: for $\\mathbf{x}$ in $\\mathcal{D}$ do // Minibatch dimension is omitted for brevity.   \n4: Sample $\\mathbf{x}_{0:T}\\sim\\pi_{\\phi}(\\mathbf{x})$ .   \n5: $\\begin{array}{r}{\\operatorname*{min}_{\\theta}E_{\\theta}(\\mathbf{x})-E_{\\theta}(\\mathbf{x}_{T})+\\gamma(E_{\\theta}(\\mathbf{x})^{2}+E_{\\theta}(\\mathbf{x}_{T})^{2})}\\end{array}$ // Energy update   \n6: for $t=T-1,\\ldots,0$ do // Value update   \n7: $\\begin{array}{r}{\\operatorname*{min}_{\\psi}[\\mathbf{sg}[V_{\\psi}(\\mathbf{x}_{t+1})]+R(t)-V_{\\psi}(\\mathbf{x}_{t})]^{2}}\\end{array}$   \n8: end for   \n9: for $\\mathbf{x}_{t}$ randomly chosen among $\\mathbf{x}_{0:T}$ do // Sampler update   \n10: Sample one-step: $\\mathbf{x}_{t+1}\\sim\\pi_{\\phi}\\big(\\mathbf{x}_{t+1}\\big|\\mathbf{x}_{t}\\big)$ // Reparametrization trick   \n11: $\\begin{array}{r}{\\operatorname*{min}_{\\phi}V_{\\psi}^{t+1}(\\mathbf{x}_{t+1}(\\phi))-\\tau_{1}D\\log\\sigma_{t}+\\frac{\\tau_{2}}{2s_{t}^{2}}||\\mathbf{x}_{t}-\\mathbf{x}_{t+1}(\\phi)||^{2}}\\end{array}$ // $\\mathbf{x}_{t+1}$ is a function of $\\phi$ .   \n12: end for   \n13: $s_{t}^{2}\\gets\\alpha s_{t}^{2}+(1-\\alpha)||\\mathbf x_{t}-\\mathbf x_{t+1}||^{2}/D$ // AVR update   \n14: end for ", "page_idx": 17}, {"type": "text", "text": "performance is measured by AUC on discriminating test data and uniform samples over the domain.   \nAUC is also computed with $10\\mathbf{k}$ samples. ", "page_idx": 17}, {"type": "image", "img_path": "V0oJaLqY4E/tmp/fba6bed7bdc45b7475d0d5a83d555068ea7e81a0b8b336246aa9e8997533c6ca.jpg", "img_caption": ["Figure 3: Value functions at each time step $\\tau=0.1$ case). Blue indicates a low value. "], "img_footnote": [], "page_idx": 17}, {"type": "text", "text": "C.2 Image Generation ", "text_level": 1, "page_idx": 17}, {"type": "text", "text": "Datasets. CIFAR-10 is retrieved through torchvision API. ImageNet is downloaded from Kaggle and downsampled to $64\\times64$ following https://github.com/openai/guided-diffusion. We apply random horizontal filps on all images. When computing FID, the whole 50,000 training images of CIFAR-10 are used. We make sure that no JPEG compression is used during processing. For ImageNet, we use the batch stat flie provided by https://github.com/openai/guided-diffusion. ", "page_idx": 17}, {"type": "text", "text": "Models. For DDPM on CIFAR-10, we use the checkpoint provided by the SFT-PG repository [11]. For DDGAN, we utilize the official checkpoint. For EDM on ImageNet 64, we use the checkpoint from the consistency model repository [42]. In all experiments, we employ the same ResNet architecture, which does not include any normalization layers, such as batch normalization. ", "page_idx": 17}, {"type": "text", "text": "Training. For all runs, we use a batch size of 128. In the CIFAR-10 experiments, we use the Adam optimizer with a learning rate of $10^{-7}$ for the sampler weights, $10^{-5}$ for the value weights, and $10^{-5}$ for the $\\sigma_{t}$ \u2019s. In the ImageNet 64 experiments, we use RAdam with a learning rate of $10^{-8}$ for the sampler. Additionally, we utilize a mixed precision trainer to handle FP16 weights. The value weights are updated with a learning rate of $10^{-5}$ using Adam. The $\\sigma_{t}$ \u2019s are updated with a learning rate of $10^{-6}$ . To select the best model, we periodically generate 10,000 images for CIFAR-10 and 5,000 images for ImageNet. The checkpoint with the best FID score is selected as the final model. ", "page_idx": 17}, {"type": "text", "text": "Evaluation For computing FID, Precision, and Recall scores, we used the TensorFlow-based evaluation script provided by Consistency Models [42] repository, which is based on the codebase of [47]. All the images are saved in a PNG format when fed to the evaluation script. ", "page_idx": 17}, {"type": "text", "text": "Additional Details. For optimal performance in image generation, we often tune the coefficients of two running costs separately. Let us denote the coefficient of l $\\operatorname{og}\\pi(\\mathbf{x}_{t+1}\\vert\\mathbf{x}_{t})$ as $\\tau_{1}$ and the coefficient of $\\begin{array}{r}{\\frac{1}{2s_{t}^{2}}\\,\\big||\\mathbf{x}_{t}-\\mathbf{x}_{t+1}||^{2}}\\end{array}$ as $\\tau_{2}$ . In the CIFAR-10 experiments with $T=10$ and $T=4$ , we set $\\tau_{1}=0.1$ and $\\tau_{2}=0.01$ . In the ImageNet experiments with $T=10$ , we set $\\tau_{1}=\\tau_{2}=0.01$ , and for $T=4$ , we set $\\tau_{1}=0.1$ and $\\tau_{2}=0.01$ . ", "page_idx": 17}, {"type": "text", "text": "", "page_idx": 18}, {"type": "text", "text": "We believe the optimal $\\tau$ values vary for each setting due to differences in noise schedules and magnitudes. For example, the DDPM backbone is a variance-preserving formulation, while EDM is a variance-exploding formulation. Exploring a unified method for selecting the entropy regularization parameter is an interesting research direction. ", "page_idx": 18}, {"type": "text", "text": "C.3 Anomaly Detection ", "text_level": 1, "page_idx": 18}, {"type": "text", "text": "Dataset and Feature Extraction. MVTec AD is a dataset designed to evaluate anomaly detection techniques, particularly for industrial inspection. It contains over 5000 high-resolution images divided into 15 different categories of objects and textures. Each category includes a set of defect-free training images and a test set with both defective and non-defective images. ", "page_idx": 18}, {"type": "text", "text": "The original dataset consists of high-resolution RGB images sized $224\\!\\times\\!224$ . Following the methods used in similar studies [59, 60], we extract a $272\\!\\times\\!14\\!\\times\\!14$ full feature representation of each image using a pre-trained EfficientNet-b4 [62]. We then train the energy function using DxMI in 272- dimensional space, treating every spatial feature from the training images as normal training data. Each data point $\\mathbf{x}$ in $\\mathbb{R}^{272}$ is projected to $\\mathbb{S}^{272}$ through normalization. This projection is effective because the direction of the feature often represents the original image better than its magnitude. ", "page_idx": 18}, {"type": "text", "text": "Anomaly Detection and Localization. For anomaly detection, the energy of a single image is calculated by applying max pooling to the energy value of each spatial feature. For anomaly localization, the energy values of the $14\\!\\times\\!14$ spatial features are upsampled to match the original $224\\!\\times\\!224$ image resolution using bilinear interpolation. ", "page_idx": 18}, {"type": "text", "text": "Model Design. We utilize an autoencoder architecture for the energy function, as described in [63], using the reconstruction error of a sample as its energy value. Considering that the data distribution lies on ${\\mathbb S}^{272}$ , we appropriately narrow the function classes for the energy and sampler. Specifically, we constrain the decoder manifold of the energy function and the mean prediction of the sampler to remain on ${\\mathbb S}^{272}$ . We pretrain the energy function (i.e., the autoencoder) to minimize the reconstruction error of the training data. Both the sampler and the value function are trained from scratch. ", "page_idx": 18}, {"type": "text", "text": "Choice of $\\pi(\\mathbf{x}_{0})$ . Unlike traditional diffusion models, DxMI permits a flexible choice of $\\pi(\\mathbf{x}_{0})$ . To train the energy function effectively near the data distribution, we set the initial distribution for the sampler as the data distribution corrupted with noise. To apply meaningful noise to the data in ${\\mathbb S}^{272}$ , we use the pretrained autoencoder that is also used for the initial energy function to project the samples from the data distribution to the latent space, apply perturbations, and then restore the data to produce initial samples, as suggested in [59]. To maintain a consistent initial distribution, we fix the autoencoder used for generating the initial samples. ", "page_idx": 18}, {"type": "text", "text": "Additional Details. We use autoencoder with latent dimension 128 as the energy function. Encoder and decoder each consist of an MLP with 3 hidden layers and 1024 hidden dimensions. We use a time-conditional MLP for the sampler and value function, encoding the time information into a 128-dimensional vector using sinusoidal positional encoding. The input $\\mathbf{x}_{t}$ is concatenated with the time embedding vector. We use MLPs with 3 hidden layers of 2048 and 1024 hidden dimensions for the sampler and value function, respectively. ", "page_idx": 18}, {"type": "text", "text": "The model is trained for 100 epochs with a batch size of 784 $(=4\\!\\times\\!14\\!\\times\\!14)$ using the Adam optimizer.   \nWe use a learning rate of $10^{-\\frac{2}{5}}$ for the sampler and value function and $10^{-4}$ for the energy function. ", "page_idx": 18}, {"type": "text", "text": "D Implementation and Computational Complexity of DxMI ", "text_level": 1, "page_idx": 18}, {"type": "text", "text": "DxMI (Algorithm 1) may seem complicated, but it largely mirrors the procedure of Max Ent IRL, with the exception of the AVR update. Notably, DxDP, the Max Ent RL subroutine within DxMI, is significantly simpler than standard actor-critic RL algorithms. Unlike these algorithms\u2014such as Soft Actor Critic (SAC) [17], which requires training both a value function and two Q-functions\u2014DxMI only trains a single value function and no Q-functions. ", "page_idx": 18}, {"type": "table", "img_path": "V0oJaLqY4E/tmp/d7bd3ff89d5a33c9b9452771bd7180cacb1add468049d4d025adf4651aa7a47f.jpg", "table_caption": ["Table 6: MVTec-AD detection and localization task in the unified setting. AUROC scores (percent) are computed for each class. UniAD and DRAEM results are adopted from [60]. The largest value in a task is marked as boldface. "], "table_footnote": [], "page_idx": 19}, {"type": "text", "text": "DxMI does not demand excessive computation, a major concern in image generation experiments. In these experiments, the only additional component beyond the diffusion model is the EBM, which shares the same network as the value function. Additionally, the EBM used in DxMI is typically much smaller than the diffusion model, imposing minimal computational overhead. For instance, in our CIFAR-10 experiment $({\\mathrm{T}}{=}10)$ ), the EBM consists of 5M parameters, compared to 36M in the diffusion model. This is also significantly smaller than the critic networks used in GANs, such as the 158.3M parameters in BigGAN [49]. In practice, our CIFAR-10 experiment completes in under 24 hours on two A100 GPUs, while the ImageNet 64 experiment takes approximately 48 hours on four A100 GPUs. ", "page_idx": 19}, {"type": "text", "text": "E Interpretation of the policy improvement method ", "text_level": 1, "page_idx": 19}, {"type": "text", "text": "In this section, we show that our policy improvement method introduced in Eq. (11) can effectively minimize the KL divergence between the joint distributions, $K L(\\pi_{\\phi}(\\mathbf{x}_{0:T})||q_{\\theta}(\\mathbf{x}_{T})\\tilde{q}(\\mathbf{x}_{0:T-1}|\\mathbf{x}_{T}))$ . The policy improvement at each timestep $t$ can be expressed as ", "page_idx": 19}, {"type": "equation", "text": "$$\n\\operatorname*{min}_{\\pi(\\mathbf{x}_{t+1}|\\mathbf{x}_{t})}\\mathbb{E}_{\\mathbf{x}_{t},\\mathbf{x}_{t+1}\\sim\\pi}\\left[V^{t+1}(\\mathbf{x}_{t+1})+\\tau\\log\\pi(\\mathbf{x}_{t+1}|\\mathbf{x}_{t})-\\tau\\log\\tilde{q}(\\mathbf{x}_{t}|\\mathbf{x}_{t+1})\\right]+c o n s t.\n$$", "text_format": "latex", "page_idx": 19}, {"type": "text", "text": "Here omitted the parameters $\\phi$ and $\\psi$ to avoid confusion. Using the definition of value function, above minimization can be expressed as ", "page_idx": 19}, {"type": "equation", "text": "$$\n\\operatorname*{min}_{\\pi(\\mathbf{x}_{t+1}|\\mathbf{x}_{t})}\\mathbb{E}_{\\pi(\\mathbf{x}_{t:T})}\\left[E(\\mathbf{x}_{T})+\\tau\\sum_{t^{\\prime}=t}^{T-1}\\log\\pi(\\mathbf{x}_{t^{\\prime}+1}|\\mathbf{x}_{t^{\\prime}})-\\tau\\sum_{t^{\\prime}=t}^{T-1}\\log\\tilde{q}(\\mathbf{x}_{t^{\\prime}}|\\mathbf{x}_{t^{\\prime}+1})\\right],\n$$", "text_format": "latex", "page_idx": 19}, {"type": "text", "text": "where ", "page_idx": 19}, {"type": "equation", "text": "$$\n\\begin{array}{r l}&{\\mathbb{E}_{\\pi(\\mathbf{x}_{t:T})}\\left[E(\\mathbf{x}_{T})+\\tau\\displaystyle\\sum_{t^{\\prime}=t}^{T-1}\\log\\pi(\\mathbf{x}_{t^{\\prime}+1}|\\mathbf{x}_{t^{\\prime}})-\\tau\\displaystyle\\sum_{t^{\\prime}=t}^{T-1}\\log\\tilde{q}(\\mathbf{x}_{t^{\\prime}}|\\mathbf{x}_{t^{\\prime}+1})\\right]}\\\\ &{\\;=\\tau\\mathbb{E}_{\\pi(\\mathbf{x}_{t:T})}\\left[-\\log q(\\mathbf{x}_{T})-\\log\\tilde{q}(\\mathbf{x}_{t:T-1}|\\mathbf{x}_{T})+\\log\\pi(\\mathbf{x}_{t:T})-\\log Z-\\log\\pi(\\mathbf{x}_{t})\\right]}\\\\ &{\\;=\\tau K L(\\pi(\\mathbf{x}_{t:T})||q(\\mathbf{x}_{T})\\tilde{q}(\\mathbf{x}_{t:T-1}|\\mathbf{x}_{T}))-\\tau\\log Z+\\tau\\mathcal{H}(\\mathbf{x}_{t})}\\end{array}\n$$", "text_format": "latex", "page_idx": 19}, {"type": "text", "text": "Note that $\\mathbf{x}_{t}$ is fixed in this optimization problem, and the optimization variable is $\\mathbf x_{t+1}$ . Therefore the policy improvement step at time $t$ is equivalent to ", "page_idx": 19}, {"type": "equation", "text": "$$\n\\operatorname*{min}_{\\pi(\\mathbf{x}_{t+1}|\\mathbf{x}_{t})}K L(\\pi(\\mathbf{x}_{t:T})||q(\\mathbf{x}_{T})\\tilde{q}(\\mathbf{x}_{t:T-1}|\\mathbf{x}_{T}))\n$$", "text_format": "latex", "page_idx": 19}, {"type": "text", "text": "Therefore, the policy improvement step at each time step $t$ results in the minimization of the KL divergence between the joint distribution, $\\pi(\\mathbf{x}_{0:T})$ and $\\tilde{q}(\\mathbf{x}_{0:T})$ . ", "page_idx": 19}, {"type": "text", "text": "F Additional Image Generation Results ", "text_level": 1, "page_idx": 20}, {"type": "text", "text": "Additional samples from the image generation models are presented in Fig. 4 and Fig. 5. ", "page_idx": 20}, {"type": "image", "img_path": "V0oJaLqY4E/tmp/8acb7b1abfc5f11c2b4db88556570c2c2e9ac93b9ed5580c975de08542d81050.jpg", "img_caption": ["Figure 4: Randomly selected samples from CIFAR-10 training data, SFT-PG ( $T=10$ , FID: 4.32), and DxMI $T=10$ , FID: 3.19). "], "img_footnote": [], "page_idx": 20}, {"type": "image", "img_path": "V0oJaLqY4E/tmp/4034da0f8ea7699a09ea8a10a81a5c4560e2c31f647652aa2c2099b141dda173.jpg", "img_caption": ["Figure 5: Randomly selected samples from ImageNet $64\\!\\times\\!64$ training data, Consistency Model $T=1$ , FID: 6.20), DxMI ( $T=4$ , FID: 3.21), and DxMI $\\scriptstyle T\\ =\\ 10$ , FID: 2.68). Note that the Consistency Model samples distort human faces, while the DxMI samples depict them in correct proportions. "], "img_footnote": [], "page_idx": 20}, {"type": "text", "text": "NeurIPS Paper Checklist ", "text_level": 1, "page_idx": 21}, {"type": "text", "text": "1. Claims ", "text_level": 1, "page_idx": 21}, {"type": "text", "text": "Question: Do the main claims made in the abstract and introduction accurately reflect the paper\u2019s contributions and scope? ", "page_idx": 21}, {"type": "text", "text": "Answer: [Yes] ", "page_idx": 21}, {"type": "text", "text": "Justification: Our contributions are the maximum entropy IRL formulation for diffusion models and a learning algorithm inspired by dynamic programming. These contributions are explicitly stated in the abstract and the introduction. ", "page_idx": 21}, {"type": "text", "text": "2. Limitations ", "text_level": 1, "page_idx": 21}, {"type": "text", "text": "Question: Does the paper discuss the limitations of the work performed by the authors? Answer: [Yes] ", "page_idx": 21}, {"type": "text", "text": "Justification: We have dedicated a paragraph to the discussion of limitations in Section 7. ", "page_idx": 21}, {"type": "text", "text": "3. Theory Assumptions and Proofs ", "text_level": 1, "page_idx": 21}, {"type": "text", "text": "Question: For each theoretical result, does the paper provide the full set of assumptions and a complete (and correct) proof? ", "page_idx": 21}, {"type": "text", "text": "Answer: [NA] ", "page_idx": 21}, {"type": "text", "text": "Justification: No formal theorem or proposition is provided in the main manuscript. ", "page_idx": 21}, {"type": "text", "text": "4. Experimental Result Reproducibility ", "text_level": 1, "page_idx": 21}, {"type": "text", "text": "Question: Does the paper fully disclose all the information needed to reproduce the main experimental results of the paper to the extent that it affects the main claims and/or conclusions of the paper (regardless of whether the code and data are provided or not)? ", "page_idx": 21}, {"type": "text", "text": "Answer: [Yes] ", "page_idx": 21}, {"type": "text", "text": "Justification: We have put our best effort into making the proposed method reproducible. The concrete description of the proposed algorithm is provided in Algorithm 1. The detailed information on the model and implementation are described in Section 5 and Appendix C. We release our source code and model checkpoints at https://github.com/swyoon/ Diffusion-by-MaxEntIRL. Our public codebase will include instructions for preparing data and evaluating performance metrics. ", "page_idx": 21}, {"type": "text", "text": "5. Open access to data and code ", "text_level": 1, "page_idx": 21}, {"type": "text", "text": "Question: Does the paper provide open access to the data and code, with sufficient instructions to faithfully reproduce the main experimental results, as described in supplemental material? ", "page_idx": 21}, {"type": "text", "text": "Answer: [Yes] ", "page_idx": 21}, {"type": "text", "text": "Justification: We provide our code at https://github.com/swyoon/ Diffusion-by-MaxEntIRL. ", "page_idx": 21}, {"type": "text", "text": "6. Experimental Setting/Details ", "text_level": 1, "page_idx": 21}, {"type": "text", "text": "Question: Does the paper specify all the training and test details (e.g., data splits, hyperparameters, how they were chosen, type of optimizer, etc.) necessary to understand the results? ", "page_idx": 21}, {"type": "text", "text": "Answer: [Yes] ", "page_idx": 21}, {"type": "text", "text": "Justification: Section 5 and Appendix C describe experimental details including hyperparameters, model architecture, data preparation, and the choice of optimizers. We also provide a guideline for tuning hyperparameters in Appendix B. ", "page_idx": 21}, {"type": "text", "text": "7. Experiment Statistical Significance ", "text_level": 1, "page_idx": 21}, {"type": "text", "text": "Question: Does the paper report error bars suitably and correctly defined or other appropriate information about the statistical significance of the experiments? ", "page_idx": 21}, {"type": "text", "text": "Answer: [Yes] ", "page_idx": 21}, {"type": "text", "text": "Justification: We report error bars for 2D experiments where repetitive experiments can be readily conducted. We did not do statistical significance testing. ", "page_idx": 21}, {"type": "text", "text": "8. Experiments Compute Resources ", "text_level": 1, "page_idx": 22}, {"type": "text", "text": "Question: For each experiment, does the paper provide sufficient information on the computer resources (type of compute workers, memory, time of execution) needed to reproduce the experiments? ", "page_idx": 22}, {"type": "text", "text": "Answer: [Yes] Justification: We provide information on compute resource in Section 5 and Appendix C. ", "page_idx": 22}, {"type": "text", "text": "9. Code Of Ethics ", "text_level": 1, "page_idx": 22}, {"type": "text", "text": "Question: Does the research conducted in the paper conform, in every respect, with the NeurIPS Code of Ethics https://neurips.cc/public/EthicsGuidelines? ", "page_idx": 22}, {"type": "text", "text": "Answer: [Yes] ", "page_idx": 22}, {"type": "text", "text": "Justification: We have reviewed and followed the NeurIPS Code of Ethics. ", "page_idx": 22}, {"type": "text", "text": "10. Broader Impacts ", "text_level": 1, "page_idx": 22}, {"type": "text", "text": "Question: Does the paper discuss both potential positive societal impacts and negative societal impacts of the work performed? ", "page_idx": 22}, {"type": "text", "text": "Answer: [Yes] ", "page_idx": 22}, {"type": "text", "text": "Justification: We have included a paragraph discussing the potential negative impact of our work in Section 7. ", "page_idx": 22}, {"type": "text", "text": "11. Safeguards ", "text_level": 1, "page_idx": 22}, {"type": "text", "text": "Question: Does the paper describe safeguards that have been put in place for responsible release of data or models that have a high risk for misuse (e.g., pretrained language models, image generators, or scraped datasets)? ", "page_idx": 22}, {"type": "text", "text": "Answer: [NA] ", "page_idx": 22}, {"type": "text", "text": "Justification: Although we have image generation models, they are not equipped with safeguards. Our models are trained on relatively low-resolution images, such as CIFAR-10 and ImageNet $64\\!\\times\\!64$ , which reduces the likelihood of causing harm in the real world. ", "page_idx": 22}, {"type": "text", "text": "12. Licenses for existing assets ", "text_level": 1, "page_idx": 22}, {"type": "text", "text": "Question: Are the creators or original owners of assets (e.g., code, data, models), used in the paper, properly credited and are the license and terms of use explicitly mentioned and properly respected? ", "page_idx": 22}, {"type": "text", "text": "Answer: [Yes] ", "page_idx": 22}, {"type": "text", "text": "Justification: We have cited all datasets and baseline models used in our experiment. We also provide the license information in Appendix C. ", "page_idx": 22}, {"type": "text", "text": "13. New Assets ", "text_level": 1, "page_idx": 22}, {"type": "text", "text": "Question: Are new assets introduced in the paper well documented and is the documentation provided alongside the assets? ", "page_idx": 22}, {"type": "text", "text": "Answer: [NA] ", "page_idx": 22}, {"type": "text", "text": "Justification: Our work does not provide new assets. ", "page_idx": 22}, {"type": "text", "text": "14. Crowdsourcing and Research with Human Subjects ", "text_level": 1, "page_idx": 22}, {"type": "text", "text": "Question: For crowdsourcing experiments and research with human subjects, does the paper include the full text of instructions given to participants and screenshots, if applicable, as well as details about compensation (if any)? ", "page_idx": 22}, {"type": "text", "text": "Answer: [NA] ", "page_idx": 22}, {"type": "text", "text": "Justification: Our work does not involve any crowd sourcing or experiments with human subjects. ", "page_idx": 22}, {"type": "text", "text": "15. Institutional Review Board (IRB) Approvals or Equivalent for Research with Human Subjects ", "text_level": 1, "page_idx": 22}, {"type": "text", "text": "Question: Does the paper describe potential risks incurred by study participants, whether such risks were disclosed to the subjects, and whether Institutional Review Board (IRB) approvals (or an equivalent approval/review based on the requirements of your country or institution) were obtained? ", "page_idx": 22}, {"type": "text", "text": "Answer: [NA] ", "text_level": 1, "page_idx": 23}, {"type": "text", "text": "Justification: Our work does not involve experiments with human subjects. ", "page_idx": 23}]