[{"type": "text", "text": "Understanding and Improving Training-free Loss-based Diffusion Guidance ", "text_level": 1, "page_idx": 0}, {"type": "text", "text": "Yifei Shen1\u2217Xinyang Jiang1 Yifan Yang1 Yezhen Wang2 Dongqi Han1 Dongsheng Li1 1Microsoft Research Asia 2National University of Singapore ", "page_idx": 0}, {"type": "text", "text": "Abstract ", "text_level": 1, "page_idx": 0}, {"type": "text", "text": "Adding additional guidance to pretrained diffusion models has become an increasingly popular research area, with extensive applications in computer vision, reinforcement learning, and AI for science. Recently, several studies have proposed training-free loss-based guidance by using off-the-shelf networks pretrained on clean images. This approach enables zero-shot conditional generation for universal control formats, which appears to offer a free lunch in diffusion guidance. In this paper, we aim to develop a deeper understanding of training-free guidance, as well as overcome its limitations. We offer a theoretical analysis that supports training-free guidance from the perspective of optimization, distinguishing it from classifier-based (or classifier-free) guidance. To elucidate their drawbacks, we theoretically demonstrate that training-free guidance is more susceptible to misaligned gradients and exhibits slower convergence rates compared to classifier guidance. We then introduce a collection of techniques designed to overcome the limitations, accompanied by theoretical rationale and empirical evidence. Our experiments in image and motion generation confirm the efficacy of these techniques. ", "page_idx": 0}, {"type": "text", "text": "1 Introduction ", "text_level": 1, "page_idx": 0}, {"type": "text", "text": "Diffusion models represent a class of powerful deep generative models that have recently broken the long-standing dominance of generative adversarial networks (GANs) [8]. These models have demonstrated remarkable success in a variety of domains, including the generation of images and videos in computer vision [33, 3], the synthesis of molecules and proteins in computational biology [20, 52], as well as the creation of trajectories and actions in the field of reinforcement learning (RL) [21]. ", "page_idx": 0}, {"type": "text", "text": "One critical area of research in the field of diffusion models involves enhancing controllability, such as pose manipulation in image diffusion [50], modulation of quantum properties in molecule diffusion [20], and direction of goal-oriented actions in RL diffusion [23]. The predominant techniques for exerting control over diffusion models include classifier guidance and classifier-free guidance. Classifier guidance involves training a time-dependent classifier to map a noisy image, denoted as $\\pmb{x}_{t}$ , to a specific condition $\\textit{\\textbf{y}}$ , and then employing the classifier\u2019s gradient to influence each step of the diffusion process [8]. Conversely, classifier-free guidance bypasses the need for a classifier by training an additional diffusion model conditioned on $\\textit{\\textbf{y}}$ [18]. However, both approaches necessitate extra training to integrate the conditions. Moreover, their efficacy is often constrained when the data-condition pairs are limited and typically lack the zero-shot generalization capability. ", "page_idx": 0}, {"type": "text", "text": "Recently, several studies [2, 49, 37] have introduced training-free guidance that builds upon the concept of classifier guidance. These models eschew the need for training a classifier on noisy images; instead, they estimate the clean image from its noisy counterpart using Tweedie\u2019s formula and then employ pretrained networks, designed for clean images, to guide the diffusion process. Given that checkpoints for these networks pretrained on clean images are widely accessible online, this form of guidance can be executed in a zero-shot manner. A unique advantage of training-free guidance is that it can be applied to universal control formats, such as style, layout, and FaceID [2, 49, 37] without any additional training efforts. Furthermore, these algorithms have been successfully applied to offline reinforcement learning, enabling agents to achieve novel goals not previously encountered during training. In contrast to classifier guidance and classifier-free guidance, it is proved in Appendix E of [27] that training-free guidance does not offer an approximation to the exact conditional energy. Therefore, from a theoretical perspective, it is intriguing to understand how and when these methods succeed or fail. From an empirical standpoint, it is crucial to develop algorithms that can address and overcome these limitations. ", "page_idx": 0}, {"type": "text", "text": "", "page_idx": 1}, {"type": "text", "text": "This paper seeks to deepen the understanding of training-free guidance by examining its mechanisms and inherent limitations, as well as overcoming these limitations. Specifically, our major contributions can be summarized as follows: ", "page_idx": 1}, {"type": "text", "text": "\u2022 How does training-free guidance work? Although exact conditional energy is difficult to approximate in a training-free manner, from the optimization standpoint, we show that training-free guidance can effectively decrease the guidance loss function. The optimization perspective clarifies the mystery of why the guidance weights should be meticulously designed in relation to the guidance function and diffusion time, as observed in [49].   \n\u2022 When does training-free guidance not work? We theoretically identify the susceptibility of training-free guidance to misaligned gradient issues and slower convergence rates. We attribute these challenges to a decrease in the smoothness of the guidance network in contrast to the classifier guidance.   \n\u2022 Improving training-free guidance: We introduce random augmentation to alleviate the misaligned gradient and Polyak step size scheduling to improve convergence. The efficacy of these methods is empirically confirmed across various diffusion models (i.e., image diffusion and motion diffusion) and under multiple conditions (i.e., segmentation, sketch, text, object avoidance, and targeting)2. ", "page_idx": 1}, {"type": "text", "text": "2 Preliminaries ", "text_level": 1, "page_idx": 1}, {"type": "text", "text": "2.1 Diffusion Models ", "text_level": 1, "page_idx": 1}, {"type": "text", "text": "Diffusion models are characterized by forward and reverse processes. The forward process, occurring over a time interval from 0 to $T$ , incrementally transforms an image into Gaussian noise. On the contrary, the reverse process, from $T$ back to 0, reconstructs the image from the noise. Let $\\pmb{x}_{t}$ represent the state of the data point at time $t$ ; the forward process systematically introduces noise to the data by following a predefined noise sc\u221ahedule given by $\\pmb{x}_{t}=\\sqrt{\\alpha_{t}}\\pmb{x}_{0}+\\sigma_{t}\\pmb{\\epsilon}_{t}$ , where $\\alpha_{t}\\in[0,1]$ is monotonically decreasing with $t$ , $\\sigma_{t}=\\sqrt{1-\\alpha_{t}}$ , and $\\pmb{\\epsilon}_{t}\\sim\\mathcal{N}(0,\\pmb{I})$ is random noise. Diffusion models use a neural network to learn the noise at each step: ", "page_idx": 1}, {"type": "equation", "text": "$$\n\\operatorname*{min}_{\\theta}\\mathbb{E}_{\\mathbf{x}_{t},\\epsilon,t}[\\|\\epsilon_{\\theta}(x_{t},t)-\\epsilon_{t}\\|_{2}^{2}]=\\operatorname*{min}_{\\theta}\\mathbb{E}_{\\mathbf{x}_{t},\\epsilon,t}[\\|\\epsilon_{\\theta}(x_{t},t)+\\sigma_{t}\\nabla_{x_{t}}\\log p_{t}(x_{t})\\|_{2}^{2}],\n$$", "text_format": "latex", "page_idx": 1}, {"type": "text", "text": "where $p_{t}(\\pmb{x}_{t})$ is the distribution of $\\pmb{x}_{t}$ . The reverse process is obtained by the following ODE: ", "page_idx": 1}, {"type": "equation", "text": "$$\n\\frac{\\mathrm{d}\\mathbf{}x_{t}}{\\mathrm{d}t}=f(t)\\pmb{x}_{t}-\\frac{g^{2}(t)}{2}\\nabla_{\\pmb{x}_{t}}\\log p_{t}(\\mathbf{x}_{t})=f(t)\\pmb{x}_{t}+\\frac{g^{2}(t)}{2\\sigma_{t}}\\epsilon_{\\theta}(\\mathbf{x}_{t},t),\n$$", "text_format": "latex", "page_idx": 1}, {"type": "text", "text": "where $\\begin{array}{r}{f(t)=\\frac{\\operatorname{d}\\log{\\sqrt{\\alpha_{t}}}}{\\operatorname{d}t}}\\end{array}$ , $\\begin{array}{r}{g_{\\cdot}^{2}(t)=\\frac{\\mathrm{d}\\sigma_{t}^{2}}{\\mathrm{d}t}-2\\frac{\\mathrm{d}\\log\\sqrt{\\alpha_{t}}}{\\mathrm{d}t}\\sigma_{t}^{2}}\\end{array}$ 2 d logd t \u03b1t\u03c3t2 . The reverse process enables generation as it converts a Gaussian noise into the image. ", "page_idx": 1}, {"type": "text", "text": "2.2 Diffusion Guidance ", "text_level": 1, "page_idx": 1}, {"type": "text", "text": "In diffusion control, we aim to sample $\\scriptstyle x_{0}$ given a condition $\\textit{\\textbf{y}}$ . The conditional score function is expressed as follows: ", "page_idx": 1}, {"type": "equation", "text": "$$\n\\nabla_{x_{t}}\\log{p_{t}(x_{t}|y)}=\\nabla_{x_{t}}\\log{p_{t}(x_{t})}+\\nabla_{x_{t}}\\log{p_{t}(y|x_{t})}.\n$$", "text_format": "latex", "page_idx": 1}, {"type": "text", "text": "The conditions are specified by the output of a neural network, and the energy is quantified by the corresponding loss function. If $\\bar{\\ell}(f_{\\phi}(\\cdot),\\cdot)$ represents the loss function as computed by neural networks, then the distribution of the clean data is expected to follow the following formula [2, 49, 37]: ", "page_idx": 2}, {"type": "equation", "text": "$$\np_{0}(\\pmb{x}_{0}|\\pmb{y})\\propto p_{0}(\\pmb{x}_{0})\\exp(-\\ell(f_{\\phi}(\\pmb{x}_{0}),\\pmb{y})).\n$$", "text_format": "latex", "page_idx": 2}, {"type": "text", "text": "For instance, consider a scenario where the condition is the object location. In this case, $f_{\\phi}$ represents a fastRCNN architecture, and $\\ell$ denotes the classification loss and bounding box loss. By following the computations outlined in [27], we can derive the exact formula for the second term in the RHS of (2) as: ", "page_idx": 2}, {"type": "equation", "text": "$$\n\\nabla_{x_{t}}\\log{p_{t}(y|x_{t})}=\\nabla_{x_{t}}\\log{\\mathbb{E}_{p(x_{0}|x_{t})}[\\exp(-\\ell(f_{\\phi}(x_{0}),y)]}.\n$$", "text_format": "latex", "page_idx": 2}, {"type": "text", "text": "Classifier guidance [8] involves initially training a time-dependent classifier to predict the output of the clean image $\\scriptstyle x_{0}$ based on noisy intermediate representations $\\pmb{x}_{t}$ during the diffusion process, i.e., to train a time-dependent classifier $f_{\\psi}({\\pmb x}_{t},t)$ such that $f_{\\psi}(\\mathbf{\\boldsymbol{x}}_{t},t)\\approx f_{\\phi}(\\mathbf{\\boldsymbol{x}}_{0})$ . Then the gradient of the time-dependent classifier is used for guidance, given by $\\nabla_{\\pmb{x}_{t}}\\log p_{t}(\\pmb{y}|\\pmb{x}_{t}):=-\\nabla_{\\pmb{x}_{t}}\\ell(f_{\\psi}(\\pmb{x}_{t},t),\\pmb{y})$ . This term equals (4) if the loss is cross-entropy. ", "page_idx": 2}, {"type": "text", "text": "Training-free loss-based guidance [2, 49, 6] puts the expectation in (4) inside the loss function: ", "page_idx": 2}, {"type": "equation", "text": "$$\n\\nabla_{x_{t}}\\log{p_{t}(y|x_{t})}:=\\nabla_{x_{t}}\\log\\left[\\exp(-\\ell(f_{\\phi}(\\mathbb{E}_{p(x_{0}|x_{t})}(x_{0})),y)\\right]\\stackrel{(a)}{=}-\\nabla_{x_{t}}\\ell\\left[f_{\\phi}\\left(\\frac{x_{t}-\\sigma_{t}\\epsilon_{\\theta}\\bigl(x_{t},t\\bigr)}{\\sqrt{\\alpha_{t}}}\\right),y\\right],\n$$", "text_format": "latex", "page_idx": 2}, {"type": "text", "text": "where (a) uses Tweedie\u2019s formula $\\begin{array}{r}{\\mathbb{E}_{p(\\mathbf{x}_{0}\\mid\\mathbf{x}_{t})}(\\mathbf{x}_{0})=\\frac{\\mathbf{x}_{t}-\\sigma_{t}\\epsilon_{\\theta}(\\mathbf{x}_{t},t)}{\\sqrt{\\alpha_{t}}}}\\end{array}$ . Leveraging this formula permits the use of a pretrained off-the-shelf network designed for processing clean data. The gradient of the last term in the energy function is obtained via backpropagation through both the guidance network and the diffusion backbone. ", "page_idx": 2}, {"type": "text", "text": "3 Analysis of Training-Free Guidance ", "text_level": 1, "page_idx": 2}, {"type": "text", "text": "3.1 How does Training-free Guidance Work? ", "text_level": 1, "page_idx": 2}, {"type": "text", "text": "On the difficulty of approximating $\\nabla_{\\pmb{x}_{t}}\\log p_{t}(\\pmb{y}|\\pmb{x}_{t})$ in high-dimensional space. Despite being intuitive, [27] has shown that training-free guidance in (5) does not offer an approximation to the true energy in (4). The authors of [37] consider to directly approximate (4) with a Gaussian distribution: ", "page_idx": 2}, {"type": "equation", "text": "$$\n\\begin{array}{r l}&{\\nabla_{x_{t}}\\log\\mathbb{E}_{p(x_{0}|x_{t})}[\\exp(-\\ell(f_{\\phi}(x_{0}),y)]\\overset{(a)}{\\approx}\\nabla_{x_{t}}\\log\\mathbb{E}_{q(x_{0}|x_{t})}[\\exp(-\\ell(f_{\\phi}(x_{0}),y)]}\\\\ &{\\approx\\nabla_{x_{t}}\\log\\frac{1}{n}\\displaystyle\\sum_{i=1}^{n}\\exp(-\\ell(f_{\\phi}(x_{0}^{i}),y)),\\quad x_{0}^{i}\\sim q(x_{0}|x_{t}),}\\end{array}\n$$", "text_format": "latex", "page_idx": 2}, {"type": "text", "text": "where $q(\\mathbf{\\boldsymbol{x}}_{0}|\\mathbf{\\boldsymbol{x}}_{t})$ is chosen as $\\mathcal{N}(\\mathbb{E}_{p(\\mathbf{x}_{0}|\\mathbf{x}_{t})}(\\mathbf{x}_{0}),r_{t}^{2}I)$ and $r_{t}$ is a tunable parameter. As demonstrated in [37], the approximation is effective for one-dimensional distribution. However, we find that the approximation denoted by (a) does not extend to high-dimensional data (e.g., images) if the surrogate distribution $q$ is sub-Gaussian. This is due to the well-known high-dimensional probability phenomenon [43] that if $q$ has sub-Gaussian coordinates (e.g., iid and bounded), then $q(\\pmb{x}_{0}|\\pmb{x}_{t})$ tends to concentrate on a spherical shell centered at $\\mathbb{E}_{p(\\mathbf{x}_{0}|\\mathbf{x}_{t})}(\\mathbf{x}_{0})$ with radius $r_{t}$ (details are in Appendix C.1). Since the spherical shell represents a low-dimensional manifold with zero measure in the high-dimensional space, there is a significant likelihood that the supports of $p(\\mathbf{\\boldsymbol{x}}_{0}|\\mathbf{\\boldsymbol{x}}_{t})$ and $q(\\pmb{x}_{0}|\\pmb{x}_{t})$ do not overlap, rendering the approximation (a) ineffective. ", "page_idx": 2}, {"type": "text", "text": "Understanding training-free guidance from an optimization perspective. We instead analyze the training-free guidance from the optimization perspective. Intuitively, in each step, the gradient is taken and the loss of the guidance network decreases. At the initial stage of the diffusion $t$ is large), the diffusion trajectory can exhibit substantial deviations between adjacent steps and may increase the objective value. So the objective value will oscillate at the beginning. When $t$ is smaller, the change to the sample is more fine-grained, leading to a bounded change in the objective value. Therefore, the objective value is guaranteed to decrease when $t$ is small, as showing in the next proposition. ", "page_idx": 2}, {"type": "text", "text": "Proposition 3.1. Assume that the guidance loss function $\\ell(f_{\\phi}(\\pmb{x}_{0}),\\pmb{y})$ is $\\mu{-}P L$ (defined in Defintion $D.2$ in appendix) and $L_{f}$ -Lipschitz with respect to clean images $\\pmb{x}_{0}$ , and the score function $\\nabla\\log p_{t}(\\pmb{x}_{t})$ is $L_{p}$ -Lipschitz (defined in Defintion $D.I$ in appendix) with respect to noisy image $\\pmb{x}_{t}$ . Denote $\\lambda_{\\operatorname*{min}}$ as the minimum eigenvalue of the (semi)-definite matrix $C o\\nu[\\pmb{x}_{0}|\\pmb{x}_{t}]$ . Then the following conditions hold: (1) Consider the loss function $\\begin{array}{r}{\\ell_{t}(\\pmb{x}_{t})=\\ell\\left(f_{\\phi}\\left(\\frac{\\pmb{x}_{t}+\\sigma_{t}^{2}\\nabla\\log p_{t}(\\pmb{x}_{t})}{\\sqrt{\\alpha_{t}}}\\right),\\pmb{y}\\right)}\\end{array}$ and denote $\\begin{array}{r}{\\kappa_{1}\\,=\\,\\frac{\\mu\\lambda_{\\mathrm{min}}^{2}}{L_{f}(1+L_{p})\\sqrt{\\alpha_{t}}\\sigma_{t}^{4}}}\\end{array}$ . After one gradient step $\\begin{array}{r}{\\hat{\\pmb{x}}_{t}\\,=\\,\\pmb{x}_{t}\\,-\\,\\eta\\nabla_{\\pmb{x}_{t}}\\ell_{t}(\\pmb{x}_{t}),\\eta\\,=\\,\\frac{\\sqrt{\\alpha_{t}}}{L_{f}(1+L_{p})}}\\end{array}$ , we have $\\ell_{t}(\\hat{\\pmb{x}}_{t})\\le(1-\\kappa_{1})\\ell_{t}(\\pmb{x}_{t})$ at for any diffusion step, i.e., $\\begin{array}{r}{\\ell_{t-1}({\\pmb x}_{t-1})\\leq\\frac{\\ell_{t}(\\hat{\\pmb x}_{t})}{(1-\\kappa_{2})}}\\end{array}$ for some $\\kappa_{2}<\\kappa_{1}$ , then the objective function converges at a linear rate, i.e., $\\begin{array}{r}{\\ell_{t-1}({\\pmb x}_{t-1})\\leq\\frac{1-\\kappa_{1}}{1-\\kappa_{2}}\\ell_{t}({\\pmb x}_{t})}\\end{array}$ . ", "page_idx": 2}, {"type": "text", "text": "", "page_idx": 3}, {"type": "image", "img_path": "Eu80DGuOcs/tmp/5a3bbf2b7be0cf628e1436653e74e899507f34dda4a0220b4f4e2aa527695ddf.jpg", "img_caption": ["Figure 1: The classifier loss of a successful and a failure guidance example. The target class is \u201cindigo bird\u201d. "], "img_footnote": [], "page_idx": 3}, {"type": "text", "text": "The proof is given in Appendix D.2. The Lipschitz continuity and PL conditions are basic assumptions in optimization, and it has been shown that neural networks can locally satisfy these conditions [5]. These assumptions, while not essential, simplify the proof and results for clarity, similar to the assumptions taken in [26]. The optimization perspective clarifies the mystery of why the guidance weights (i.e., the step size in optimization) should be carefully selected with respect to the guidance function and time $t$ . For example, in [49], most guidance weights $\\eta$ are chosen to be proportional to $\\sqrt{\\alpha_{t}}$ and dependent on guidance network, which differs from the weights used in classifier guidance and aligns with our step size in Proposition 3.1. ", "page_idx": 3}, {"type": "text", "text": "Then we empirically verify Proposition 3.1 via experiments in Figure 1. We use ResNet-50 trained on clean images to guide ImageNet pretrained diffusion models. The loss value at each diffusion step is plotted. As a reference, we choose 100 images from the class \u201cindigo bird\u201d in ImageNet training set and compute the loss value, which is referred to as \u201cCorrect Image Loss\u201d in the figure. The objective value oscillates when $t$ is large, followed by a swift decrease, which verifies our analysis. More convergence figures are given in Figure 7 in Appendix. ", "page_idx": 3}, {"type": "text", "text": "An intriguing aspect of the theory is that the loss remains low regardless of the success of the guidance, akin to the loss associated with correct images. Figure 1b demonstrates this phenomenon: despite the absence of an indigo bird in the image, the loss is still minimal. This phenomenon can be attributed to the effect of misaligned gradients, which is explored in detail in the following subsection. ", "page_idx": 3}, {"type": "text", "text": "3.2 Limitations of Training-free Guidance ", "text_level": 1, "page_idx": 3}, {"type": "text", "text": "In this subsection, we examine the disadvantages of employing training-free guidance networks as opposed to training-based classifier guidance. ", "page_idx": 3}, {"type": "text", "text": "Training-free guidance is more sensitive to the misaligned gradient. Adversarial gradient is a significant challenge for neural networks, which refers to minimal perturbations deliberately applied to inputs that can induce disproportionate alterations in the model\u2019s output [38]. The resilience of a model to adversarial gradients is often analyzed through the lens of its Lipschitz constant [34]. If the model has a lower Lipschitz constant, then the output is less sensitive to the input perturbations and thus is more robust. ", "page_idx": 3}, {"type": "text", "text": "In the classifier or training-free guidance, the gradient of the guidance network is added to the image. In contrast to yielding a direction that meaningfully minimizes the loss, the adversarial gradient primarily serves to minimize the loss in a manner that is not necessarily aligned with the intended guidance direction. As a result, we refer the adversarial gradient of guidance network as the misaligned gradient in diffusion guidance. ", "page_idx": 3}, {"type": "text", "text": "Compared with the off-the-shelve guidance network used in training-free guidance, time-dependent classifiers are trained on noise-augmented images. Our finding is that adding Gaussian noise improves the Lipschitzness of the guidance network. This transition mitigates the misaligned gradient challenge by inherently enhancing the model\u2019s robustness to such perturbations, as shown in the next proposition. ", "page_idx": 4}, {"type": "text", "text": "Proposition 3.2. (Time-dependent network is more robust and smooth) Given a bounded loss function $\\ell({\\pmb x})\\leq C$ , the loss $\\hat{\\ell}(\\pmb{x})=\\mathbb{E}_{\\pmb{\\epsilon}\\sim\\mathcal{N}(0,\\pmb{I})}[\\ell(\\pmb{x}+\\sigma_{t}\\pmb{\\epsilon})]$ is $C\\sqrt{\\frac{2}{\\pi\\sigma_{t}^{2}}}$ -Lipschitz and $\\nabla\\hat{\\ell}$ is $\\frac{2C}{\\sigma_{t}}$ -Lipschitz. ", "page_idx": 4}, {"type": "image", "img_path": "Eu80DGuOcs/tmp/87fed5093735d76ad8e58ee601713757ba140f084dda48c42d9c1579997aee42.jpg", "img_caption": ["(a) Adversarially robust (b) Time-dependent classi-(c) Off-the-shelf ResNet-(d) ResNet-50 with ranclassifier. fier. 50 classifier. dom augmentation. ", "Figure 2: Gradients of different classifiers on random backgrounds. The images in the first row correspond to the target class \u201ccock\u201d, and the second row to \u201cgoldfinch\u201d. "], "img_footnote": [], "page_idx": 4}, {"type": "text", "text": "The proof is given in Appendix D.3. We then support Proposition 3.2 with both qualitative and quantitative experiments. For qualitative experiments, we present visualizations of the accumulated gradients for both the time-dependent and off-the-shelf time-independent classifiers corresponding to different classes in Figure 2b and Figure 2c, respectively. These visualizations are generated by initializing an image with a random background and computing 1000 gradient steps for each classifier. For the time-dependent classifier, the input time for the $t$ -th gradient step is $1000-t$ . The images are generated purely by the classifier gradients without diffusion involved. For comparative analysis, we include the accumulated gradient of an adversarially robust classifier [35], as shown in Figure 2a, which has been specifically trained to resist misaligned (adversarial) gradients. The resulting plots reveal a stark contrast: the gradient of the time-dependent classifier visually resembles the target image, whereas the gradient of the time-independent classifier does not exhibit such recognizability. This observation suggests that off-the-shelf time-independent classifiers are prone to generating misaligned gradients for guidance compared to the time-dependent classifier used in classifier guidance. The quantitative experiments are given in Table 4 in Appendix. ", "page_idx": 4}, {"type": "text", "text": "Figure 2 provides a more intuitive visual explanation of diffusion guidance compared to the existing formula-based approaches as shown in (7). The gradient produced by the guidance network represents a valid image. When these gradients are incorporated into the images, the diffusion model is able to identify the object and enhance it into a clearer and more vivid representation. ", "page_idx": 4}, {"type": "text", "text": "Training-free guidance slows down the convergence of reverse ODE. The efficiency of an algorithm in solving reverse ordinary differential equations is often gauged by the number of non-linear function estimations (NFEs) required to achieve convergence. This metric is vital for algorithmic design, as it directly relates to computational cost and time efficiency [36]. In light of this, we explore the convergence rates associated with various guidance paradigms, beginning our analysis with a reverse ODE framework that incorporates a generic gradient guidance term. The formula is expressed as ", "page_idx": 4}, {"type": "equation", "text": "$$\n\\frac{\\mathrm{d}\\pmb{x}_{t}}{\\mathrm{d}t}=f(t)\\pmb{x}_{t}+\\frac{g^{2}(t)}{2}(\\epsilon_{\\theta}(\\pmb{x}_{t},t)+\\nabla_{\\pmb{x}_{t}}v(\\pmb{x}_{t},t)),\n$$", "text_format": "latex", "page_idx": 4}, {"type": "text", "text": "where $h(\\cdot,\\cdot)$ can be either a time-dependent classifier or a time-independent classifier with Tweedie\u2019s formula. The subsequent proposition elucidates the relationship between the discretization error and the smoothness of the guidance function. ", "page_idx": 4}, {"type": "text", "text": "Proposition 3.3. $\\begin{array}{r l r l r l r l r l r l}{\\mathbf{\\Omega}\\cdot\\mathbf{\\textit{et}}}&{{}\\mathbf{\\Omega}\\mathbf{\\textit{u}}(\\mathbf{x}_{t},t)}&{}&{{}=}&{}&{{}\\epsilon_{\\theta}(\\mathbf{x}_{t},t)}&{+}&{\\nabla_{\\mathbf{x}_{t}}v(\\mathbf{x}_{t},t)}&{i n}&{{}(7),}&{\\ h_{\\operatorname*{max}}}&{}&{{}=}&{\\frac{\\partial\\phi(\\mathbf{x}_{t},t)}{\\partial\\mathbf{x}_{t}},}\\end{array}$ $\\begin{array}{r}{\\operatorname*{max}_{t}\\frac{1}{2}\\left[\\log(\\frac{\\alpha_{t}}{1-\\alpha_{t}})-\\log(\\frac{\\dot{\\alpha_{t-1}}}{1-\\alpha_{t-1}})\\right]}\\end{array}$ . Assume we run DDIM solver for $M$ steps and $M=O(1/h_{\\operatorname*{max}})$ . Then the error is bounded by $O((1+L^{M})/M)$ . ", "page_idx": 4}, {"type": "text", "text": "The proof is given in Appendix D.4. Proposition 3.2 establishes that time-dependent classifiers exhibit superior gradient Lipschitz constants compared to their off-the-shelf time-independent counterparts. This disparity in smoothness slows down the convergence for training-free guidance methods, necessitating a greater number of NFEs to achieve the desired level of accuracy when compared to classifier guidance. To provide quantitative support, we compare the convergence speed of training-based PPAP [12] and training-free FreeDoM in Table 5 in Appendix. ", "page_idx": 5}, {"type": "text", "text": "4 Improving Training-free Guidance ", "text_level": 1, "page_idx": 5}, {"type": "text", "text": "In this section, we propose to adopt random augmentation to mitigate the misaligned gradient issue, and Polyak step size [15] to mitigate the convergence issue. In addition to these two techniques, our method and baselines will also incorporate a trick named time travel, often referred to as \u201crestart sampling\u201d, and its theoretical framework is detailed in [46]. ", "page_idx": 5}, {"type": "table", "img_path": "Eu80DGuOcs/tmp/4546f06734afe66ee0b940a25e793f4272c3740eab5c9b7a2bc088dd49e1c54b.jpg", "table_caption": [], "table_footnote": [], "page_idx": 5}, {"type": "text", "text": "4.1 Random Augmentation ", "text_level": 1, "page_idx": 5}, {"type": "text", "text": "As established by Proposition 3.2, the introduction of Gaussian perturbations enhances the Lipschitz property of a neural network. A direct application of this principle involves creating multiple noisy instances of an estimated clean image and passing them into the guidance network, a method analogous to the one described in (6). However, given the high-dimensional nature of image data, achieving a satisfactory approximation of the expected value necessitates an impractically large number of noisy copies. To circumvent this issue, we propose an alternative strategy that employs a diverse set of data augmentations in place of solely adding Gaussian noise. This approach effectively introduces perturbations within a lower-dimensional latent space, thus requiring fewer samples. The suite of data augmentations utilized, denoted by $\\tau$ , is derived from the differentiable data augmentation techniques outlined in [51], which encompasses transformations such as translation, resizing, color adjustments, and cutout operations. The details are shown in Algorithm 1 and the rationale is shown in the following proposition. ", "page_idx": 5}, {"type": "text", "text": "Proposition 4.1. (Random augmentation improves smoothness) Given a bounded non-Lipschitz loss function $\\ell(x)$ , the loss $\\hat{\\ell}(\\pmb{x})=\\mathbb{E}_{\\epsilon\\sim p(\\pmb{\\epsilon})}[\\ell(\\pmb{x}+\\pmb{\\epsilon})]$ is $\\begin{array}{r}{C\\int_{\\mathbb{R}^{n}}\\|\\nabla p(\\pmb{t})\\|_{2}\\mathrm{d}\\pmb{t}}\\end{array}$ -Lipschitz and its gradient is $\\begin{array}{r}{C\\int_{\\mathbb{R}^{n}}\\|\\nabla^{2}p(t)\\|_{o p}\\mathrm{d}t}\\end{array}$ -Lipschitz. ", "page_idx": 5}, {"type": "text", "text": "The proof is shown in Appendix D.5. Echoing the experimental methodology delineated in Section 3.2, we present an analysis of the accumulated gradient effects when applying random augmentation to a ResNet-50 model. Specifically, we utilize a set of $|\\mathcal{T}|\\,=10$ diverse transformations as our augmentation strategy. The results of this experiment are visualized in Figure 2d, where the target object\u2019s color and shape emerge in the gradient proflie. This observation suggests that the implementation of random augmentation can alleviate the misaligned gradient issue. The quantitative effect of random augmentation is given in Table 4 in Appendix. The computational efficiency of random augmentation is further discussed in Appendix C.4. ", "page_idx": 5}, {"type": "text", "text": "4.2 Polyak Step Size ", "text_level": 1, "page_idx": 5}, {"type": "text", "text": "In Section 3.1, we analyzed training-free guidance from the optimization perspective. To accelerate the convergence, gradient step size should be adaptive to the gradient landscape. We adopt Polyak step size, which has near-optimal convergence rates under various conditions [15]. The algorithm is ", "page_idx": 5}, {"type": "text", "text": "Small Guidance e Guidance Small Guidance Large Guidance FreeDoM FreeDoM FreeDoM FreeDoM (Polyak) (Polyak) ", "text_level": 1, "page_idx": 6}, {"type": "text", "text": "shown in Algorithm 2 and the term $\\|\\pmb{\\epsilon}_{\\theta}(\\pmb{x}_{t},t)\\|$ is used to both estimate the gap to optimal values and balance the magnitude of diffusion term and guidance term. ", "page_idx": 6}, {"type": "text", "text": "We implement Polyak step size within the context of a training-free guidance framework called FreeDoM [49] and benchmark the performance of this implementation using the DDIM sampler with 50 steps. As shown in Figure 3, FreeDoM is unable to effectively guide the generation process when faced with a significant discrepancy between the unconditional generation and the specified condition. An illustrative example is the difficulty in guiding the model to generate faces oriented to the left when the unconditionally generated faces predominantly orient to the right, as shown in Figure 3b. This challenge, which arises due to the insufficiency of 50 steps for convergence under the condition, is ameliorated by substituting gradient descent with adaptive step size, thereby illustrating the beneftis of employing a better step size in the guidance process. The quantitative experiments are given in Table 5 in Appendix. ", "page_idx": 6}, {"type": "text", "text": "5 Experiments ", "text_level": 1, "page_idx": 6}, {"type": "text", "text": "In this section, we evaluate the efficacy of our proposed techniques across various diffusion models and guidance conditions. We compare our methods with established baselines: Universal Guidance (UG) [2], Loss-Guided Diffusion with Monte Carlo (LGD-MC) [37], Training-Free Energy-Guided Diffusion Models (FreeDoM) [49], and Manifold Preserving Guided Diffusion (MPGD) [16]. LGDMC utilizes (6) while UG and FreeDoM are built on (5). MPGD utilizes an auto-encoder to ensure the manifold constraints. Furthermore, time travel trick (Algorithm 3) is adopted in UG, FreeDoM, and MPGD to improve the performance. Please refer to Appendix B for details of baselines. For the sampling method, DDIM with 100 steps is adopted as in [49, 37]. The method \u201cOurs\u201d is built on FreeDoM, with Polyak step size and random augmentation. ", "page_idx": 6}, {"type": "text", "text": "5.1 Guidance to CelebA-HQ Diffusion ", "text_level": 1, "page_idx": 6}, {"type": "text", "text": "In this subsection, we adopt the experimental setup from [49]. Specifically, we utilize the CelebA-HQ diffusion model [19] to generate high-quality facial images. We explore three guidance conditions: segmentation, sketch, and text. For segmentation guidance, BiSeNet [48] generates the facial segmentation maps, with an $\\ell_{2}$ -loss applied between the estimated map of the synthesized image and the provided map. Sketch guidance involves using the method from [45] to produce facial sketches, where the loss function is the $\\ell_{2}$ -loss between the estimated sketch of $\\hat{\\pmb{x}}_{0}$ and the given sketch. For text guidance, we employ CLIP [32] as both the image and text encoders, setting the loss to be the $\\ell_{2}$ distance between the image and text embeddings. ", "page_idx": 6}, {"type": "text", "text": "We randomly select 1000 samples each of segmentation maps, sketches, and text descriptions. The comparative results are presented in Table 1. Consistent with [49], the time-travel number for all methods is set to $s=1$ . Figure 4 displays a random selection of the generated images. More image samples are provided in the supplementary materials. We find that the baselines failed to guide if the condition differs from unconditionally generated images significantly, as discussed in Section 4.2. ", "page_idx": 6}, {"type": "text", "text": "5.2 Guidance to ImageNet Diffusion ", "text_level": 1, "page_idx": 6}, {"type": "text", "text": "For the unconditional ImageNet diffusion, we employ text guidance in line with the approach used in FreeDoM and UG [2, 49]. We utilize CLIP-B/16 as the image and text encoder, with cosine similarity ", "page_idx": 6}, {"type": "table", "img_path": "Eu80DGuOcs/tmp/7835999da2be310a5ce653333ce2129e037e4864732521e61d7714a8a3184073.jpg", "table_caption": [], "table_footnote": [], "page_idx": 7}, {"type": "table", "img_path": "Eu80DGuOcs/tmp/c655fdf06afd39ce9cee22bf1d81dc7110c9a35d5f3c4a3a08d40dcea0443327.jpg", "table_caption": ["Table 1: The performance comparison of various methods on CelebA-HQ with different types of zero-shot guidance. The experimental settings adhere to Table 1 of [49]. "], "table_footnote": [], "page_idx": 7}, {"type": "text", "text": "Table 2: The performance comparison of various methods on unconditional ImageNet with zero-shot text guidance. We compare various methods using ImageNet pretrained diffusion models with CLIP-B/16 guidance. For evaluating performance, the CLIP score is computed using CLIP-L/14. ", "page_idx": 7}, {"type": "text", "text": "serving as the loss function to measure the congruence between the image and text embeddings. To evaluate performance and mitigate the potential for high-scoring adversarial images, we use CLIP-L/14 for computing the CLIP score. In FreeDoM and MPGD-Z, resampling is conducted for time steps ranging from 800 to 300, with the time-travel number fixed at 10, as described in [49]. Given that UG resamples at every step, we adjust its time-travel number $s=5$ to align the execution time with that of FreeDoM. The textual prompts for our experiments are sourced from [25]. The comparison of different methods is depicted in Table 2. The corresponding randomly selected images are illustrated in Figure 5. The table indicates that our method achieves the highest consistency with the provided prompts. As shown in Figure 5, LGD-MC and MPGD tend to overlook elements of the prompts. Both UG and FreeDoM occasionally produce poorly shaped objects, likely influenced by misaligned gradients. Our approach addresses this issue through the implementation of random augmentation. Additionally, none of the methods successfully generate images that accurately adhere to positional prompts such as \u201cleft to\u201d or \u201cbelow\u201d. This limitation is inherent to CLIP and extends to all text-to-image generative models [41]. More image samples are provided in the supplementary materials. ", "page_idx": 7}, {"type": "text", "text": "5.3 Guidance to Human Motion Diffusion ", "text_level": 1, "page_idx": 7}, {"type": "text", "text": "In this subsection, we extend our evaluation to human motion generation using the Motion Diffusion Model (MDM) [40], which represents motion through a sequence of joint coordinates and is trained on a large corpus of text-motion pairs with classifier-free guidance. We apply the targeting guidance and object avoidance guidance as described in [37]. Let ${\\mathbf{}}x_{0}(t)$ denote the joint coordinates at time $t$ , $\\mathbf{\\nabla}_{y_{t}}$ the target location, $\\pmb{y}_{\\mathrm{{obs}}}$ the obstacle location, $r$ the radius of the objects, and $T$ the total number of frames. The loss function is defined as follows: ", "page_idx": 7}, {"type": "equation", "text": "$$\n\\ell=\\|y_{t}-x_{0}(T)\\|_{2}^{2}+\\sum_{i}\\mathrm{sigmoid}(-(\\|x_{0}(i)-y_{\\mathrm{obs}}\\|-r)\\times50)\\times100.\n$$", "text_format": "latex", "page_idx": 7}, {"type": "text", "text": "Our experimental configuration adheres to the guidelines set forth in [37]. We assess the methods using the targeting loss (the first term in (8)), the object avoidance loss (the second term in (8)), and the CLIP score calculated by MotionCLIP [39]. In this application, MPGD-Z cannot be applied as there are no auto-encoder. MPGD w/o proj suffers from the shortcut and cannot achieve good performance, as discussed in Appendix B.2. In our method, random augmentation is omitted because the guidance is not computed by neural networks so the adversarial gradient issues are not obvious. The quantitative results of our investigation are summarized in Table 3, while Figure 6 showcases randomly selected samples. Our methods exhibit enhanced control quality over the generated motion. The videos are provided in the supplementary materials. ", "page_idx": 7}, {"type": "table", "img_path": "Eu80DGuOcs/tmp/aeaace71dafb03a6b52137743125397f2f61501849db6eede07fe17a8babf3e8.jpg", "table_caption": [], "table_footnote": ["Table 3: Comparison of various methods on MDM with zero-shot targeting and object avoidance guidance. Loss is reported as a two-component metric: the first part is the MSE between the target and the actual final position of the individual; the second part measures the object avoidance loss. "], "page_idx": 8}, {"type": "text", "text": "5.4 Related Work on Training-Free Guidance ", "text_level": 1, "page_idx": 8}, {"type": "text", "text": "Due to space limitation, we only introduce the related work on training-free guidance while leaving more related work in Appendix A. The current training-free guidance strategies for diffusion models can be divided into two primary categories. The first category is the loss-based guidance in this paper, which is universally applicable to universal control formats and diffusion models. These methods predict a clean image, subsequently leveraging pretrained networks to guide the diffusion process. Central to this approach are the algorithms based on (5), which have been augmented through techniques like time-travel [2, 49] and the introduction of Gaussian noise [37]. The adjoint sensitivity method [31] and spherical Gaussian constraint [47] have been adopted to estimate a more accurate guidance gradient. Extensions of these algorithms have found utility in domains with constrained data-condition pairs, such as molecule generation [14], and in scenarios necessitating zero-shot guidance, like open-ended goals in offilne reinforcement learning [44]. In molecular generation and offline reinforcement learning, they outperform training-based alternatives as additional training presents challenges. This paper delves deeper into the mechanics of this paradigm and introduces a suite of enhancements to bolster its performance. The efficacy of our proposed modifications is demonstrated across image and motion generation, with promising potential for generalization to molecular modeling and reinforcement learning tasks. ", "page_idx": 8}, {"type": "text", "text": "The second category of training-free guidance is tailored to text-to-image or text-to-video diffusion models, which is based on insights into their internal backbone architecture. For instance, object layout and shape have been linked to the cross-attention mechanisms [17], while network activations have been shown to preserve object appearance [42]. These understandings facilitate targeted editing of object layout and appearance (Diffusion Self-Guidance [11]) and enable the imposition of conditions in ControlNet through training-free means (FreeControl [30]). Analyzing these methodologies is challenging due to their reliance on emergent representations during training. Nonetheless, certain principles from this paper remain relevant; for example, as noted in Proposition 3.3, these methods often necessitate extensive diffusion steps, with instances such as [30, 11] employing 1000 steps. A thorough examination and refinement of these techniques remain an avenue for future research. ", "page_idx": 8}, {"type": "text", "text": "6 Conclusions ", "text_level": 1, "page_idx": 8}, {"type": "text", "text": "In this paper, we conducted a comprehensive investigation into training-free guidance, which employs pretrained diffusion models and guides them using the off-the-shelf trained on clean images. Our exploration delved into the underlying mechanisms and fundamental limits of these models. Moreover, we proposed a set of enhancement techniques and verified their effectiveness both theoretically and empirically. ", "page_idx": 8}, {"type": "text", "text": "Limitations. Despite our efforts to mitigate the shortcomings of training-free methods and enhance their performance, certain limitations remain. Notably, the refined training-free guidance still necessitates a higher number of NFEs when compared with extensive training methods such as classifier-free guidance. This is because misaligned gradient cannot be fully eliminated without training. ", "page_idx": 8}, {"type": "text", "text": "Ethical Consideration. Similar to other models designed for image creation, our model also has the unfortunate potential to be used for creating deceitful or damaging material. We pledge to restrict the usage of our model exclusively to the realm of research to prevent such misuse. ", "page_idx": 8}, {"type": "image", "img_path": "Eu80DGuOcs/tmp/991ee587d270b5df4e49849e1eca7ddc690c362533d1ef18c7a0d998fef72b92.jpg", "img_caption": ["Figure 4: Qualitative results of CelebA-HQ with zero-shot segmentation, sketch, and text guidance. The images are randomly selected. "], "img_footnote": [], "page_idx": 9}, {"type": "image", "img_path": "Eu80DGuOcs/tmp/b7fd042c56597189848edaffe6b938a86d82c870890cc13bfbbc57e83a5351c3.jpg", "img_caption": ["Figure 5: Qualitative results of ImageNet model with zero-shot text guidance. The images are randomly selected. "], "img_footnote": [], "page_idx": 9}, {"type": "image", "img_path": "Eu80DGuOcs/tmp/f62b8b90ec7a7add46f7ca59176fd57dbe66214cd20880474873078591126e3f.jpg", "img_caption": [], "img_footnote": [], "page_idx": 9}, {"type": "text", "text": "Figure 6: Qualitative results of human motion diffusion with zero-shot object avoidance and targeting guidance. Instances of intersection with obstacles are highlighted by marking the person in red. The trajectories are randomly selected. ", "page_idx": 9}, {"type": "text", "text": "References ", "text_level": 1, "page_idx": 10}, {"type": "text", "text": "[1] Anish Athalye, Logan Engstrom, Andrew Ilyas, and Kevin Kwok. Synthesizing robust adversarial examples. In International conference on machine learning, pp. 284\u2013293. PMLR, 2018.   \n[2] Arpit Bansal, Hong-Min Chu, Avi Schwarzschild, Soumyadip Sengupta, Micah Goldblum, Jonas Geiping, and Tom Goldstein. Universal guidance for diffusion models. In Proceedings of the IEEE/CVF Conference on Computer Vision and Pattern Recognition, pp. 843\u2013852, 2023. [3] Tim Brooks, Bill Peebles, Connor Homes, Will DePue, Yufei Guo, Li Jing, David Schnurr, Joe Taylor, Troy Luhman, Eric Luhman, Clarence Ng, Ricky Wang, and Aditya Ramesh. Video generation models as world simulators. 2024. URL https://openai.com/research/ video-generation-models-as-world-simulators.   \n[4] Anirban Chakraborty, Manaar Alam, Vishal Dey, Anupam Chattopadhyay, and Debdeep Mukhopadhyay. Adversarial attacks and defences: A survey. arXiv preprint arXiv:1810.00069, 2018.   \n[5] Yixuan Chen, Yubin Shi, Mingzhi Dong, Xiaochen Yang, Dongsheng Li, Yujiang Wang, Robert Dick, Qin Lv, Yingying Zhao, Fan Yang, et al. Over-parameterized model optimization with polyak-\u0142ojasiewicz condition. 2023. [6] Hyungjin Chung, Jeongsol Kim, Michael T Mccann, Marc L Klasky, and Jong Chul Ye. Diffusion posterior sampling for general noisy inverse problems. arXiv preprint arXiv:2209.14687, 2022.   \n[7] Hyungjin Chung, Byeongsu Sim, Dohoon Ryu, and Jong Chul Ye. Improving diffusion models for inverse problems using manifold constraints. Advances in Neural Information Processing Systems, 35: 25683\u201325696, 2022.   \n[8] Prafulla Dhariwal and Alexander Nichol. Diffusion models beat gans on image synthesis. Advances in neural information processing systems, 34:8780\u20138794, 2021.   \n[9] Yinpeng Dong, Fangzhou Liao, Tianyu Pang, Hang Su, Jun Zhu, Xiaolin Hu, and Jianguo Li. Boosting adversarial attacks with momentum. In Proceedings of the IEEE conference on computer vision and pattern recognition, pp. 9185\u20139193, 2018.   \n[10] Bradley Efron. Tweedie\u2019s formula and selection bias. Journal of the American Statistical Association, 106 (496):1602\u20131614, 2011.   \n[11] Dave Epstein, Allan Jabri, Ben Poole, Alexei Efros, and Aleksander Holynski. Diffusion self-guidance for controllable image generation. Advances in Neural Information Processing Systems, 36, 2024.   \n[12] Hyojun Go, Yunsung Lee, Jin-Young Kim, Seunghyun Lee, Myeongho Jeong, Hyun Seung Lee, and Seungtaek Choi. Towards practical plug-and-play diffusion models. In Proceedings of the IEEE/CVF conference on computer vision and pattern recognition, pp. 1962\u20131971, 2023.   \n[13] Ian J Goodfellow, Jonathon Shlens, and Christian Szegedy. Explaining and harnessing adversarial examples. arXiv preprint arXiv:1412.6572, 2014.   \n[14] Xu Han, Caihua Shan, Yifei Shen, Can Xu, Han Yang, Xiang Li, and Dongsheng Li. Training-free multi-objective diffusion model for 3d molecule generation. In The Twelfth International Conference on Learning Representations, 2023.   \n[15] Elad Hazan and Sham Kakade. Revisiting the polyak step size. arXiv preprint arXiv:1905.00313, 2019.   \n[16] Yutong He, Naoki Murata, Chieh-Hsin Lai, Yuhta Takida, Toshimitsu Uesaka, Dongjun Kim, Wei-Hsiang Liao, Yuki Mitsufuji, J Zico Kolter, Ruslan Salakhutdinov, et al. Manifold preserving guided diffusion. arXiv preprint arXiv:2311.16424, 2023.   \n[17] Amir Hertz, Ron Mokady, Jay Tenenbaum, Kfir Aberman, Yael Pritch, and Daniel Cohen-Or. Prompt-toprompt image editing with cross attention control. arXiv preprint arXiv:2208.01626, 2022.   \n[18] Jonathan Ho and Tim Salimans. Classifier-free diffusion guidance. arXiv preprint arXiv:2207.12598, 2022.   \n[19] Jonathan Ho, Ajay Jain, and Pieter Abbeel. Denoising diffusion probabilistic models. Advances in neural information processing systems, 33:6840\u20136851, 2020.   \n[20] Emiel Hoogeboom, V\u0131ctor Garcia Satorras, Cl\u00e9ment Vignac, and Max Welling. Equivariant diffusion for molecule generation in 3d. In International conference on machine learning, pp. 8867\u20138887. PMLR, 2022.   \n[21] Michael Janner, Yilun Du, Joshua Tenenbaum, and Sergey Levine. Planning with diffusion for flexible behavior synthesis. In International Conference on Machine Learning, pp. 9902\u20139915. PMLR, 2022.   \n[22] Hamed Karimi, Julie Nutini, and Mark Schmidt. Linear convergence of gradient and proximal-gradient methods under the polyak-\u0142ojasiewicz condition. In Machine Learning and Knowledge Discovery in Databases: European Conference, ECML PKDD 2016, Riva del Garda, Italy, September 19-23, 2016, Proceedings, Part I 16, pp. 795\u2013811. Springer, 2016.   \n[23] Zhixuan Liang, Yao Mu, Mingyu Ding, Fei Ni, Masayoshi Tomizuka, and Ping Luo. Adaptdiffuser: Diffusion models as adaptive self-evolving planners. arXiv preprint arXiv:2302.01877, 2023.   \n[24] Xihui Liu, Dong Huk Park, Samaneh Azadi, Gong Zhang, Arman Chopikyan, Yuxiao Hu, Humphrey Shi, Anna Rohrbach, and Trevor Darrell. More control for free! image synthesis with semantic diffusion guidance. In Proceedings of the IEEE/CVF Winter Conference on Applications of Computer Vision, pp. 289\u2013299, 2023.   \n[25] Xingchao Liu, Chengyue Gong, Lemeng Wu, Shujian Zhang, Hao Su, and Qiang Liu. Fusedream: Training-free text-to-image generation with improved clip $^+$ gan space optimization. arXiv preprint arXiv:2112.01573, 2021.   \n[26] Cheng Lu, Yuhao Zhou, Fan Bao, Jianfei Chen, Chongxuan Li, and Jun Zhu. Dpm-solver: A fast ode solver for diffusion probabilistic model sampling in around 10 steps. Advances in Neural Information Processing Systems, 35:5775\u20135787, 2022.   \n[27] Cheng Lu, Huayu Chen, Jianfei Chen, Hang Su, Chongxuan Li, and Jun Zhu. Contrastive energy prediction for exact energy-guided diffusion sampling in offline reinforcement learning. arXiv preprint arXiv:2304.12824, 2023.   \n[28] Andreas Lugmayr, Martin Danelljan, Andres Romero, Fisher Yu, Radu Timofte, and Luc Van Gool. Repaint: Inpainting using denoising diffusion probabilistic models. In Proceedings of the IEEE/CVF Conference on Computer Vision and Pattern Recognition, pp. 11461\u201311471, 2022.   \n[29] Aleksander Madry, Aleksandar Makelov, Ludwig Schmidt, Dimitris Tsipras, and Adrian Vladu. Towards deep learning models resistant to adversarial attacks. arXiv preprint arXiv:1706.06083, 2017.   \n[30] Sicheng Mo, Fangzhou Mu, Kuan Heng Lin, Yanli Liu, Bochen Guan, Yin Li, and Bolei Zhou. Freecontrol: Training-free spatial control of any text-to-image diffusion model with any condition. arXiv preprint arXiv:2312.07536, 2023.   \n[31] Jiachun Pan, Jun Hao Liew, Vincent YF Tan, Jiashi Feng, and Hanshu Yan. Adjointdpm: Adjoint sensitivity method for gradient backpropagation of diffusion probabilistic models. arXiv preprint arXiv:2307.10711, 2023.   \n[32] Alec Radford, Jong Wook Kim, Chris Hallacy, Aditya Ramesh, Gabriel Goh, Sandhini Agarwal, Girish Sastry, Amanda Askell, Pamela Mishkin, Jack Clark, et al. Learning transferable visual models from natural language supervision. In International conference on machine learning, pp. 8748\u20138763. PMLR, 2021.   \n[33] Robin Rombach, Andreas Blattmann, Dominik Lorenz, Patrick Esser, and Bj\u00f6rn Ommer. High-resolution image synthesis with latent diffusion models. In Proceedings of the IEEE/CVF conference on computer vision and pattern recognition, pp. 10684\u201310695, 2022.   \n[34] Hadi Salman, Jerry Li, Ilya Razenshteyn, Pengchuan Zhang, Huan Zhang, Sebastien Bubeck, and Greg Yang. Provably robust deep learning via adversarially trained smoothed classifiers. Advances in Neural Information Processing Systems, 32, 2019.   \n[35] Hadi Salman, Andrew Ilyas, Logan Engstrom, Ashish Kapoor, and Aleksander Madry. Do adversarially robust imagenet models transfer better? Advances in Neural Information Processing Systems, 33:3533\u2013 3545, 2020.   \n[36] Jiaming Song, Chenlin Meng, and Stefano Ermon. Denoising diffusion implicit models. arXiv preprint arXiv:2010.02502, 2020.   \n[37] Jiaming Song, Qinsheng Zhang, Hongxu Yin, Morteza Mardani, Ming-Yu Liu, Jan Kautz, Yongxin Chen, and Arash Vahdat. Loss-guided diffusion models for plug-and-play controllable generation. 2023.   \n[38] Christian Szegedy, Wojciech Zaremba, Ilya Sutskever, Joan Bruna, Dumitru Erhan, Ian Goodfellow, and Rob Fergus. Intriguing properties of neural networks. arXiv preprint arXiv:1312.6199, 2013.   \n[39] Guy Tevet, Brian Gordon, Amir Hertz, Amit H Bermano, and Daniel Cohen-Or. Motionclip: Exposing human motion generation to clip space. In European Conference on Computer Vision, pp. 358\u2013374. Springer, 2022.   \n[40] Guy Tevet, Sigal Raab, Brian Gordon, Yonatan Shafir, Daniel Cohen-Or, and Amit H Bermano. Human motion diffusion model. arXiv preprint arXiv:2209.14916, 2022.   \n[41] Shengbang Tong, Erik Jones, and Jacob Steinhardt. Mass-producing failures of multimodal systems with language models. Advances in Neural Information Processing Systems, 36, 2024.   \n[42] Narek Tumanyan, Michal Geyer, Shai Bagon, and Tali Dekel. Plug-and-play diffusion features for textdriven image-to-image translation. In Proceedings of the IEEE/CVF Conference on Computer Vision and Pattern Recognition, pp. 1921\u20131930, 2023.   \n[43] Roman Vershynin. High-dimensional probability: An introduction with applications in data science, volume 47. Cambridge university press, 2018.   \n[44] Wei Wang, Dongqi Han, Xufang Luo, Yifei Shen, Charles Ling, Boyu Wang, and Dongsheng Li. Toward open-ended embodied tasks solving. In NeurIPS 2023 Agent Learning in Open-Endedness Workshop, 2023.   \n[45] Xiaoyu Xiang, Ding Liu, Xiao Yang, Yiheng Zhu, Xiaohui Shen, and Jan P Allebach. Adversarial open domain adaptation for sketch-to-photo synthesis. In Proceedings of the IEEE/CVF Winter Conference on Applications of Computer Vision, 2022.   \n[46] Yilun Xu, Mingyang Deng, Xiang Cheng, Yonglong Tian, Ziming Liu, and Tommi Jaakkola. Restart sampling for improving generative processes. Advances in Neural Information Processing Systems, 36, 2024.   \n[47] Lingxiao Yang, Shutong Ding, Yifan Cai, Jingyi Yu, Jingya Wang, and Ye Shi. Guidance with spherical gaussian constraint for conditional diffusion. arXiv preprint arXiv:2402.03201, 2024.   \n[48] Changqian Yu, Jingbo Wang, Chao Peng, Changxin Gao, Gang Yu, and Nong Sang. Bisenet: Bilateral segmentation network for real-time semantic segmentation. In Proceedings of the European conference on computer vision (ECCV), pp. 325\u2013341, 2018.   \n[49] Jiwen Yu, Yinhuai Wang, Chen Zhao, Bernard Ghanem, and Jian Zhang. Freedom: Training-free energyguided conditional diffusion model. arXiv preprint arXiv:2303.09833, 2023.   \n[50] Lvmin Zhang, Anyi Rao, and Maneesh Agrawala. Adding conditional control to text-to-image diffusion models. In Proceedings of the IEEE/CVF International Conference on Computer Vision, pp. 3836\u20133847, 2023.   \n[51] Shengyu Zhao, Zhijian Liu, Ji Lin, Jun-Yan Zhu, and Song Han. Differentiable augmentation for dataefficient gan training. Advances in neural information processing systems, 33:7559\u20137570, 2020.   \n[52] Shuxin Zheng, Jiyan He, Chang Liu, Yu Shi, Ziheng Lu, Weitao Feng, Fusong Ju, Jiaxi Wang, Jianwei Zhu, Yaosen Min, et al. Towards predicting equilibrium distributions for molecular systems with deep learning. arXiv preprint arXiv:2306.05445, 2023. ", "page_idx": 10}, {"type": "text", "text": "", "page_idx": 11}, {"type": "text", "text": "", "page_idx": 12}, {"type": "text", "text": "A Related Works ", "text_level": 1, "page_idx": 13}, {"type": "text", "text": "A.1 Training-based Gradient Guidance ", "text_level": 1, "page_idx": 13}, {"type": "text", "text": "The training-based gradient guidance paradigm, such as classifier guidance, is a predominant approach for diffusion guidance. The core objective is to train a time-dependent network that approximates $p_{t}(\\pmb{y}|\\pmb{x}_{t})$ in the RHS of (2), and to utilize the resulting gradient as guidance. The most well-known example is classifier guidance, which involves training a classifier on noisy images. However, classifier guidance is limited to class conditions and is not adaptable to other forms of control, such as image and text guidance. To address this limitation, there are two main paradigms. The first involves training a time-dependent network that aligns features extracted from both clean and noisy images, as described by [24]. The training process is outlined as follows: ", "page_idx": 13}, {"type": "equation", "text": "$$\n\\operatorname*{min}_{\\psi}\\quad\\mathbb{E}_{p(\\mathbf{x}_{0},\\mathbf{x}_{t})}d(f_{\\psi}(\\mathbf{x}_{t},t),f_{\\phi}(\\mathbf{x}_{0})),\n$$", "text_format": "latex", "page_idx": 13}, {"type": "text", "text": "where $d(\\cdot,\\cdot)$ represents a loss function, such as cross-entropy or the $\\ell_{2}$ norm. If time-dependent networks for clean images are already available, training can proceed in a self-supervised fashion without the need for labeled data. The second paradigm, as outlined by [21], involves training an energy-based model to approximate $p_{t}(\\pmb{y}|\\pmb{x}_{t})$ . The training process is described as follows: ", "page_idx": 13}, {"type": "equation", "text": "$$\n\\operatorname*{min}_{\\psi}\\quad\\mathbb{E}_{p(\\mathbf{x}_{0},\\mathbf{x}_{t})}|\\ell(f_{\\psi}(\\mathbf{x}_{t},t),\\pmb{y})-\\ell(f_{\\phi}(\\mathbf{x}_{0}),\\pmb{y})|.\n$$", "text_format": "latex", "page_idx": 13}, {"type": "text", "text": "However, it is observed in [27] that none of these methods can accurately approximate the true energy in (4). The authors of [27] propose an algorithm to learn the true energy. The loss function is a contrastive loss ", "page_idx": 13}, {"type": "equation", "text": "$$\n\\operatorname*{min}_{\\psi}\\quad\\mathbb{E}_{p(x_{0}^{i},x_{t}^{i})}\\exp(-\\ell(f_{\\phi}(x_{0}),y))\\left[-\\sum_{i=1}^{K}\\log\\frac{\\exp(\\ell(f_{\\psi}(x_{t}^{i},t),y^{i})}{\\sum_{j=1}^{K}\\exp(-\\ell(f_{\\psi}(x_{t}^{i},t),y^{i}))}\\right],\n$$", "text_format": "latex", "page_idx": 13}, {"type": "text", "text": "where $(x_{0}^{i},x_{t}^{i})$ are $K$ paired data samples from $p(\\pmb{x}_{0}^{i},\\pmb{y}^{i})$ . Theorem 3.2 in [27] proves that the optimal $f_{\\psi^{*}}$ satisfied that $\\nabla_{\\mathbf{x}_{t}}\\ell(f_{\\psi^{*}}(\\mathbf{x}_{t}^{i},t),\\pmb{y}^{i})=\\mathbf{\\widetilde{\\nabla}}\\forall_{\\mathbf{x}_{t}}\\mathcal{p}_{t}(\\pmb{y}|\\pmb{x}_{t})$ . ", "page_idx": 13}, {"type": "text", "text": "Although this paper focuses on training-free guidance, the findings in this paper can be naturally extended to all training-based gradient guidance schemes. Firstly, the issue of adversarial gradients cannot be resolved without additional training; hence, all the aforementioned methods are subject to adversarial gradients. Empirical evidence for this is presented in Fig. 2, which illustrates that the gradients from an adversarially robust classifier are markedly more vivid than those from timedependent classifiers. Consequently, it is anticipated that incorporating additional adversarial training into these methods would enhance the quality of the generated samples. Secondly, since these methods are dependent on gradients, employing a more sophisticated gradient solver could further improve their NFEs. ", "page_idx": 13}, {"type": "text", "text": "A.2 Adversarial Attack and Robustness ", "text_level": 1, "page_idx": 13}, {"type": "text", "text": "Adversarial attacks and robustness constitute a fundamental topic in deep learning [4]. An adversarial attack introduces minimal, yet strategically calculated, changes to the original data that are often imperceptible to humans, leading models to make incorrect predictions. The most common attacks are gradient-based, for example, the Fast Gradient Sign Method (FGSM) [13], Projected Gradient Descent (PGD) [29], Smoothed Gradient Attacks [1], and Momentum-Based Attacks [9]. An attack is akin to classifier guidance or training-free guidance, which uses the gradient of a pre-trained network for guidance. Should the gradient be adversarial, the guidance will be compromised. This paper establishes the relationship between training-free loss-guided diffusion models and adversarial attacks in two ways. Firstly, we prove that training-free guidance is more sensitive to an adversarial gradient. Secondly, in Section 4.2, we demonstrate that borrowing an adaptive gradient scheduler can improve convergence. The optimizers from adversarial attack literature may also expedite the convergence of the diffusion ODE. ", "page_idx": 13}, {"type": "text", "text": "B Baselines and Experimental Settings ", "text_level": 1, "page_idx": 13}, {"type": "text", "text": "B.1 Details of the Baselines ", "text_level": 1, "page_idx": 13}, {"type": "text", "text": "We use the following training-free diffusion guidance methods as baselines for comparison: ", "page_idx": 13}, {"type": "text", "text": "\u2022 Universal Guidance (UG) [2] employs guidance as delineated in (5) and uses time-travel strategies outlined in Algorithm 3 to enhance performance. The time-travel trick is used for all time steps $t$ . UG also utilizes backward guidance, which takes multiple gradient steps at each time step.   \n\u2022 FreeDoM [49] is also founded on (5) and time-travel trick. In addition, FreeDoM incorporates a time-dependent step size for each gradient guidance and judiciously selects the diffusion step for executing time-travel trick.   \n\u2022 Loss-guided Diffusion with Monte Corlo (LGD-MC) [37] utilizes guidance from (6) and we set $n=10$ in the experiments.   \n\u2022 Manifold Guided Preserving Diffusion (MPGD) [16] takes the derivative with respect to estimated clean image $\\mathbb{E}[{\\pmb x}_{0}|{\\pmb x}_{t}]$ instead of $\\pmb{x}_{t}$ . Let $\\pmb{x}_{0\\mid t}=\\mathbb{E}[\\pmb{x}_{0}|\\pmb{x}_{t}]$ , MPGD steps are expressed as following: ", "page_idx": 14}, {"type": "equation", "text": "$$\n\\begin{array}{r}{\\nabla_{x_{t}}\\log{p_{t}(y|x_{t})}:=-\\sqrt{\\alpha_{t-1}}\\nabla_{x_{0\\mid t}}\\log\\left[\\exp(-\\ell(f_{\\phi}(x_{0\\mid t}),y)\\right].}\\end{array}\n$$", "text_format": "latex", "page_idx": 14}, {"type": "text", "text": "MPGD-Z adopts an additional auto-encoder to preserve manifold constraints. The details procedures of MPGD-Z are described in Algorithm 3 of [16]. ", "page_idx": 14}, {"type": "text", "text": "B.2 MPGD for Motion Diffusion ", "text_level": 1, "page_idx": 14}, {"type": "text", "text": "For the process of motion diffusion, the application of both MPGD-Z and MPGD-AE is precluded due to the absence of pretrained auto-encoders specific to motion diffusion. An implementation of MPGD without projection (MPGD w/o proj) was attempted for motion diffusion; however, it was unsuccessful in accurately navigating towards the target. This failure is attributed to the presence of spurious correlations within the targeting loss specific to MPGD, a phenomenon not observed in the other baseline methodologies. Sepcifically, the gradient formulation in MPGD is detailed as follows: ", "page_idx": 14}, {"type": "equation", "text": "$$\n\\mathrm{grad\\_MPGD}=\\left\\{\\!\\!\\begin{array}{l l}{2({\\pmb y}_{\\mathrm{target}}-{\\pmb x}_{0\\mid t})}&{\\mathrm{if}\\ t==T}\\\\ {0}&{\\mathrm{otherwise}}\\end{array}\\!\\!\\right.\n$$", "text_format": "latex", "page_idx": 14}, {"type": "text", "text": "The gradient in FreeDoM and other methods is given by ", "page_idx": 14}, {"type": "equation", "text": "$$\n\\mathrm{grad\\_DPS}=2(y_{\\mathrm{target}}-x_{0\\mid t})\\cdot\\frac{I+\\sigma_{t}^{2}\\nabla^{2}\\log p_{t}(\\pmb{x}_{t})}{\\sqrt{\\alpha_{t}}}.\n$$", "text_format": "latex", "page_idx": 14}, {"type": "text", "text": "Analysis of the aforementioned equations reveals that, within the MPGD framework, only the final motion step is influenced by the gradient, a characteristic not shared by alternative methodologies. Consequently, this exclusive focus on the last step results in disproportionately strong guidance at this juncture, while earlier steps suffer from a lack of directional input. This imbalance may adversely affect the overall quality of the samples produced. Empirical observations substantiate that MPGD struggles to achieve targeted outcomes when a nuanced adjustment of step size is required. Given these limitations, MPGD has been excluded from the comparative analysis presented in Table 3. ", "page_idx": 14}, {"type": "text", "text": "B.3 Prompts for Motion Diffusion ", "text_level": 1, "page_idx": 14}, {"type": "text", "text": "We follow the prompts and evaluation settings in [37]. The prompts are (i) \u201cthe person is walking backwards\u201d; (ii) \u201ca person walking around in a balance beam\u201d; (iii) \u201cthe person is walking\u201d; (iv) \u201cthe person is jogging\u201d. We consider three different directions for each prompt, and each direction has 10 random seeds, the metrics are then averaged together over the 30 synthesized motions. ", "page_idx": 14}, {"type": "text", "text": "C More Discussions ", "text_level": 1, "page_idx": 14}, {"type": "text", "text": "C.1 Concentration of Estimated Clean Samples ", "text_level": 1, "page_idx": 14}, {"type": "text", "text": "It has been demonstrated in [7] that, given a fixed $\\pmb{x}_{0}$ , the distribution of the noisy data $\\pmb{x}_{t}$ is concentrated on a spherical shell. An extension of this theorem presented in the \u201cHigh Dimensional Probability\u201d textbook by Vershynin [43] elucidates that the conditional distribution $q(\\pmb{x}_{0}|\\pmb{x}_{t})$ also exhibits concentration on a spherical shell, provided that its coordinates are sub-Gaussian. ", "page_idx": 14}, {"type": "text", "text": "Theorem C.1. (Theorem 3.1.1 in [43]) Denote $\\pmb{x}_{0}=\\pmb{x}_{t}+\\pmb{g}\\in\\mathbb{R}^{n}$ , where $g=(g_{1},\\cdot\\cdot\\cdot,g_{n})$ . Assume that $g_{i}$ are independent identically distributed, $\\begin{array}{r}{\\mathbb{E}[g_{i}^{2}]=\\frac{r_{t}^{2}}{n}}\\end{array}$ and there exists constant $c_{1}$ such that $\\mathbb{P}[g_{i}\\geq t]\\leq\\exp(-c_{1}t^{2}),$ , then we have ", "page_idx": 15}, {"type": "equation", "text": "$$\n\\mathbb{P}[\\lvert\\lvert\\pmb{x}_{t}-\\pmb{x}_{0}\\rvert\\rvert_{2}^{2}-r_{t}^{2}\\rvert\\ge t]\\le\\exp(-c_{2}n t^{2}),\n$$", "text_format": "latex", "page_idx": 15}, {"type": "text", "text": "where $c_{2}$ is a constant. ", "page_idx": 15}, {"type": "text", "text": "Theorem C.1 establishes that the distribution $q(\\pmb{x}_{0}|\\pmb{x}_{t})$ exhibits concentration on a spherical shell at an exponential rate. For high-dimensional data, such as images, it is reasonable to infer that $\\pmb{x}_{0}$ is predominantly situated on this spherical shell. ", "page_idx": 15}, {"type": "text", "text": "C.2 Time-travel Trick ", "text_level": 1, "page_idx": 15}, {"type": "table", "img_path": "Eu80DGuOcs/tmp/ab2b5a1cd279469cae31d9aeda9003787e0cc41c70fde581a6311d2b0d4da8ac.jpg", "table_caption": [], "table_footnote": [], "page_idx": 15}, {"type": "text", "text": "The technique of time-travel, also referred to as \u201cresampling\u201d, has been proposed as a solution to complex generative problems [28], facilitating successful training-free guidance in tasks such as CLIP-guided ImageNet generation and layout guidance for stable diffusion, as illustrated in Figure 2 of [49] and Figure 8 of [2], respectively. The procedure of the time-travel trick is shown in Algorithm 3, which involves recursive execution of individual sampling steps. ", "page_idx": 15}, {"type": "text", "text": "C.3 More Quantitative Experiments ", "text_level": 1, "page_idx": 15}, {"type": "text", "text": "Two-stage convergence: We plot the convergence curve of more images in Figure 5. The diffusion model is ImageNet diffusion and the guidance network is ResNet-50. The convergence is two-stage: the objective value oscillates when t is large, followed by a swift decrease, which verifies Proposition 3.1. ", "page_idx": 15}, {"type": "image", "img_path": "Eu80DGuOcs/tmp/dd8071e21a0ea5d5ec6366bf74c7c451b1b300a1544c3a0299ba68cf0c99013e.jpg", "img_caption": ["Figure 7: More experiments of the convergence plot. "], "img_footnote": [], "page_idx": 15}, {"type": "text", "text": "Misaligned gradients: For quantitative experiments, we use robust ResNet-50 to assess the presence of misaligned gradient. Since ResNet-50 serves as our guidance network, a large loss gap between the standard ResNet-50 and the robust variant indicates a severe adversarial gradient issue. In Table 4, the values represent the loss value. The columns denote the guidance network type, while the rows indicate the loss tested on either ResNet-50 or Robust ResNet-50. The values reported are the average over 1000 images, providing a quantitative evaluation. When using ResNet-50 for guidance, its loss on ResNet-50 is as low as that of real images from the same class (value 5.91). However, the loss for Robust ResNet-50 is significantly higher (value 6.17), suggesting susceptibility to misaligned gradients. By employing ResNet-50 with random augmentation for guidance, we observe a marked reduction in this gap (from 5.91 to 5.98), underscoring the effectiveness of our proposed method. ", "page_idx": 15}, {"type": "text", "text": "", "page_idx": 16}, {"type": "text", "text": "Slower Convergence: Table 5 aims to compare the convergence of training-free guidance with training-based guidance, specifically PPAP [12]. Given that classifier guidance presents a simple scenario and all methods converge relatively fast, it tends to obscure the observations. Consequently, we have directed our attention towards the more complex task of segmentation map guidance in Table 1. The columns in Table 5 list different methods, while the rows indicate the sampling steps. The values represent the \u201cdistance\u201d mentioned in Table 1 and are averaged over 1000 images under the same conditions as those in Table 1. Our observations reveal a significant discrepancy in the objective values between the training-free FreeDoM and the training-based PPAP [12], particularly at a lower number of steps (20 or 50 steps), which indicates slower convergence. However, when we incorporate the Polyak step size into FreeDoM, this convergence issue is substantially mitigated. ", "page_idx": 16}, {"type": "table", "img_path": "Eu80DGuOcs/tmp/9349409867b5e0a8ddcf8b18b5dfab4f773a7924c6231b36672ed733e4983cf3.jpg", "table_caption": [], "table_footnote": [], "page_idx": 16}, {"type": "text", "text": "Table 4: Quantitative experiments for the adversarial gradient. RN-50 stands for ResNet-50 and RA stands for random augmentation trick. Robust RN-50 is adversarial robust ResNet-50 from [35]. The columns represent different guidance networks. ", "page_idx": 16}, {"type": "table", "img_path": "Eu80DGuOcs/tmp/3f26ea5107f3b1bbe53e72158a7f2cf7ccb8244a22a04b0ebae67ee070256da9.jpg", "table_caption": ["Table 5: Quantitative experiments for the slower convergence. P stands for Polyak step size. The experimental setting follows the segmentation map guidance of Table 1. "], "table_footnote": [], "page_idx": 16}, {"type": "text", "text": "C.4 Efficiency of Random Augmentation ", "text_level": 1, "page_idx": 16}, {"type": "text", "text": "Given the multiple invocations of the guidance network necessitated by random augmentation (RA), concerns regarding the efficiency of this approach are understandable. However, it is important to note that, compared to the diffusion backbone, the guidance network exhibits a more lightweight architecture, thereby mitigating any significant increase in computational demand. To empirically illustrate this point, we present the computation times associated with varying degrees of augmentation in Table 6. In the conducted experiments, we set the cardinality of the set $\\tau$ to 10, thereby having little impact on the inference time. These experiments were conducted on a single NVIDIA A100 GPU. ", "page_idx": 16}, {"type": "equation", "text": "$$\n\\frac{\\mathrm{Setting~\\quad~|~\\,w/o~RA~|~\\,|\\,}\\,|\\,|\\mathcal{T}|=1\\ |\\ |\\mathcal{T}|=10\\ |\\ |\\mathcal{T}|=20\\ |\\ |\\mathcal{T}|=30}{\\mathrm{CLIP}\\:\\mathrm{Score}\\ |\\quad0.541\\ |\\ \\ |\\ \\ 0.544\\ \\ |\\ \\ \\ 0.571\\ \\ \\ |\\ \\ \\ 0.592\\ \\ |\\ \\ \\ \\ 0.625}\n$$", "text_format": "latex", "page_idx": 16}, {"type": "text", "text": "Table 6: Inference time (seconds per diffusion step) of different random augmentation configurations.   \nThe diffusion backbone is ImageNet diffusion and the guidance network is CLIP-B/16. ", "page_idx": 16}, {"type": "text", "text": "D Proofs ", "text_level": 1, "page_idx": 17}, {"type": "text", "text": "D.1 Definitions ", "text_level": 1, "page_idx": 17}, {"type": "text", "text": "This subsection introduces a few definitions that are useful in the following sections. ", "page_idx": 17}, {"type": "text", "text": "Definition D.1. ( $L$ -Lipschitz) A function $f:\\mathbb{R}^{n}\\rightarrow\\mathbb{R}^{m}$ is said to be $L$ -Lipschitz if there exists a constant $L\\geq0$ such that $\\|f(\\pmb{x}_{2})-f(\\pmb{x}_{1})\\|\\le L\\|\\pmb{x}_{2}-\\pmb{x}_{1}\\|$ for all $\\pmb{x}_{1},\\pmb{x}_{2}\\in\\mathbb{R}^{n}$ . ", "page_idx": 17}, {"type": "text", "text": "Definition D.2. $\\mathrm{PL}$ condition) A function $f:\\mathbb{R}^{n}\\rightarrow\\mathbb{R}$ satisfies PL condition with parameter $\\mu$ if $\\|\\nabla f(\\mathbf{x})\\|^{2}\\geq\\mu f(\\mathbf{x})$ . ", "page_idx": 17}, {"type": "text", "text": "D.2 Proof for Proposition 3.1 ", "text_level": 1, "page_idx": 17}, {"type": "text", "text": "Denote $\\hat{\\pmb{x}}_{0}=\\mathbb{E}_{p(\\pmb{x}_{0}|\\pmb{x}_{t})}(\\pmb{x}_{0})$ , the gradient guidance term in (5) can be written as the following: ", "page_idx": 17}, {"type": "equation", "text": "$$\n\\nabla_{\\mathbf{x}_{t}}\\ell\\left[f_{\\phi}(\\hat{\\mathbf{x}}_{0}),y\\right]=\\frac{\\partial\\ell}{\\partial\\hat{x}_{0}}\\nabla_{\\mathbf{x}_{t}}\\left(\\frac{{\\boldsymbol{x}}_{t}+\\sigma_{t}^{2}\\nabla_{x_{t}}\\log p_{t}({\\boldsymbol{x}}_{t})}{\\sqrt{\\alpha_{t}}}\\right)=\\frac{\\partial\\ell}{\\partial\\hat{x}_{0}}\\frac{\\mathrm{Cov}[\\mathbf{x}_{0}|{\\boldsymbol{x}}_{t}]}{\\sigma_{t}^{2}\\sqrt{\\alpha_{t}}},\n$$", "text_format": "latex", "page_idx": 17}, {"type": "text", "text": "where the last equality follows the variance of Tweedie\u2019s formula $\\operatorname{Cov}[{\\pmb x}_{0}|{\\pmb x}_{t}]~~=~~\\sigma_{t}^{2}({\\pmb I}+$ $\\sigma_{t}^{2}\\nabla^{2}\\log p_{t}(\\mathbf{x}_{t})\\big)$ [10]. ", "page_idx": 17}, {"type": "text", "text": "For the first condition, the Lipschitz constant satisfies ", "page_idx": 17}, {"type": "equation", "text": "$$\n\\begin{array}{r l}&{|\\ell_{t}(x_{1})-\\ell_{t}(x_{2})|\\leq\\displaystyle\\frac{L_{f}}{\\sqrt{\\alpha_{t}}}\\|x_{1}-\\nabla_{x_{1}}\\log p_{t}(x_{1})-x_{2}+\\nabla_{x_{t}}\\log p_{t}(x_{2})\\|}\\\\ &{\\qquad\\qquad\\qquad\\leq\\displaystyle\\frac{L_{f}(1+L_{p})}{\\sqrt{\\alpha_{t}}}\\|x_{1}-x_{2}\\|,}\\end{array}\n$$", "text_format": "latex", "page_idx": 17}, {"type": "text", "text": "and the $\\mathrm{PL}$ constant satisfies ", "page_idx": 17}, {"type": "equation", "text": "$$\n\\ell_{t}(\\pmb{x}_{t})\\leq\\frac{1}{\\mu}\\left\\|\\frac{\\partial\\ell}{\\partial\\hat{\\pmb{x}}_{0}}\\right\\|^{2}=\\frac{1}{\\mu}\\|\\nabla_{\\pmb{x}_{t}}\\ell\\cdot\\mathrm{Cov}^{-1}(\\pmb{x}_{0}|\\pmb{x}_{t})\\sigma_{t}^{2}\\sqrt{\\alpha_{t}}\\|^{2}\\leq\\frac{\\sigma_{t}^{4}\\alpha_{t}}{\\mu\\lambda_{m i n}^{2}}\\|\\nabla_{\\pmb{x}_{t}}\\ell\\|^{2}.\n$$", "text_format": "latex", "page_idx": 17}, {"type": "text", "text": "The second and third conditions directly follow Lemma D.3. ", "page_idx": 17}, {"type": "text", "text": "Lemma D.3. (Linear Convergence Under PL condition; $[22J)$ Denote $x^{0}$ as the initial point and $\\pmb{x}^{t}$ as the point after $t$ gradient steps. If the function is $L$ -Lipschitz and $\\mu{-}P L,$ , gradient descent with $a$ step size $\\begin{array}{r}{\\eta=\\frac{1}{L}}\\end{array}$ converges to a global solution with $\\ell({\\pmb x}^{t})\\leq(1-\\mu/\\dot{L})^{t}\\ell({\\pmb x}^{0})$ . ", "page_idx": 17}, {"type": "text", "text": "D.3 Proof for Proposition 3.2 ", "text_level": 1, "page_idx": 17}, {"type": "text", "text": "Proof. The proof of this theorem is based on the proof of Lemma 1 in [34]. By the definition of expectation, we have ", "page_idx": 17}, {"type": "equation", "text": "$$\n\\begin{array}{r l}&{\\hat{f}(\\pmb{x})=\\mathbb{E}_{\\pmb{\\epsilon}\\sim\\mathcal{N}(0,\\pmb{I})}[f(\\pmb{x}+\\sigma_{t}\\pmb{\\epsilon})]=\\big(f\\circledast\\mathcal{N}(0,\\sigma_{t}^{2}\\pmb{I})\\big)(\\pmb{x})}\\\\ &{\\quad\\quad\\quad=\\cfrac{1}{(2\\pi\\sigma_{t}^{2})^{n/2}}\\displaystyle\\int_{\\mathbb{R}^{n}}f(\\pmb{z})\\exp\\left(-\\cfrac{1}{2\\sigma_{t}^{2}}\\lVert\\pmb{x}-\\pmb{z}\\rVert^{2}\\right)\\mathrm{d}\\pmb{z}.}\\end{array}\n$$", "text_format": "latex", "page_idx": 17}, {"type": "text", "text": "We then show that for any unit direction $\\begin{array}{r}{u,u^{T}\\nabla\\hat{f}(x)\\le\\sqrt{\\frac{2}{\\pi\\sigma_{t}^{2}}}}\\end{array}$ . The derivative of $\\hat{f}$ is given by ", "page_idx": 17}, {"type": "equation", "text": "$$\n\\begin{array}{l}{\\displaystyle\\nabla\\hat{f}(\\pmb{x})=\\frac{1}{(2\\pi\\sigma_{t}^{2})^{n/2}}\\int_{\\mathbb{R}^{n}}f(\\pmb{z})\\nabla\\exp\\left(-\\frac{1}{2\\sigma_{t}^{2}}\\|\\pmb{x}-\\pmb{z}\\|^{2}\\right)\\mathrm{d}\\pmb{z}}\\\\ {\\displaystyle=\\frac{1}{(2\\pi\\sigma_{t}^{2})^{n/2}\\sigma_{t}^{2}}\\int_{\\mathbb{R}^{n}}f(\\pmb{z})(\\pmb{x}-\\pmb{z})\\exp\\left(-\\frac{1}{2\\sigma_{t}^{2}}\\|\\pmb{x}-\\pmb{z}\\|^{2}\\right)\\mathrm{d}\\pmb{z}.}\\end{array}\n$$", "text_format": "latex", "page_idx": 17}, {"type": "text", "text": "Thus, the Lipschitz constant is computed as ", "page_idx": 17}, {"type": "equation", "text": "$$\n\\begin{array}{r l}&{\\pmb{u}^{T}\\nabla\\hat{f}(\\pmb{x})\\leq\\frac{C}{(2\\pi\\sigma_{t}^{2})^{n/2}}\\displaystyle\\int_{\\mathbb{R}^{n}}|\\pmb{u}^{T}(\\pmb{x}-\\pmb{z})/\\sigma_{t}^{2}|\\exp\\left(-\\frac{1}{2\\sigma_{t}^{2}}\\|\\pmb{x}-\\pmb{z}\\|^{2}\\right)\\mathrm{d}\\pmb{z}}\\\\ &{\\quad\\quad\\quad=\\frac{C}{(2\\pi\\sigma_{t}^{2})^{1/2}}\\displaystyle\\int_{-\\infty}^{\\infty}|\\pmb{s}|\\exp\\left(-\\frac{1}{2}s^{2}\\right)\\mathrm{d}s=\\sqrt{\\frac{2}{\\pi\\sigma_{t}^{2}}}.}\\end{array}\n$$", "text_format": "latex", "page_idx": 17}, {"type": "text", "text": "Similarly, for the Lipschitz constant of the gradient, we have ", "page_idx": 18}, {"type": "equation", "text": "$$\n\\begin{array}{r l}&{\\|\\nabla^{2}\\hat{f}(x)\\|_{\\mathrm{op}}\\leq\\|\\nabla^{2}\\hat{f}(x)\\|_{2}}\\\\ &{\\leq\\displaystyle\\frac{C}{\\sqrt{2\\pi}\\sigma_{t}\\cdot\\sigma_{t}^{4}}\\left(\\displaystyle\\int_{-\\infty}^{\\infty}s^{2}\\exp(-\\frac{1}{2}s^{2}/\\sigma_{t}^{2})\\mathrm{d}s+\\displaystyle\\int_{-\\infty}^{\\infty}\\sigma_{t}^{2}\\exp(-\\frac{1}{2}s^{2}/\\sigma_{t}^{2})\\mathrm{d}s\\right)=\\frac{2C}{\\sigma_{t}}.}\\end{array}\n$$", "text_format": "latex", "page_idx": 18}, {"type": "text", "text": "D.4 Proof for Proposition 3.3 ", "text_level": 1, "page_idx": 18}, {"type": "text", "text": "Proof. We first analyze the discretization error of a single step from time $s$ to $t$ . We denote the update\u221a variable for DDIM is $\\boldsymbol{x}_{t}^{*}$ and the optimal solution of the diffusion ODE at time $t$ as $\\boldsymbol{x}_{t}^{*}$ . Let $\\bar{\\sigma_{t}}=\\sqrt{1-\\alpha_{t}}$ , $\\begin{array}{r}{\\lambda_{t}=\\frac{1}{2}\\log(\\frac{\\alpha_{t}^{\\Breve{\\mathbf{\\alpha}}}}{1-\\alpha_{t}})}\\end{array}$ and $h=\\lambda_{t}-\\lambda_{s}$ . According to (B.4) of [26], the update of DDIM solver is given by ", "page_idx": 18}, {"type": "equation", "text": "$$\n{\\pmb x}_{t}=\\sqrt{\\frac{\\alpha_{t}}{\\alpha_{s}}}{\\pmb x}_{s}-\\sigma_{t}(e^{h}-1)u({\\pmb x}_{s},s).\n$$", "text_format": "latex", "page_idx": 18}, {"type": "text", "text": "A similar relationship can be obtained for the optimal solution ", "page_idx": 18}, {"type": "equation", "text": "$$\n{\\pmb x}_{t}^{*}=\\sqrt{\\frac{\\alpha_{t}}{\\alpha_{s}}}{\\pmb x}_{s}^{*}-\\sigma_{t}(e^{h}-1)u({\\pmb x}_{s}^{*},s)+O(h^{2}).\n$$", "text_format": "latex", "page_idx": 18}, {"type": "text", "text": "We then bound the error between $\\pmb{x}_{t}$ and $\\boldsymbol{x}_{t}^{*}$ . We have ", "page_idx": 18}, {"type": "equation", "text": "$$\n\\begin{array}{r l}&{\\|x_{t}^{*}-x_{t}\\|\\leq\\sqrt{\\frac{\\alpha_{t}}{\\alpha_{s}}}\\|x_{s}^{*}-x_{s}\\|+\\sigma_{t}(e^{h}-1)\\|u(x_{s}^{*},s)-u(x_{s},s)\\|+O(h^{2})}\\\\ &{\\qquad\\qquad\\leq\\sqrt{\\frac{\\alpha_{t}}{\\alpha_{s}}}\\|x_{s}^{*}-x_{s}\\|+\\sigma_{t}(e^{h}-1)L\\|x_{s}^{*}-x_{s}\\|+O(h^{2})}\\\\ &{\\qquad\\qquad\\leq O((1+L)\\|x_{s}^{*}-x_{s}\\|)+O(h^{2})}\\end{array}\n$$", "text_format": "latex", "page_idx": 18}, {"type": "text", "text": "If we run DDIM for $M$ steps, $h_{\\operatorname*{max}}=O(1/M)$ , and we achieve the discretization error bound for DDIM algorithm: ", "page_idx": 18}, {"type": "equation", "text": "$$\n\\|\\pmb{x}_{0}-\\pmb{x}_{0}^{*}\\|\\leq O(M(1+L)^{M}h_{\\operatorname*{max}}^{2})=\\pmb{x}_{0}^{*}+O((1+L^{M})/M).\n$$", "text_format": "latex", "page_idx": 18}, {"type": "text", "text": "D.5 Proof for Proposition 4.1 ", "text_level": 1, "page_idx": 18}, {"type": "text", "text": "Proof. By the definition of expectation, we have ", "page_idx": 18}, {"type": "equation", "text": "$$\n\\hat{f}(\\pmb{x})=\\mathbb{E}_{\\pmb{\\epsilon}\\sim p(\\pmb{\\epsilon})}[f(\\pmb{x}+\\sigma_{t}\\pmb{\\epsilon})]=(f\\circledast p)(\\pmb{x})=\\int_{\\mathbb{R}^{n}}f(\\pmb{z})p(\\pmb{x}-\\pmb{z})\\mathrm{d}z.\n$$", "text_format": "latex", "page_idx": 18}, {"type": "text", "text": "Then we compute the Lipschitz constant ", "page_idx": 18}, {"type": "equation", "text": "$$\n\\displaystyle{\\mathbf{u}}^{T}\\nabla\\hat{f}({\\mathbf{x}})\\leq C\\int_{{\\mathbb{R}}^{n}}\\|\\nabla p({\\mathbf{x}}-z)\\|_{2}\\mathrm{d}z=C\\int_{{\\mathbb{R}}^{n}}\\|\\nabla p(z)\\|_{2}\\mathrm{d}z.\n$$", "text_format": "latex", "page_idx": 18}, {"type": "text", "text": "As for the gradient Lipschitz constant, we have ", "page_idx": 18}, {"type": "equation", "text": "$$\nL=\\|\\nabla^{2}\\hat{f}(\\pmb{x})\\|_{\\mathrm{op}}\\leq C\\left\\|\\int_{\\mathbb{R}^{n}}\\nabla^{2}p(\\pmb{x}-\\pmb{z})\\mathrm{d}\\boldsymbol{z}\\right\\|_{\\mathrm{op}}\\leq C\\int_{\\mathbb{R}^{n}}\\|\\nabla^{2}p(\\boldsymbol{z})\\|_{\\mathrm{op}}\\mathrm{d}\\boldsymbol{z},\n$$", "text_format": "latex", "page_idx": 18}, {"type": "text", "text": "where ${\\|\\cdot\\|_{\\mathrm{op}}}$ is the operator norm of a matrix. ", "page_idx": 18}, {"type": "text", "text": "E More Qualitative Results ", "text_level": 1, "page_idx": 18}, {"type": "text", "text": "E.1 CelebA-HQ ", "text_level": 1, "page_idx": 18}, {"type": "text", "text": "E.2 ImageNet ", "text_level": 1, "page_idx": 18}, {"type": "image", "img_path": "Eu80DGuOcs/tmp/1cf4dad4d948ac6ce674bda5e6a118c5cd1408315d080c993c1e767d92e0ac22.jpg", "img_caption": ["Figure 8: More qualitative results of CelebA-HQ with zero-shot segmentation guidance. The images are randomly selected. "], "img_footnote": [], "page_idx": 19}, {"type": "text", "text": "E.3 Human Motion ", "text_level": 1, "page_idx": 19}, {"type": "text", "text": "See \u201cTeX Source/videos.pptx\u201d. ", "page_idx": 19}, {"type": "image", "img_path": "Eu80DGuOcs/tmp/cc1138c61b788685bb155fe68688f203dbbbc8db8f1c33c8bad2945955913490.jpg", "img_caption": ["Figure 9: More qualitative results of CelebA-HQ with zero-shot sketch guidance. The images are randomly selected. "], "img_footnote": [], "page_idx": 20}, {"type": "image", "img_path": "Eu80DGuOcs/tmp/b0ce32a890c0d2a2b7cd6c9c44db736de107c11e04e3249e708bbbee9548b88d.jpg", "img_caption": ["Figure 10: More qualitative results of CelebA-HQ with zero-shot text guidance. The images are randomly selected. "], "img_footnote": [], "page_idx": 21}, {"type": "image", "img_path": "Eu80DGuOcs/tmp/266c225a3737640741b775bf7efb668ccebdb3cae0c40d7af6d1f037465fa470.jpg", "img_caption": ["Figure 11: More qualitative results of ImageNet with zero-shot text guidance. The images are randomly selected. "], "img_footnote": [], "page_idx": 22}, {"type": "text", "text": "NeurIPS Paper Checklist ", "text_level": 1, "page_idx": 23}, {"type": "text", "text": "1. Claims ", "text_level": 1, "page_idx": 23}, {"type": "text", "text": "Question: Do the main claims made in the abstract and introduction accurately reflect the paper\u2019s contributions and scope? ", "page_idx": 23}, {"type": "text", "text": "Answer: [Yes] ", "page_idx": 23}, {"type": "text", "text": "Justification: We confirm that the main claims made in the abstract and introduction accurately reflect the paper\u2019s contributions and scope. ", "page_idx": 23}, {"type": "text", "text": "Guidelines: ", "page_idx": 23}, {"type": "text", "text": "\u2022 The answer NA means that the abstract and introduction do not include the claims made in the paper.   \n\u2022 The abstract and/or introduction should clearly state the claims made, including the contributions made in the paper and important assumptions and limitations. A No or NA answer to this question will not be perceived well by the reviewers.   \n\u2022 The claims made should match theoretical and experimental results, and reflect how much the results can be expected to generalize to other settings.   \n\u2022 It is fine to include aspirational goals as motivation as long as it is clear that these goals are not attained by the paper. ", "page_idx": 23}, {"type": "text", "text": "2. Limitations ", "text_level": 1, "page_idx": 23}, {"type": "text", "text": "Question: Does the paper discuss the limitations of the work performed by the authors? ", "page_idx": 23}, {"type": "text", "text": "Answer: [Yes] ", "text_level": 1, "page_idx": 23}, {"type": "text", "text": "Justification: The limitations are discussed in the conclusions ", "page_idx": 23}, {"type": "text", "text": "Guidelines: ", "page_idx": 23}, {"type": "text", "text": "\u2022 The answer NA means that the paper has no limitation while the answer No means that the paper has limitations, but those are not discussed in the paper.   \n\u2022 The authors are encouraged to create a separate \"Limitations\" section in their paper.   \n\u2022 The paper should point out any strong assumptions and how robust the results are to violations of these assumptions (e.g., independence assumptions, noiseless settings, model well-specification, asymptotic approximations only holding locally). The authors should reflect on how these assumptions might be violated in practice and what the implications would be.   \n\u2022 The authors should reflect on the scope of the claims made, e.g., if the approach was only tested on a few datasets or with a few runs. In general, empirical results often depend on implicit assumptions, which should be articulated.   \n\u2022 The authors should reflect on the factors that influence the performance of the approach. For example, a facial recognition algorithm may perform poorly when image resolution is low or images are taken in low lighting. Or a speech-to-text system might not be used reliably to provide closed captions for online lectures because it fails to handle technical jargon.   \n\u2022 The authors should discuss the computational efficiency of the proposed algorithms and how they scale with dataset size.   \n\u2022 If applicable, the authors should discuss possible limitations of their approach to address problems of privacy and fairness.   \n\u2022 While the authors might fear that complete honesty about limitations might be used by reviewers as grounds for rejection, a worse outcome might be that reviewers discover limitations that aren\u2019t acknowledged in the paper. The authors should use their best judgment and recognize that individual actions in favor of transparency play an important role in developing norms that preserve the integrity of the community. Reviewers will be specifically instructed to not penalize honesty concerning limitations. ", "page_idx": 23}, {"type": "text", "text": "3. Theory Assumptions and Proofs ", "text_level": 1, "page_idx": 23}, {"type": "text", "text": "Question: For each theoretical result, does the paper provide the full set of assumptions and a complete (and correct) proof? ", "page_idx": 23}, {"type": "text", "text": "Answer: [Yes] ", "page_idx": 23}, {"type": "text", "text": "Justification: The assumptions and proofs are provided in the appendix Guidelines: ", "page_idx": 24}, {"type": "text", "text": "\u2022 The answer NA means that the paper does not include theoretical results.   \n\u2022 All the theorems, formulas, and proofs in the paper should be numbered and crossreferenced.   \n\u2022 All assumptions should be clearly stated or referenced in the statement of any theorems.   \n\u2022 The proofs can either appear in the main paper or the supplemental material, but if they appear in the supplemental material, the authors are encouraged to provide a short proof sketch to provide intuition.   \n\u2022 Inversely, any informal proof provided in the core of the paper should be complemented by formal proofs provided in appendix or supplemental material.   \n\u2022 Theorems and Lemmas that the proof relies upon should be properly referenced. ", "page_idx": 24}, {"type": "text", "text": "4. Experimental Result Reproducibility ", "text_level": 1, "page_idx": 24}, {"type": "text", "text": "Question: Does the paper fully disclose all the information needed to reproduce the main experimental results of the paper to the extent that it affects the main claims and/or conclusions of the paper (regardless of whether the code and data are provided or not)? ", "page_idx": 24}, {"type": "text", "text": "Answer: [Yes] ", "text_level": 1, "page_idx": 24}, {"type": "text", "text": "Justification: The paper details the evaluation benchmarks and baselines, while the code is made available in the supplementary materials. ", "page_idx": 24}, {"type": "text", "text": "Guidelines: ", "page_idx": 24}, {"type": "text", "text": "\u2022 The answer NA means that the paper does not include experiments.   \n\u2022 If the paper includes experiments, a No answer to this question will not be perceived well by the reviewers: Making the paper reproducible is important, regardless of whether the code and data are provided or not.   \n\u2022 If the contribution is a dataset and/or model, the authors should describe the steps taken to make their results reproducible or verifiable.   \n\u2022 Depending on the contribution, reproducibility can be accomplished in various ways. For example, if the contribution is a novel architecture, describing the architecture fully might suffice, or if the contribution is a specific model and empirical evaluation, it may be necessary to either make it possible for others to replicate the model with the same dataset, or provide access to the model. In general. releasing code and data is often one good way to accomplish this, but reproducibility can also be provided via detailed instructions for how to replicate the results, access to a hosted model (e.g., in the case of a large language model), releasing of a model checkpoint, or other means that are appropriate to the research performed.   \n\u2022 While NeurIPS does not require releasing code, the conference does require all submissions to provide some reasonable avenue for reproducibility, which may depend on the nature of the contribution. For example (a) If the contribution is primarily a new algorithm, the paper should make it clear how to reproduce that algorithm. (b) If the contribution is primarily a new model architecture, the paper should describe the architecture clearly and fully. (c) If the contribution is a new model (e.g., a large language model), then there should either be a way to access this model for reproducing the results or a way to reproduce the model (e.g., with an open-source dataset or instructions for how to construct the dataset). (d) We recognize that reproducibility may be tricky in some cases, in which case authors are welcome to describe the particular way they provide for reproducibility. In the case of closed-source models, it may be that access to the model is limited in some way (e.g., to registered users), but it should be possible for other researchers to have some path to reproducing or verifying the results. ", "page_idx": 24}, {"type": "text", "text": "5. Open access to data and code ", "text_level": 1, "page_idx": 24}, {"type": "text", "text": "Question: Does the paper provide open access to the data and code, with sufficient instructions to faithfully reproduce the main experimental results, as described in supplemental material? ", "page_idx": 24}, {"type": "text", "text": "Answer: [Yes] ", "page_idx": 25}, {"type": "text", "text": "Justification: The source code is provided in the supplementary material. Guidelines: ", "page_idx": 25}, {"type": "text", "text": "\u2022 The answer NA means that paper does not include experiments requiring code.   \n\u2022 Please see the NeurIPS code and data submission guidelines (https://nips.cc/ public/guides/CodeSubmissionPolicy) for more details.   \n\u2022 While we encourage the release of code and data, we understand that this might not be possible, so \u201cNo\u201d is an acceptable answer. Papers cannot be rejected simply for not including code, unless this is central to the contribution (e.g., for a new open-source benchmark).   \n\u2022 The instructions should contain the exact command and environment needed to run to reproduce the results. See the NeurIPS code and data submission guidelines (https: //nips.cc/public/guides/CodeSubmissionPolicy) for more details.   \n\u2022 The authors should provide instructions on data access and preparation, including how to access the raw data, preprocessed data, intermediate data, and generated data, etc.   \n\u2022 The authors should provide scripts to reproduce all experimental results for the new proposed method and baselines. If only a subset of experiments are reproducible, they should state which ones are omitted from the script and why.   \n\u2022 At submission time, to preserve anonymity, the authors should release anonymized versions (if applicable).   \n\u2022 Providing as much information as possible in supplemental material (appended to the paper) is recommended, but including URLs to data and code is permitted. ", "page_idx": 25}, {"type": "text", "text": "6. Experimental Setting/Details ", "text_level": 1, "page_idx": 25}, {"type": "text", "text": "Question: Does the paper specify all the training and test details (e.g., data splits, hyperparameters, how they were chosen, type of optimizer, etc.) necessary to understand the results? ", "page_idx": 25}, {"type": "text", "text": "Answer: [Yes] ", "page_idx": 25}, {"type": "text", "text": "Justification: Our experiments are designed in alignment with established studies, which guided the setup of these components. ", "page_idx": 25}, {"type": "text", "text": "Guidelines: ", "page_idx": 25}, {"type": "text", "text": "\u2022 The answer NA means that the paper does not include experiments. \u2022 The experimental setting should be presented in the core of the paper to a level of detail that is necessary to appreciate the results and make sense of them. \u2022 The full details can be provided either with the code, in appendix, or as supplemental material. ", "page_idx": 25}, {"type": "text", "text": "7. Experiment Statistical Significance ", "text_level": 1, "page_idx": 25}, {"type": "text", "text": "Question: Does the paper report error bars suitably and correctly defined or other appropriate information about the statistical significance of the experiments? ", "page_idx": 25}, {"type": "text", "text": "Answer: [No] ", "page_idx": 25}, {"type": "text", "text": "Justification: In the experiments, we adhere to methodologies outlined in existing studies, which do not include error bars. ", "page_idx": 25}, {"type": "text", "text": "Guidelines: ", "page_idx": 25}, {"type": "text", "text": "\u2022 The answer NA means that the paper does not include experiments.   \n\u2022 The authors should answer \"Yes\" if the results are accompanied by error bars, confidence intervals, or statistical significance tests, at least for the experiments that support the main claims of the paper.   \n\u2022 The factors of variability that the error bars are capturing should be clearly stated (for example, train/test split, initialization, random drawing of some parameter, or overall run with given experimental conditions).   \n\u2022 The method for calculating the error bars should be explained (closed form formula, call to a library function, bootstrap, etc.)   \n\u2022 The assumptions made should be given (e.g., Normally distributed errors).   \n\u2022 It should be clear whether the error bar is the standard deviation or the standard error of the mean.   \n\u2022 It is OK to report 1-sigma error bars, but one should state it. The authors should preferably report a 2-sigma error bar than state that they have a $96\\%$ CI, if the hypothesis of Normality of errors is not verified.   \n\u2022 For asymmetric distributions, the authors should be careful not to show in tables or figures symmetric error bars that would yield results that are out of range (e.g. negative error rates).   \n\u2022 If error bars are reported in tables or plots, The authors should explain in the text how they were calculated and reference the corresponding figures or tables in the text. ", "page_idx": 25}, {"type": "text", "text": "", "page_idx": 26}, {"type": "text", "text": "8. Experiments Compute Resources ", "text_level": 1, "page_idx": 26}, {"type": "text", "text": "Question: For each experiment, does the paper provide sufficient information on the computer resources (type of compute workers, memory, time of execution) needed to reproduce the experiments? ", "page_idx": 26}, {"type": "text", "text": "Answer: [Yes] ", "page_idx": 26}, {"type": "text", "text": "Justification: All experiments were conducted on a single A100 GPU, although less powerful GPUs, such as the V100 with 16GB of memory, are sufficient for replicating the experiments. ", "page_idx": 26}, {"type": "text", "text": "\u2022 The answer NA means that the paper does not include experiments.   \n\u2022 The paper should indicate the type of compute workers CPU or GPU, internal cluster, or cloud provider, including relevant memory and storage.   \n\u2022 The paper should provide the amount of compute required for each of the individual experimental runs as well as estimate the total compute.   \n\u2022 The paper should disclose whether the full research project required more compute than the experiments reported in the paper (e.g., preliminary or failed experiments that didn\u2019t make it into the paper). ", "page_idx": 26}, {"type": "text", "text": "9. Code Of Ethics ", "text_level": 1, "page_idx": 26}, {"type": "text", "text": "Question: Does the research conducted in the paper conform, in every respect, with the NeurIPS Code of Ethics https://neurips.cc/public/EthicsGuidelines? ", "page_idx": 26}, {"type": "text", "text": "Answer: [Yes] ", "text_level": 1, "page_idx": 26}, {"type": "text", "text": "Justification: We confirm that the research conducted in the paper conform. ", "page_idx": 26}, {"type": "text", "text": "Guidelines: ", "page_idx": 26}, {"type": "text", "text": "\u2022 The answer NA means that the authors have not reviewed the NeurIPS Code of Ethics.   \n\u2022 If the authors answer No, they should explain the special circumstances that require a deviation from the Code of Ethics.   \n\u2022 The authors should make sure to preserve anonymity (e.g., if there is a special consideration due to laws or regulations in their jurisdiction). ", "page_idx": 26}, {"type": "text", "text": "10. Broader Impacts ", "text_level": 1, "page_idx": 26}, {"type": "text", "text": "Question: Does the paper discuss both potential positive societal impacts and negative societal impacts of the work performed? ", "page_idx": 26}, {"type": "text", "text": "Answer: [Yes] ", "text_level": 1, "page_idx": 26}, {"type": "text", "text": "Justification: The societal impacts are discussed in the conclusions. ", "page_idx": 26}, {"type": "text", "text": "Guidelines: ", "page_idx": 26}, {"type": "text", "text": "\u2022 The answer NA means that there is no societal impact of the work performed.   \n\u2022 If the authors answer NA or No, they should explain why their work has no societal impact or why the paper does not address societal impact.   \n\u2022 Examples of negative societal impacts include potential malicious or unintended uses (e.g., disinformation, generating fake profiles, surveillance), fairness considerations (e.g., deployment of technologies that could make decisions that unfairly impact specific groups), privacy considerations, and security considerations.   \n\u2022 The conference expects that many papers will be foundational research and not tied to particular applications, let alone deployments. However, if there is a direct path to any negative applications, the authors should point it out. For example, it is legitimate to point out that an improvement in the quality of generative models could be used to generate deepfakes for disinformation. On the other hand, it is not needed to point out that a generic algorithm for optimizing neural networks could enable people to train models that generate Deepfakes faster.   \n\u2022 The authors should consider possible harms that could arise when the technology is being used as intended and functioning correctly, harms that could arise when the technology is being used as intended but gives incorrect results, and harms following from (intentional or unintentional) misuse of the technology.   \n\u2022 If there are negative societal impacts, the authors could also discuss possible mitigation strategies (e.g., gated release of models, providing defenses in addition to attacks, mechanisms for monitoring misuse, mechanisms to monitor how a system learns from feedback over time, improving the efficiency and accessibility of ML). ", "page_idx": 26}, {"type": "text", "text": "", "page_idx": 27}, {"type": "text", "text": "11. Safeguards ", "text_level": 1, "page_idx": 27}, {"type": "text", "text": "Question: Does the paper describe safeguards that have been put in place for responsible release of data or models that have a high risk for misuse (e.g., pretrained language models, image generators, or scraped datasets)? ", "page_idx": 27}, {"type": "text", "text": "Answer: [No] ", "page_idx": 27}, {"type": "text", "text": "Justification: All checkpoints referenced are documented in existing literature, which did not specify any safeguards. Consequently, it is challenging to implement safeguards for these checkpoints. ", "page_idx": 27}, {"type": "text", "text": "Guidelines: ", "page_idx": 27}, {"type": "text", "text": "\u2022 The answer NA means that the paper poses no such risks.   \n\u2022 Released models that have a high risk for misuse or dual-use should be released with necessary safeguards to allow for controlled use of the model, for example by requiring that users adhere to usage guidelines or restrictions to access the model or implementing safety filters.   \n\u2022 Datasets that have been scraped from the Internet could pose safety risks. The authors should describe how they avoided releasing unsafe images.   \n\u2022 We recognize that providing effective safeguards is challenging, and many papers do not require this, but we encourage authors to take this into account and make a best faith effort. ", "page_idx": 27}, {"type": "text", "text": "12. Licenses for existing assets ", "text_level": 1, "page_idx": 27}, {"type": "text", "text": "Question: Are the creators or original owners of assets (e.g., code, data, models), used in the paper, properly credited and are the license and terms of use explicitly mentioned and properly respected? ", "page_idx": 27}, {"type": "text", "text": "Answer: [Yes] ", "page_idx": 27}, {"type": "text", "text": "Justification: Yes. ", "page_idx": 27}, {"type": "text", "text": "Guidelines: ", "page_idx": 27}, {"type": "text", "text": "\u2022 The answer NA means that the paper does not use existing assets.   \n\u2022 The authors should cite the original paper that produced the code package or dataset.   \n\u2022 The authors should state which version of the asset is used and, if possible, include a URL.   \n\u2022 The name of the license (e.g., CC-BY 4.0) should be included for each asset.   \n\u2022 For scraped data from a particular source (e.g., website), the copyright and terms of service of that source should be provided.   \n\u2022 If assets are released, the license, copyright information, and terms of use in the package should be provided. For popular datasets, paperswithcode.com/datasets has curated licenses for some datasets. Their licensing guide can help determine the license of a dataset.   \n\u2022 For existing datasets that are re-packaged, both the original license and the license of the derived asset (if it has changed) should be provided.   \n\u2022 If this information is not available online, the authors are encouraged to reach out to the asset\u2019s creators. ", "page_idx": 27}, {"type": "text", "text": "", "page_idx": 28}, {"type": "text", "text": "13. New Assets ", "text_level": 1, "page_idx": 28}, {"type": "text", "text": "Question: Are new assets introduced in the paper well documented and is the documentation provided alongside the assets? ", "page_idx": 28}, {"type": "text", "text": "Answer: [NA] ", "page_idx": 28}, {"type": "text", "text": "Justification: We do not release new assets. ", "page_idx": 28}, {"type": "text", "text": "Guidelines: ", "page_idx": 28}, {"type": "text", "text": "\u2022 The answer NA means that the paper does not release new assets.   \n\u2022 Researchers should communicate the details of the dataset/code/model as part of their submissions via structured templates. This includes details about training, license, limitations, etc.   \n\u2022 The paper should discuss whether and how consent was obtained from people whose asset is used.   \n\u2022 At submission time, remember to anonymize your assets (if applicable). You can either create an anonymized URL or include an anonymized zip file. ", "page_idx": 28}, {"type": "text", "text": "14. Crowdsourcing and Research with Human Subjects ", "text_level": 1, "page_idx": 28}, {"type": "text", "text": "Question: For crowdsourcing experiments and research with human subjects, does the paper include the full text of instructions given to participants and screenshots, if applicable, as well as details about compensation (if any)? ", "page_idx": 28}, {"type": "text", "text": "Answer: [NA] ", "page_idx": 28}, {"type": "text", "text": "Justification: The paper does not involve crowdsourcing or research with human subjects. Guidelines: ", "page_idx": 28}, {"type": "text", "text": "\u2022 The answer NA means that the paper does not involve crowdsourcing nor research with human subjects.   \n\u2022 Including this information in the supplemental material is fine, but if the main contribution of the paper involves human subjects, then as much detail as possible should be included in the main paper.   \n\u2022 According to the NeurIPS Code of Ethics, workers involved in data collection, curation, or other labor should be paid at least the minimum wage in the country of the data collector. ", "page_idx": 28}, {"type": "text", "text": "15. Institutional Review Board (IRB) Approvals or Equivalent for Research with Human Subjects ", "text_level": 1, "page_idx": 28}, {"type": "text", "text": "Question: Does the paper describe potential risks incurred by study participants, whether such risks were disclosed to the subjects, and whether Institutional Review Board (IRB) approvals (or an equivalent approval/review based on the requirements of your country or institution) were obtained? ", "page_idx": 28}, {"type": "text", "text": "Answer: [NA] ", "page_idx": 28}, {"type": "text", "text": "Justification: The paper does not involve crowdsourcing nor research with human subjects. Guidelines: ", "page_idx": 28}, {"type": "text", "text": "\u2022 The answer NA means that the paper does not involve crowdsourcing nor research with human subjects.   \n\u2022 Depending on the country in which research is conducted, IRB approval (or equivalent) may be required for any human subjects research. If you obtained IRB approval, you should clearly state this in the paper.   \n\u2022 We recognize that the procedures for this may vary significantly between institutions and locations, and we expect authors to adhere to the NeurIPS Code of Ethics and the guidelines for their institution.   \n\u2022 For initial submissions, do not include any information that would break anonymity (if applicable), such as the institution conducting the review. ", "page_idx": 28}]