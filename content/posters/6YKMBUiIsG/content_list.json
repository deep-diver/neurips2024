[{"type": "text", "text": "Inevitable Trade-off between Watermark Strength and Speculative Sampling Efficiency for Language Models ", "text_level": 1, "page_idx": 0}, {"type": "text", "text": "Zhengmian Hu, Heng Huang Department of Computer Science University of Maryland College Park, MD 20742 huzhengmian@gmail.com,heng@umd.edu ", "page_idx": 0}, {"type": "text", "text": "Abstract ", "text_level": 1, "page_idx": 0}, {"type": "text", "text": "Large language models are probabilistic models, and the process of generating content is essentially sampling from the output distribution of the language model. Existing watermarking techniques inject watermarks into the generated content without altering the output quality. On the other hand, existing acceleration techniques, specifically speculative sampling, leverage a draft model to speed up the sampling process while preserving the output distribution. However, there is no known method to simultaneously accelerate the sampling process and inject watermarks into the generated content. In this paper, we investigate this direction and find that the integration of watermarking and acceleration is non-trivial. We prove a no-go theorem, which states that it is impossible to simultaneously maintain the highest watermark strength and the highest sampling efficiency. Furthermore, we propose two methods that maintain either the sampling efficiency or the watermark strength, but not both. Our work provides a rigorous theoretical foundation for understanding the inherent trade-off between watermark strength and sampling efficiency in accelerating the generation of watermarked tokens for large language models. We also conduct numerical experiments to validate our theoretical findings and demonstrate the effectiveness of the proposed methods. ", "page_idx": 0}, {"type": "text", "text": "1 Introduction ", "text_level": 1, "page_idx": 0}, {"type": "text", "text": "Large language models (LLMs) have demonstrated remarkable performance in various natural language processing tasks, enabling a wide range of applications such as chatbots [23], content generation [17], code generation [6], and more. However, the high training and inference costs of LLMs pose significant challenges. The substantial computational resources along with the high latency during inference can negatively impact user experience and limit their potential applications. ", "page_idx": 0}, {"type": "text", "text": "To address the issue of high inference costs, speculative sampling [16, 5] has emerged as a promising approach. This technique leverages a smaller, faster draft model to generate candidate results, which are then validated and corrected by a larger, more accurate target model. Compared with other acceleration methods such as knowledge distillation, model quantization, and model pruning, the key advantage of speculative sampling is that it can significantly reduce inference latency without compromising the quality of the generated content. ", "page_idx": 0}, {"type": "text", "text": "In addition to the challenge of high inference costs, protecting the intellectual property rights of LLMs generated content has become increasingly important. Digital watermarking techniques [1, 13] have been proposed to embed watermark information into the generated content, enabling the tracking of model usage. Unbiased watermarking schemes [12] have been developed to ensure that the watermarking process does not affect the quality of the generated content. ", "page_idx": 0}, {"type": "image", "img_path": "6YKMBUiIsG/tmp/9f10a1671cf99d98124c52c1ea6f96e45702a3a292beb825a9cd1485ce1f208b.jpg", "img_caption": ["Speculative Sampling Efficiency "], "img_footnote": [], "page_idx": 1}, {"type": "text", "text": "Figure 1: Taxonomy of watermarking and speculative sampling trade-offs in language models. The ideal case of maintaining both watermark strength and sampling efficiency is proven to be impossible by the no-go theorem. The proposed algorithms focus on maintaining either watermark strength or sampling efficiency. ", "page_idx": 1}, {"type": "text", "text": "A natural question arises: can we leverage speculative sampling to accelerate the generation of watermarked content? To address this question, we propose a general framework called the two reweight framework, which allows for the integration of unbiased watermarking and speculative sampling techniques while guaranteeing an unchanged output distribution. The main innovation of our framework lies in the simultaneous reweighting of both the target model and the draft model, which improves the sampling efficiency compared to naively applying speculative sampling to a watermarked target model. ", "page_idx": 1}, {"type": "text", "text": "To evaluate the effectiveness of our framework, we consider two key metrics: watermark strength and acceleration performance. A fundamental question is whether it is possible to achieve both strong watermarking and efficient speculative sampling simultaneously. Specifically, we aim to answer the following question: ", "page_idx": 1}, {"type": "text", "text": "Can we obtain the same watermark strength as in the case without acceleration while maintaining the same sampling efficiency as in the case without watermarking? ", "page_idx": 1}, {"type": "text", "text": "Surprisingly, we got a negative answer to this question. We prove a no-go theorem, which states that under the two reweight framework, it is impossible to simultaneously maintain both the watermark strength and the sampling efficiency when the vocabulary size is greater than two. This result highlights the inherent trade-off between watermarking and acceleration in the context of large language models. ", "page_idx": 1}, {"type": "text", "text": "To better explore the trade-offs between these two objectives, we propose two practical algorithms within the two reweight framework. The first algorithm focuses on maintaining the watermark strength, while the second algorithm aims to maintain the sampling efficiency. ", "page_idx": 1}, {"type": "text", "text": "The main contributions of this paper are as follows: ", "page_idx": 1}, {"type": "text", "text": "\u2022 We propose the two reweight framework, a general framework that allows for the integration of unbiased watermarking and speculative sampling techniques while ensuring an unchanged output distribution.   \n\u2022 We prove a no-go theorem, which states that under the two reweight framework, it is impossible to simultaneously maintain both the watermark strength and the sampling efficiency when the vocabulary size is greater than two.   \n\u2022 We propose two practical algorithms within the two reweight framework that focus on maintaining either the watermark strength or the sampling efficiency, providing insights into the achievable trade-offs. ", "page_idx": 1}, {"type": "text", "text": "To the best of our knowledge, this work represents the first exploration of the intersection between unbiased watermarking and speculative sampling, introducing a novel framework, a significant no-go theorem, and pioneering practical algorithms. ", "page_idx": 2}, {"type": "text", "text": "2 Preliminary ", "text_level": 1, "page_idx": 2}, {"type": "text", "text": "In this section, we will introduce the basic concepts and notations used throughout the paper, and provide a brief overview of watermarking and speculative sampling techniques for large language models. ", "page_idx": 2}, {"type": "text", "text": "A language model defines a probability distribution over sequences of tokens from a vocabulary set $\\Sigma$ . It assigns a probability $P(x_{n+1}|x_{1},x_{2},...,x_{n})$ to the next token $x_{n+1}$ given the context of previous tokens $x_{1},x_{2},...,x_{n}$ . We use $\\Delta_{\\Sigma}$ to denote the set of all possible probability distributions over the vocabulary $\\Sigma$ . ", "page_idx": 2}, {"type": "text", "text": "Following Hu et al. [12], we define a watermarking scheme as a tuple $(\\mathcal{E},P_{E},R)$ , where $\\mathcal{E}$ is a set of watermark codes, $P_{E}$ is a probability distribution over $\\mathcal{E}$ , and $R:\\mathcal{E}\\times\\Delta_{\\Sigma}\\,\\rightarrow\\,\\Delta_{\\Sigma}$ is a reweighting function that maps a watermark code $E\\in{\\mathcal{E}}$ and a probability distribution $P\\in\\Delta_{\\Sigma}$ to a watermarked distribution $R_{E}(P)\\in\\Delta_{\\Sigma}$ . We focus on unbiased watermarking schemes that satisfy $\\mathbb{E}_{E\\sim P_{E}}[R_{E}(P)]=P$ for all $P\\in\\Delta_{\\Sigma}$ , unless explicitly stated otherwise. ", "page_idx": 2}, {"type": "text", "text": "To generate a watermarked token $x$ , we first compute a watermark code $E\\sim P_{E}$ based on the context, and then sample the token from the watermarked distribution, i.e., $x\\sim R_{E}(P)$ . The entropy of the distribution $P$ determines the maximum amount of watermark that can be injected. For a distribution $P$ with high entropy, the divergence between the watermarked distribution $\\dot{R}_{E}(P)$ and the original distribution $P$ can be larger, allowing for more watermark information to be injected. ", "page_idx": 2}, {"type": "text", "text": "The presence of the watermark can be detected by statistical tests. The pivotal quantity used in these tests is often referred to as the watermark score. A higher watermark score implies a more detectable watermark. The log likelihood ratio (LLR) is the most powerful score for detecting watermarks in the absence of any perturbations. However, in practice, more robust scores such as the maximin-LLR or likelihood-agnostic scores are often used. In this paper, we consider two specific watermark scores: the maximin-LLR score, which is described in detail in [12], and the U score, which is a likelihood-agnostic score that can be defined for both DeltaGumbel reweight and Gamma reweight schemes. The details of the U score, DeltaGumbel reweight and Gamma reweight are provided in Appendix D. ", "page_idx": 2}, {"type": "text", "text": "The P-value can be computed by considering the absence of a watermark as the null hypothesis. For a score $S$ with a known moment-generating function (MGF), the $\\mathbf{P}_{}$ -value can be upper bounded using the Chernoff bound: ", "page_idx": 2}, {"type": "equation", "text": "$$\nP_{\\mathrm{null}}(S\\geq\\hat{S})\\leq\\operatorname*{min}_{\\lambda\\geq0}\\mathbb{E}[e^{\\lambda S}]\\exp\\Bigl(-\\lambda\\hat{S}\\Bigr).\n$$", "text_format": "latex", "page_idx": 2}, {"type": "text", "text": "Speculative sampling [16, 5] is a technique for accelerating the generation of tokens from a target model $P$ by leveraging a faster draft model $Q$ . The key idea is to first sample a draft token $\\tilde{x}$ from the draft model $Q$ , and then accept or reject it based on the ratio of the target and draft probabilities. If the draft token is rejected, a new token is sampled from a residual distribution proportional to the difference between the target and draft probabilities. Formally, the speculative sampling process generates a token $x$ as follows: ", "page_idx": 2}, {"type": "equation", "text": "$$\n\\begin{array}{r}{\\mathcal{P}(x=j|\\tilde{x}=i)=\\left\\{\\frac{\\operatorname*{min}(1,\\,\\frac{P(i)}{Q(i)})}{\\frac{(1-\\frac{P(i)}{Q(i)})_{+}(P(j)-Q(j))_{+}}{\\sum_{z\\in\\Sigma}(Q(z)-P(z))_{+}}}\\right.\\mathrm{~if~}i=j,}\\end{array}\n$$", "text_format": "latex", "page_idx": 2}, {"type": "text", "text": "where $(x)_{+}=\\operatorname*{max}(0,x)$ . The design of the speculative process ensures that the final distribution of the generated token $x$ matches the target distribution $P$ . The efficiency of speculative sampling can be measured by the overlap probability $\\begin{array}{r}{\\alpha(P,Q)=\\sum_{t\\in\\Sigma}\\operatorname*{min}(P(t),Q(t))}\\end{array}$ , which is the probability of accepting the draft token in each step. The ov erlap probability is related to the total variation distance between $P$ and $Q$ by $\\mathrm{TV}(P,Q)=1-\\alpha(P,Q)$ . Such a speculative sampling process can be applied multiple times to generate and verify multiple draft tokens in one step. ", "page_idx": 2}, {"type": "text", "text": "Due to space limitations, we have moved the discussion of other related works to the Appendix A. ", "page_idx": 2}, {"type": "text", "text": "3 Two Reweight Framework for Accelerated Generation of Watermarked Tokens ", "text_level": 1, "page_idx": 3}, {"type": "text", "text": "In this section, we propose a novel framework called the two reweight framework for accelerating the generation of watermarked tokens based on speculative sampling techniques. The motivation behind this non-trivial framework is that naively applying speculative sampling to a watermarked target distribution $R_{E}(P)$ may significantly reduce the overlap probability $\\alpha(\\bar{R}_{E}(P),Q)$ with the draft distribution $Q$ , leading to a small sampling efficiency. ", "page_idx": 3}, {"type": "text", "text": "The key innovation of the two reweight framework is to apply a separate reweighting function $R^{\\prime}$ to the draft distribution $Q$ , using the same watermark code $E$ as the one used for reweighting the target distribution. By doing so, we aim to increase the overlap probability between the watermarked target distribution $R_{E}(P)$ and the watermarked draft distribution $R_{E}^{\\prime}(Q)$ , i.e., $\\alpha(R_{E}(P),R_{E}^{\\prime}(Q))$ , thus improving the sampling efficiency. ", "page_idx": 3}, {"type": "text", "text": "Formally, we define the watermarked draft distribution using another reweighting function $(\\mathcal{E},P_{E},\\dot{R}^{\\prime})$ , where $R^{\\prime}:\\mathcal{E}\\times\\Delta_{\\Sigma}\\,\\to\\,\\Delta_{\\Sigma}$ is a function that maps a watermark code $E\\,\\in\\,{\\mathcal{E}}$ and a draft distribution $Q\\in\\Delta_{\\Sigma}$ to a watermarked draft distribution $\\bar{R_{E}^{\\prime}}(Q)\\in\\Delta_{\\Sigma}$ . The framework itself does not require the watermarked draft distribution to be unbiased, i.e., $\\mathbb{E}_{E\\sim P_{E}}[R_{E}^{\\prime}(Q)]=Q$ for all $Q\\in\\Delta_{\\Sigma}$ . However, we will see later that this unbiasedness property naturally emerges when we require the final output distribution to be unbiased and aim to improve the sampling efficiency (Lemma 3). ", "page_idx": 3}, {"type": "text", "text": "To generate a watermarked token, we first sample a draft token $\\tilde{x}$ from the watermarked draft distribution, i.e., $\\tilde{x}\\sim R_{E}^{\\prime}(Q)$ or equivalently $\\mathcal{P}(\\tilde{x}=i)=R_{E}^{\\prime}(Q)(i)$ for all $i\\in\\Sigma$ . Then, we perform certain speculative sampling based on the draft token to obtain the generated token $x$ . The speculative process is defined by a conditional probability distribution $A(j|i)$ for all $i,j\\in\\Sigma$ , where $\\bar{A(\\bar{\\cdot}|i)}\\in\\Delta_{\\Sigma}$ for each $i$ . The design of $A$ can depend on the target distribution $P$ , the draft distribution $Q$ , and the watermark code $E$ . The probability of generating a token $x=j$ given a draft token $\\tilde{x}=i$ is given by $\\mathscr{P}(x=j|\\tilde{x}=i)=A(j|i)$ . ", "page_idx": 3}, {"type": "text", "text": "The distribution of the generated token, which we call the generation distribution, can be computed as follows: ", "page_idx": 3}, {"type": "equation", "text": "$$\n\\mathcal{P}(x=j)=\\sum_{i\\in\\Sigma}\\mathcal{P}(x=j|\\tilde{x}=i)\\mathcal{P}(\\tilde{x}=i)=\\sum_{i\\in\\Sigma}A(j|i)R_{E}^{\\prime}(Q)(i)=(A\\circ R_{E}^{\\prime}(Q))(j).\n$$", "text_format": "latex", "page_idx": 3}, {"type": "text", "text": "We denote the generation distribution by $\\widehat{R}_{E}(P)=A\\circ R_{E}^{\\prime}(Q)$ . ", "page_idx": 3}, {"type": "text", "text": "To ensure that the two reweight framework produces an unbiased output distribution, we require that for all $P\\in\\Delta_{\\Sigma}$ : ", "page_idx": 3}, {"type": "equation", "text": "$$\n\\mathbb{E}_{E\\sim P_{E}}[\\widehat{R}_{E}(P)]=P.\n$$", "text_format": "latex", "page_idx": 3}, {"type": "text", "text": "4 No-go Theorem ", "text_level": 1, "page_idx": 3}, {"type": "text", "text": "Despite the potential of the two reweight framework, we present a no-go theorem that shows the impossibility of simultaneously maintaining the watermark strength and sampling efficiency when the vocabulary size is greater than two. ", "page_idx": 3}, {"type": "text", "text": "Theorem 1 (No-go Theorem). When the vocabulary size $|\\Sigma|>2,$ , there do not exist non-trivial reweighting functions $R:{\\mathcal{E}}\\times\\Delta_{\\Sigma}\\to\\Delta_{\\Sigma}$ and $R^{\\prime}:\\mathcal{E}\\times\\Delta_{\\Sigma}\\overset{\\cdot}{\\to}\\Delta_{\\Sigma}$ , and a speculative process $A(j|i)$ such that for all $P,Q\\in\\Delta_{\\Sigma}$ : ", "page_idx": 3}, {"type": "text", "text": "1. The watermark strength is maintained: $\\widehat{R}_{E}(P)=R_{E}(P)$ .   \n2. The sampling efficiency is maintained: $\\begin{array}{r}{\\alpha(P,Q)=\\mathbb{E}_{E\\sim P_{E}}[\\sum_{i\\in\\Sigma}A(i|i)R_{E}^{\\prime}(Q)(i)].}\\end{array}$ . ", "page_idx": 3}, {"type": "text", "text": "Remark 2 (Condition for maintaining the watermark strength). The condition $\\widehat{R}_{E}(P)=R_{E}(P)$ in Theorem $^{\\,I}$ ensures that the watermark strength is maintained by keeping the average watermark score unchanged, i.e., ", "page_idx": 3}, {"type": "equation", "text": "$$\n\\underbrace{\\mathbb{E}_{E\\sim P_{E}}\\mathbb{E}_{t\\sim R_{E}(P)}[S c o r e(t,E)]}_{w:=}=\\underbrace{\\mathbb{E}_{E\\sim P_{E}}\\mathbb{E}_{t\\sim\\hat{R}_{E}(P)}[S c o r e(t,E)]}_{w^{\\prime}:=\\\n$$", "text_format": "latex", "page_idx": 3}, {"type": "text", "text": "where $S c o r e(t,E)$ is an arbitrary function that measures the watermark strength. ", "page_idx": 4}, {"type": "text", "text": "Strictly speaking, to ensure that the watermark strength remains unchanged, we only need to require $w=w^{\\prime}$ , and the condition $\\widehat{R}_{E}(P)=R_{E}(P)$ is a sufficient condition. However, due to the large design space of scoring fun ctions, $i f$ we want to maintain $w\\,=\\,w^{\\prime}$ for every possible score, then $\\widehat{R}_{E}(P)=R_{E}(P)$ becomes a necessary condition. ", "page_idx": 4}, {"type": "text", "text": "On the other hand, for a fixed scoring function and a specific $R_{E}$ , it is possible that $\\widehat{R}_{E}(P)\\neq R_{E}(P)$ while $w\\,=\\,w^{\\prime}$ or even $w\\,<\\,w^{\\prime}$ . In other words, the condition $\\widehat{R}_{E}(P)\\,=\\,R_{E}(P)$ is not always necessary for maintaining the watermark strength for a specific scoring function and reweighting function. ", "page_idx": 4}, {"type": "text", "text": "The proof of the no-go theorem relies on the following two lemmas, which reveal the connections between maintaining the sampling efficiency, maintaining the watermark strength, and the properties of the reweighting functions. ", "page_idx": 4}, {"type": "text", "text": "Lemma 3 (Maintaining Sampling Efficiency Implies Unbiased Watermarked Draft Model). If for all $P,Q\\in\\Delta_{\\Sigma}$ , we have ", "page_idx": 4}, {"type": "equation", "text": "$$\n\\alpha(P,Q)=\\mathbb{E}_{E\\sim P_{E}}\\left[\\sum_{i\\in\\Sigma}A(i|i)R_{E}^{\\prime}(Q)(i)\\right],\n$$", "text_format": "latex", "page_idx": 4}, {"type": "text", "text": "then $\\mathbb{E}_{E\\sim P_{E}}[R_{E}^{\\prime}(Q)]=Q$ for all $Q\\in\\Delta_{\\Sigma}$ . ", "page_idx": 4}, {"type": "text", "text": "Lemma 4 (Maintaining Watermark Strength and Sampling Efficiency Implies Same Reweight Function). Under the two reweight framework, if for all $P,Q\\in\\Delta_{\\Sigma}$ , we have ", "page_idx": 4}, {"type": "equation", "text": "$$\n\\alpha(P,Q)=\\mathbb{E}_{E\\sim P_{E}}\\left[\\sum_{i\\in\\Sigma}A(i|i)R_{E}^{\\prime}(Q)(i)\\right],\\qquad\\widehat{R}_{E}(P)=R_{E}(P),\n$$", "text_format": "latex", "page_idx": 4}, {"type": "text", "text": "then $R_{E}^{\\prime}(Q)=R_{E}(Q)$ for all $Q\\in\\Delta_{\\Sigma}$ . ", "page_idx": 4}, {"type": "text", "text": "The proofs of these lemmas are deferred to Appendix B. With these lemmas, we can now prove the no-go theorem. ", "page_idx": 4}, {"type": "text", "text": "Proof of Theorem 1. According to Lemma 4, maintaining both the watermark strength and sampling efficiency under the two reweight framework implies that $R_{E}^{\\prime}(Q)\\;=\\;R_{E}(Q)$ for all $Q\\ \\in\\ \\Delta_{\\Sigma}$ . Therefore, we have ", "page_idx": 4}, {"type": "equation", "text": "$$\n\\alpha(P,Q)\\leq\\mathbb{E}_{E\\sim P_{E}}[\\alpha(R_{E}(P),R_{E}(Q))].\n$$", "text_format": "latex", "page_idx": 4}, {"type": "text", "text": "To see this, note that ", "page_idx": 4}, {"type": "equation", "text": "$$\n\\begin{array}{r l r}{\\lefteqn{R_{E}(P)(i)=\\widehat{R}_{E}(P)(i)=\\sum_{j}A(i|j)R_{E}(Q)(j)\\geq A(i|i)R_{E}(Q)(i),}}\\\\ &{}&{\\quad\\quad\\quad R_{E}(Q)(i)\\geq A(i|i)R_{E}(Q)(i),\\quad\\quad\\quad}\\\\ &{}&{\\quad\\quad\\quad A(i|i)R_{E}(Q)(i)\\leq\\operatorname*{min}(R_{E}(Q)(i),R_{E}(P)(i)).}\\end{array}\n$$", "text_format": "latex", "page_idx": 4}, {"type": "text", "text": "Summing over $i$ , we get ", "page_idx": 4}, {"type": "equation", "text": "$$\n\\sum_{i}A(i|i)R_{E}(Q)(i)\\leq\\sum_{i}\\operatorname*{min}(R_{E}(Q)(i),R_{E}(P)(i))=\\alpha(R_{E}(Q),R_{E}(P)).\n$$", "text_format": "latex", "page_idx": 4}, {"type": "text", "text": "Taking the expectation over $E$ , we obtain Equation (6). ", "page_idx": 4}, {"type": "text", "text": "Recall that $\\alpha(P,Q)=1-\\mathrm{TV}(P,Q)$ , where $\\mathrm{TV}(P,Q)$ denotes the total variation distance between $P$ and $Q$ . Therefore, Equation (6) is equivalent to ", "page_idx": 4}, {"type": "equation", "text": "$$\n\\mathrm{TV}(P,Q)\\geq\\mathbb{E}_{E\\sim P_{E}}[\\mathrm{TV}(R_{E}(P),R_{E}(Q))].\n$$", "text_format": "latex", "page_idx": 4}, {"type": "text", "text": "Viewing $P,Q\\in\\Delta_{\\Sigma}$ as $n$ -dimensional vectors, where $n=|\\Sigma|$ , we can express the total variation distance as ", "page_idx": 4}, {"type": "equation", "text": "$$\n2\\,\\mathrm{TV}(P,Q)=\\operatorname*{max}_{u\\in[-1,1]^{n}}\\langle u,P-Q\\rangle,\n$$", "text_format": "latex", "page_idx": 4}, {"type": "text", "text": "where the maximum is attained at $u^{*}(P,Q)=\\mathrm{sign}(P-Q)$ . Using this expression, we have ", "page_idx": 5}, {"type": "equation", "text": "$$\n\\begin{array}{r l}&{\\mathbb{E}_{E\\sim P_{E}}2\\operatorname{TV}(R_{E}(P),R_{E}(Q))=\\mathbb{E}_{E\\sim P_{E}}\\left[\\underset{u\\in[-1,1]^{n}}{\\operatorname*{max}}\\langle u,R_{E}(P)-R_{E}(Q)\\rangle\\right]}\\\\ &{\\qquad\\qquad\\qquad\\qquad\\geq\\mathbb{E}_{E\\sim P_{E}}\\langle u^{*}(P,Q),R_{E}(P)-R_{E}(Q)\\rangle}\\\\ &{\\qquad\\qquad\\qquad=\\langle u^{*}(P,Q),P-Q\\rangle=2\\operatorname{TV}(P,Q).}\\end{array}\n$$", "text_format": "latex", "page_idx": 5}, {"type": "text", "text": "Combining Equations (7) and (10), we conclude that the equality in Equation (9) must hold, which is equivalent to ", "page_idx": 5}, {"type": "equation", "text": "$$\nu^{*}(P,Q)\\in\\mathrm{Argmax}_{u\\in[-1,1]^{n}}\\langle u,R_{E}(P)-R_{E}(Q)\\rangle,\n$$", "text_format": "latex", "page_idx": 5}, {"type": "text", "text": "almost surely for random $E$ . This condition is equivalent to the following: ", "page_idx": 5}, {"type": "equation", "text": "$$\n\\begin{array}{r l}&{(P-Q)(i)=0\\implies(R_{E}(P)-R_{E}(Q))(i)=0,}\\\\ &{(P-Q)(i)\\ge0\\implies(R_{E}(P)-R_{E}(Q))(i)\\ge0,}\\\\ &{(P-Q)(i)\\le0\\implies(R_{E}(P)-R_{E}(Q))(i)\\le0,}\\end{array}\n$$", "text_format": "latex", "page_idx": 5}, {"type": "text", "text": "almost surely for random $E$ and for all $i\\in\\Sigma$ . ", "page_idx": 5}, {"type": "text", "text": "Now, let us label the symbols in the vocabulary $\\Sigma$ as $i\\;\\in\\;\\{1,\\ldots,n\\}$ . For a distribution ${\\cal P}\\,=$ $(p_{1},p_{2},\\ldots,p_{n})$ , define ", "page_idx": 5}, {"type": "equation", "text": "$$\nT_{i}(j)=\\left\\{\\!\\!\\begin{array}{l l}{p_{i}}&{j=i,}\\\\ {1-p_{i}}&{j=i\\operatorname{mod}n+1,}\\\\ {0}&{\\mathrm{otherwise}.}\\end{array}\\!\\right.\n$$", "text_format": "latex", "page_idx": 5}, {"type": "text", "text": "For example, $T_{1}\\ =\\ (p_{1},1\\,-\\,p_{1},0,\\ldots,0)$ , $T_{2}\\ =\\ (0,p_{2},1\\,-\\,p_{2},0,\\ldots,0)$ , and ${\\cal T}_{n}~=~(1~-$ $p_{n},0,\\ldots,0,p_{n})$ . Let functions $F_{i}(p_{i})=R_{E}(T_{i})(i)$ . We claim that ", "page_idx": 5}, {"type": "equation", "text": "$$\nR_{E}(P)(i)=F_{i}(p_{i}).\n$$", "text_format": "latex", "page_idx": 5}, {"type": "text", "text": "To see this, note that $(P\\!-\\!T_{i})(i)=p_{i}\\!-\\!p_{i}=0$ , so by Equation (12), we have $(R_{E}(P){-}R_{E}(T_{i}))(i)=$ 0, which implies $R_{E}(P)(i)=R_{E}(T_{i})(i)=F_{i}(p_{i})$ almost surely. ", "page_idx": 5}, {"type": "text", "text": "Next, we show that the functions $F_{i}$ satisfy the following properties: ", "page_idx": 5}, {"type": "equation", "text": "$$\n{\\begin{array}{r l}&{F_{i}(0)=0,}\\\\ &{F_{i}(1)=1,}\\\\ &{F_{i}(p){\\mathrm{~is~monotonically~increasing~in~}}p,}\\\\ &{\\displaystyle\\sum_{i}p_{i}=1\\implies\\sum_{i}F_{i}(p_{i})=1.}\\end{array}}\n$$", "text_format": "latex", "page_idx": 5}, {"type": "text", "text": "To prove Equation (16), consider the case when $p_{i}=0$ . In this case, $T_{i}(j)=1$ if $j=i\\,\\mathrm{mod}\\,n+1$ and $T_{i}(j)\\stackrel{!}{=}0$ otherwise. To ensure the unbiasedness of the reweighting function, we must have $\\mathbb{E}_{E\\sim P_{E}}[R_{E}(T_{i})]=T_{i}$ , which implies $R_{E}(T_{i})=T_{i}$ almost surely. Therefore, $R_{E}(T_{i})(i)=T_{i}(i)=$ $p_{i}=0$ , and thus $F_{i}(0)=0$ . ", "page_idx": 5}, {"type": "text", "text": "Similarly, to prove Equation (17), consider the case when $p_{i}~=~1$ . In this case, $T_{i}(j)\\,=\\,1$ if $j\\,=\\,i$ and $T_{i}(j)\\,=\\,0$ otherwise. Again, to ensure the unbiasedness of the reweighting function, we must have $\\mathop{\\mathbb{E}}_{E\\sim P_{E}}[R_{E}(T_{i})]\\ =\\ T_{i}$ , which implies $R_{E}(T_{i})\\ =\\ T_{i}$ almost surely. Therefore, $R_{E}(T_{i})(i)=T_{i}(i)=\\tilde{p_{i}}=\\dot{1}$ , and thus $F_{i}(1)=1$ . ", "page_idx": 5}, {"type": "text", "text": "To prove Equation (18), consider two values $p_{i}\\geq p_{i}^{\\prime}$ . Define $T_{i}$ and $T_{i}^{\\prime}$ as follows: ", "page_idx": 5}, {"type": "equation", "text": "$$\nT_{i}(j)={\\left\\{\\begin{array}{l l}{p_{i}}&{j=i,}\\\\ {1-p_{i}}&{j=i\\,{\\bmod{n}}+1,}\\\\ {0}&{{\\mathrm{otherwise}},}\\end{array}\\right.}\\quad\\quad T_{i}^{\\prime}(j)={\\left\\{\\begin{array}{l l}{p_{i}^{\\prime}}&{j=i,}\\\\ {1-p_{i}^{\\prime}}&{j=i\\,{\\bmod{n}}+1,}\\\\ {0}&{{\\mathrm{otherwise}}.}\\end{array}\\right.}\n$$", "text_format": "latex", "page_idx": 5}, {"type": "text", "text": "Since $p_{i}\\,-\\,p_{i}^{\\prime}\\,=\\,(T_{i}\\,-\\,T_{i}^{\\prime})(i)\\,\\geq\\,0$ , by Equation (13), we have $F_{i}(p_{i})\\,-\\,F_{i}(p_{i}^{\\prime})\\,=\\,(R_{E}(T_{i})\\,-\\,$ $R_{E}(T_{i}^{\\prime}))(i)\\geq0$ , which proves the monotonicity of $F_{i}$ . ", "page_idx": 5}, {"type": "text", "text": "To prove Equation (19), notice that due to Equation (15), we have $\\begin{array}{r}{\\sum_{i}F_{i}(p_{i})=\\sum_{i}R_{E}(P)(i)=1}\\end{array}$ . Finally, according to Lemma 8, the functions $F_{i}$ satisfying Equations (16) to (19) must be the identity function, i.e., $F_{i}{\\bar{(}}p)=p$ for all $i\\in\\{1,2,\\dots,n\\}$ and $p\\in[0,1]$ . Combining this with Equation (15), ", "page_idx": 5}, {"type": "text", "text": "we conclude that $R_{E}(P)\\,=\\,P$ almost surely for random $E$ , which means that the reweighting function $R_{E}$ is trivial. ", "page_idx": 6}, {"type": "text", "text": "Therefore, when the vocabulary size $|\\Sigma|\\,>\\,2$ , it is impossible to simultaneously maintain the watermark strength and sampling efficiency using non-trivial reweighting functions under the two reweight framework. \u53e3 ", "page_idx": 6}, {"type": "text", "text": "5 Algorithms for Maintaining Watermark Strength or Sampling Efficiency ", "text_level": 1, "page_idx": 6}, {"type": "text", "text": "Algorithm 1 Maintaining Watermark Strength or Sampling Efficiency Given draft sequence length $K$ , prompt $x_{1},\\ldots,x_{n}$ , target model $P(\\cdot|\\cdot)$ , draft model $Q(\\cdot|\\cdot)$ , code history $c c h$ as a list of context code, context code function $c c:\\Sigma^{*}\\,\\to\\,C$ , watermark code generation function $\\hat{E}:C\\times Z\\to\\mathcal{E}$ , reweighting functions $R:{\\mathcal{E}}\\times\\Delta_{\\Sigma}\\to\\Delta_{\\Sigma},$ , and key for watermark $z\\in Z$ . Initialize draft context code history $\\widetilde{c c h}\\gets c c h$ . for $t=1:K+1$ do Compute context code $c_{t}=c c(x_{1},\\ldots,x_{n},\\tilde{x}_{1},\\ldots,\\tilde{x}_{t-1})$ , watermark code $E_{t}=\\hat{E}(c_{t},z)$ . Check skipped $s k i p p e d_{t}=\\left\\{\\begin{array}{l l}{\\begin{array}{r l r}\\end{array}}\\\\ {\\begin{array}{r l r}\\end{array}}\\end{array}\\right.$ true ct exists in $\\widetilde{c c h}$ , Set $\\widetilde{c c h}\\gets\\widetilde{c c h}+[c_{t}]$ . false ct doesn\u2019t exists in $c c h$ . if $t=K+1$ then Exit for loop. end if Compute distribution $Q_{t}(\\cdot)=Q(\\cdot|x_{1},\\ldots,x_{n},\\tilde{x}_{1},\\ldots,\\tilde{x}_{t-1})$ . Let Qt = $\\mathfrak{Q}_{t}=\\left\\{\\begin{array}{l l}{Q_{t}}&{s k i p p e d_{t}=\\mathrm{true},}\\\\ {R_{E_{t}}(Q_{t})}&{s k i p p e d_{t}=\\mathrm{false}}\\end{array}\\right.$ skippedt = true, Sample draft token x\u02dct \u223cQt. . end for for $t=1:K+1$ in parallel do Compute distribution $P_{t}(\\cdot)=P(\\cdot|x_{1},\\ldots,x_{n},\\tilde{x}_{1},\\ldots,\\tilde{x}_{t-1}).$ . Let $\\mathfrak{P}_{t}=\\left\\{\\overset{\\displaystyle P_{t}}{\\romannumeral1}\\quad\\quad\\quad\\quad s k i p p e d_{t}=\\mathrm{true},\\mathfrak{\\quad}$ . end for $(\\mathbb{P}_{t},\\mathbb{Q}_{t})=\\left\\{{\\mathfrak{P}}_{t},{\\mathfrak{Q}}_{t}\\right\\}$ maintain watermark strength, Initialize empty output list: $o u t\\gets[]$ . Let maintain sampling efficiency. for $t=1:K$ do if $\\begin{array}{r}{r<\\operatorname*{min}(1,\\frac{\\mathbb{P}_{t}(\\tilde{x}_{t})}{\\mathbb{Q}_{t}(\\tilde{x}_{t})})}\\end{array}$ $c c h\\gets c c h+[c_{t}]$ $r\\sim U[0,1]$ $o u t\\gets o u t+[\\tilde{x}_{t}]$ $x_{n+t}\\sim(\\mathbb{P}_{t}-\\mathbb{Q}_{t})_{+}$ $o u t\\gets o u t+[x_{n+t}]$ end if end for if $o u t=[\\Tilde{x}_{1},\\dots,\\Tilde{x}_{K}]$ then Set $c c h\\leftarrow c c h+[c_{K+1}]$ . Sample $x_{n+K+1}\\sim\\mathfrak{P}_{K+1}$ . Set $o u t\\leftarrow o u t+[x_{n+K+1}].$ end if Return out as generated tokens, and $c c h$ as context code history. ", "page_idx": 6}, {"type": "text", "text": "In this section, we present two algorithms that aim to maintain either the watermark strength or the sampling efficiency under the two reweight framework. In light of the no-go theorem (Theorem 1), which precludes the simultaneous maintenance of watermark strength and sampling efficiency, these algorithms provide deeper insights into the trade-offs between the two objectives. ", "page_idx": 6}, {"type": "text", "text": "5.1 Maintaining Watermark Strength ", "text_level": 1, "page_idx": 6}, {"type": "text", "text": "To maintain the watermark strength, we choose the reweight function for draft distribution to be the same as the reweight function for the target distribution, i.e., $R_{E}^{\\prime}(Q)=R_{E}(Q)$ . The speculative process is designed as follows: ", "page_idx": 6}, {"type": "equation", "text": "$$\n\\begin{array}{r}{A(j|i)=\\left\\{\\begin{array}{l l}{\\operatorname*{min}(1,\\frac{R_{E}(P)(i)}{R_{E}(Q)(i)})}&{\\mathrm{if~}i=j,}\\\\ {\\frac{(1-\\frac{R_{E}(P)(i)}{R_{E}(Q)(i)})+\\left(R_{E}(P)(j)-R_{E}(Q)(j)\\right)_{+}}{\\sum_{z\\in\\Sigma}(R_{E}(Q)(z)-R_{E}(P)(z))_{+}}}&{\\mathrm{if~}i\\neq j.}\\end{array}\\right.}\\end{array}\n$$", "text_format": "latex", "page_idx": 6}, {"type": "text", "text": "Theorem 5 (Maintaining Watermark Strength). Under the two reweight framework, if $R_{E}^{\\prime}(Q)=$ $R_{E}(Q)$ and the speculative process $A(j|i)$ is defined as in Equation (20), then the watermark strength is maintained, i.e., $\\widehat{R}_{E}(P)=R_{E}(P)$ . Moreover, the generation distribution is unbiased, i.e., $\\mathbb{E}_{E\\sim P_{E}}[\\widehat{R}_{E}(P)]=P$ for all $P\\in\\Delta_{\\Sigma}$ . ", "page_idx": 7}, {"type": "text", "text": "Intuitively, this algorithm applies the same reweighting function $R_{E}$ to both the draft distribution $Q$ and the target distribution $P$ , and then performs speculative sampling based on the reweighted distributions $R_{E}(Q)$ and $R_{E}(P)$ as draft and target distribution. ", "page_idx": 7}, {"type": "text", "text": "5.2 Maintaining Sampling Efficiency ", "text_level": 1, "page_idx": 7}, {"type": "text", "text": "To maintain the sampling efficiency, we again choose the reweight function for draft distribution to be the same as the reweight function for the target distribution, i.e., $R_{E}^{\\prime}(Q)=R_{E}(Q)$ . However, the speculative process is designed differently: ", "page_idx": 7}, {"type": "equation", "text": "$$\nA(j|i)={\\left\\{\\begin{array}{l l}{\\operatorname*{min}(1,{\\frac{P(j)}{Q(i)}})}&{{\\mathrm{if~}}i=j,}\\\\ {{\\frac{(1-{\\frac{P(i)}{Q(i)}})_{+}(P(j)-Q(j))_{+}}{\\sum_{z\\in\\Sigma}(Q(z)-P(z))_{+}}}}&{{\\mathrm{if~}}i\\neq j.}\\end{array}\\right.}\n$$", "text_format": "latex", "page_idx": 7}, {"type": "text", "text": "Theorem 6 (Maintaining Sampling Efficiency). Under the two reweight framework, if $R_{E}^{\\prime}(Q)=$ $R_{E}(Q)$ and the speculative process $A(j|i)$ is defined as in Equation (21), then the sampling efficiency is maintained, i.e., $\\begin{array}{r}{\\sigma(P,Q)\\,=\\,\\check{\\mathbb{E}}_{E\\sim P_{E}}[\\sum_{i\\in\\Sigma}A(i|i)R_{E}^{\\bar{\\prime}}(Q)(i)]}\\end{array}$ . Moreover, the generation distribution is unbiased, i.e., $\\mathbb{E}_{E\\sim P_{E}}[\\widehat{R}_{E}(P)]=P$ for all $P\\in\\Delta_{\\Sigma}$ . ", "page_idx": 7}, {"type": "text", "text": "Intuitively, this algorithm generates a watermarked draft token using the watermarked draft distribution $R_{E}(Q)$ , and then performs the standard speculative sampling process using the original distributions $Q$ and $P$ as draft and target distribution. ", "page_idx": 7}, {"type": "text", "text": "5.3 Algorithms ", "text_level": 1, "page_idx": 7}, {"type": "text", "text": "The pseudo code for the two methods described in the previous sections is provided in Algorithm 1. This pseudo code applies the methods in previous sections for multiple times in each step, and also considers the context code history to ensure unbiasedness for the whole sequence. For reference, similar pseudo code for basic sampling, vanilla speculative sampling and vanilla unbiased watermarking is provided in Algorithms 2 to 4. ", "page_idx": 7}, {"type": "text", "text": "Remark 7 (Context code history). According to [12], the context code history is crucial for ensuring the unbiasedness of the entire generated sequence. In both algorithms, all accepted draft tokens\u2019 context codes need to be preserved in the context code history. Additionally, when a draft token is rejected, its context code should also be preserved because the newly generated random token after rejection, i.e. $x_{n+t}$ , is not independent of the rejected random draft token $\\tilde{x}_{t}$ . By preserving the right context code history, we ensures that not only the distribution of a single token, but also the distribution of the entire generated sequence is unbiased. During computing watermark score for detection, a context code history is also necessary so that each context code only contributes to the watermark score once. ", "page_idx": 7}, {"type": "text", "text": "6 Experiments ", "text_level": 1, "page_idx": 7}, {"type": "text", "text": "To verify that Algorithm 1 can indeed maintain either the watermark strength or the sampling efficiency as claimed, we test different methods on a text summarization task on CNN_DAILYMAIL dataset [33, 10] using the Llama-7b model [42] as the target model and the Llama-68m model [25] as the draft model. ", "page_idx": 7}, {"type": "text", "text": "We measure the sampling efficiency by the number of accepted tokens in the out list of Algorithm 1, and report the Average Accepted Tokens Per Step (AATPS). A higher AATPS indicates a higher sampling efficiency. ", "page_idx": 7}, {"type": "text", "text": "To measure the watermark strength, we compute the log P-value. For likelihood-based scores, the computation follows the method in [12]. For likelihood-agnostic scores, we use U score with the Chernoff bound in Equation (1), where $\\lambda$ is optimized numerically. We test the watermark strength for both the DeltaGumbel reweight and the Gamma reweight schemes. The Average Negative Log P-value Per Token (ANLPPT) is reported, with a higher value indicating a stronger watermark. ", "page_idx": 7}, {"type": "table", "img_path": "6YKMBUiIsG/tmp/e2c599ba96054eeccf2c789dd9f2c761a21796de5eae7723b82af2f9b47c348c.jpg", "table_caption": ["(a) DeltaGumbel Reweight "], "table_footnote": [], "page_idx": 8}, {"type": "image", "img_path": "6YKMBUiIsG/tmp/c635bd303f55a14f6c82bd5c96d7753fc6ae86ebe77e2a39f90db7009cfb98e1.jpg", "img_caption": ["(b) Gamma Reweight ", "Figure 2: Comparison of different methods. The x-axis shows the Average Accepted Tokens Per Step (AATPS) as a measure of speculative sampling efficiency, while y-axis shows the Average Negative Log P-value Per Token (ANLPPT) as a measure of watermark strength. The P-value is computed based on either a likelihood-based test using the maximin-LLR score (left) or a likelihood-agnostic test using the U score (right). Watermarking is performed using either the DeltaGumbel reweight (top) or the Gamma reweight (bottom). Error bars represent $3\\sigma$ confidence intervals1. "], "img_footnote": [], "page_idx": 8}, {"type": "text", "text": "", "page_idx": 8}, {"type": "text", "text": "The results are shown in Figure 2. We compare the performance of Basic Sampling, Vanilla Unbiased Watermark (VUW), Vanilla Speculative Sampling (VSpS), Maintain Watermark Strength (MWS), and Maintain Sampling Efficiency (MSE). ", "page_idx": 8}, {"type": "text", "text": "We also measure the Per Token Time (PTT) in millisecond to evaluate the wall-time latency and verify that Algorithm 1 can indeed achieve acceleration compared to the vanilla unbiased watermark method. The Log Perplexity (LOGPPL) is computed to verify that all algorithms produce the same output distribution and do not affect the quality of the language model output. The raw data for these additional metrics are provided in Table 1 in the appendix due to space constraints. ", "page_idx": 8}, {"type": "text", "text": "We also conduct additional experiments using different models and tasks. In addition to the Llama-7b model, we test the Llama-13b model [42] as the target model, with Llama- $.68\\mathrm{m}$ [25] as the draft model. Besides the text summarization task, we also evaluate the methods on an open-ended text generation task. The results of these additional experiments are provided in Appendix H. The total computational cost for reproducing all the experiments in this paper is approximately 1200 A6000 GPU hours. ", "page_idx": 8}, {"type": "text", "text": "\u2022 Algorithm 1 can indeed maintain either the watermark strength or the sampling efficiency as claimed. The MWS method achieves the same watermark strength as the VUW method, while the MSE method achieves the same sampling efficiency as the VSpS method.   \n\u2022 Algorithm 1 can indeed accelerate the generation process compared to the vanilla unbiased watermark method. Both the MWS and MSE methods achieve lower PTT than the VUW method, as shown in Table 1.   \n\u2022 MWS method has only marginal sampling efficiency gap compared to VSpS, while maintain the watermark strength as VUW method, making it highly practical.   \n\u2022 All algorithms produce the same output distribution and do not affect the quality of the language model output, as evidenced by the similar LOGPPL values across all methods in Table 1.   \n\u2022 The above findings are consistent across different draft sequence length $(K=1,2,3,4)$ , different models (Llama-7b and Llama-13b), different tasks (text summarization and open-ended text generation), different reweight schemes (DeltaGumbel and Gamma), and different watermark detection methods (likelihood-based and likelihood-agnostic). Our extensive experiments validate the generality of the findings. ", "page_idx": 9}, {"type": "text", "text": "In summary, our experimental results validate the theoretical findings and demonstrate the effectiveness of the proposed Algorithm 1. ", "page_idx": 9}, {"type": "text", "text": "7 Conclusion ", "text_level": 1, "page_idx": 9}, {"type": "text", "text": "Our work provides a rigorous theoretical foundation for understanding the trade-off between watermark strength and sampling efficiency in the context of accelerated generation of watermarked tokens from large language models. We prove a no-go theorem, showing that non-trivial trade-offs are inevitable when the vocabulary size is greater than two. To explore these trade-offs, we design algorithms that prioritize either watermark strength or sampling efficiency. Our findings contribute to the development of methods for protecting the intellectual property of language models while leveraging the efficiency of speculative sampling techniques. ", "page_idx": 9}, {"type": "text", "text": "Acknowledgments ", "text_level": 1, "page_idx": 9}, {"type": "text", "text": "ZH and HH were partially supported by NSF IIS 2347592, 2347604, 2348159, 2348169, DBI 2405416, CCF 2348306, CNS 2347617. ", "page_idx": 9}, {"type": "text", "text": "References ", "text_level": 1, "page_idx": 9}, {"type": "text", "text": "[1] Scott Aaronson. My ai safety lecture for ut effective altruism. November 2022. URL https: //scottaaronson.blog/?p=6823.   \n[2] Mikhail J Atallah, Victor Raskin, Michael Crogan, Christian Hempelmann, Florian Kerschbaum, Dina Mohamed, and Sanket Naik. Natural language watermarking: Design, analysis, and a proof-of-concept implementation. In Information Hiding: 4th International Workshop, IH 2001 Pittsburgh, PA, USA, April 25\u201327, 2001 Proceedings 4, pages 185\u2013200. Springer, 2001.   \n[3] Jack T Brassil, Steven Low, Nicholas F Maxemchuk, and Lawrence O\u2019Gorman. Electronic marking and identification techniques to discourage document copying. IEEE Journal on Selected Areas in Communications, 13(8):1495\u20131504, 1995.   \n[4] Tianle Cai, Yuhong Li, Zhengyang Geng, Hongwu Peng, Jason D Lee, Deming Chen, and Tri Dao. Medusa: Simple llm inference acceleration framework with multiple decoding heads. arXiv preprint arXiv:2401.10774, 2024.   \n[5] Charlie Chen, Sebastian Borgeaud, Geoffrey Irving, Jean-Baptiste Lespiau, Laurent Sifre, and John Jumper. Accelerating large language model decoding with speculative sampling. arXiv preprint arXiv:2302.01318, 2023.   \n[6] Mark Chen, Jerry Tworek, Heewoo Jun, Qiming Yuan, Henrique Ponde de Oliveira Pinto, Jared Kaplan, Harri Edwards, Yuri Burda, Nicholas Joseph, Greg Brockman, et al. Evaluating large language models trained on code. arXiv preprint arXiv:2107.03374, 2021.   \n[7] Miranda Christ, Sam Gunn, and Or Zamir. Undetectable watermarks for language models. arXiv preprint arXiv:2306.09194, 2023.   \n[8] Pierre Fernandez, Antoine Chaffin, Karim Tit, Vivien Chappelier, and Teddy Furon. Three bricks to consolidate watermarks for large language models. In 2023 IEEE International Workshop on Information Forensics and Security (WIFS), pages 1\u20136. IEEE, 2023.   \n[9] Zhenyu He, Zexuan Zhong, Tianle Cai, Jason D Lee, and Di He. Rest: Retrieval-based speculative decoding. arXiv preprint arXiv:2311.08252, 2023.   \n[10] Karl Moritz Hermann, Tom\u00e1s Kocisk\u00fd, Edward Grefenstette, Lasse Espeholt, Will Kay, Mustafa Suleyman, and Phil Blunsom. Teaching machines to read and comprehend. In Twenty-eighth Conference on Neural Information Processing Systems, pages 1693\u20131701, 2015.   \n[11] Abe Bohan Hou, Jingyu Zhang, Tianxing He, Yichen Wang, Yung-Sung Chuang, Hongwei Wang, Lingfeng Shen, Benjamin Van Durme, Daniel Khashabi, and Yulia Tsvetkov. Semstamp: A semantic watermark with paraphrastic robustness for text generation. arXiv preprint arXiv:2310.03991, 2023.   \n[12] Zhengmian Hu, Lichang Chen, Xidong Wu, Yihan Wu, Hongyang Zhang, and Heng Huang. Unbiased watermark for large language models. arXiv preprint arXiv:2310.10669, 2023.   \n[13] John Kirchenbauer, Jonas Geiping, Yuxin Wen, Jonathan Katz, Ian Miers, and Tom Goldstein. A watermark for large language models. In International Conference on Machine Learning, pages 17061\u201317084. PMLR, 2023.   \n[14] John Kirchenbauer, Jonas Geiping, Yuxin Wen, Manli Shu, Khalid Saifullah, Kezhi Kong, Kasun Fernando, Aniruddha Saha, Micah Goldblum, and Tom Goldstein. On the reliability of watermarks for large language models. arXiv preprint arXiv:2306.04634, 2023.   \n[15] Rohith Kuditipudi, John Thickstun, Tatsunori Hashimoto, and Percy Liang. Robust distortionfree watermarks for language models. arXiv preprint arXiv:2307.15593, 2023.   \n[16] Yaniv Leviathan, Matan Kalman, and Yossi Matias. Fast inference from transformers via speculative decoding. In International Conference on Machine Learning, pages 19274\u201319286. PMLR, 2023.   \n[17] Junyi Li, Tianyi Tang, Wayne Xin Zhao, Jian-Yun Nie, and Ji-Rong Wen. Pre-trained language models for text generation: A survey. ACM Computing Surveys, 56(9):1\u201339, 2024.   \n[18] Xiang Li, Feng Ruan, Huiyuan Wang, Qi Long, and Weijie J Su. A statistical framework of watermarks for large language models: Pivot, detection efficiency and optimal rules. arXiv preprint arXiv:2404.01245, 2024.   \n[19] Yuhui Li, Fangyun Wei, Chao Zhang, and Hongyang Zhang. Eagle: Speculative sampling requires rethinking feature uncertainty. arXiv preprint arXiv:2401.15077, 2024.   \n[20] Aiwei Liu, Leyi Pan, Xuming Hu, Shiao Meng, and Lijie Wen. A semantic invariant robust watermark for large language models. arXiv preprint arXiv:2310.06356, 2023.   \n[21] Yepeng Liu and Yuheng Bu. Adaptive text watermark for large language models. arXiv preprint arXiv:2401.13927, 2024.   \n[22] Yixin Liu, Hongsheng Hu, Xuyun Zhang, and Lichao Sun. Watermarking text data on large language models for dataset copyright protection. arXiv preprint arXiv:2305.13257, 2023.   \n[23] Bei Luo, Raymond YK Lau, Chunping Li, and Yain-Whar Si. A critical review of state-ofthe-art chatbot designs and applications. Wiley Interdisciplinary Reviews: Data Mining and Knowledge Discovery, 12(1), 2022.   \n[24] Hasan Mesut Meral, B\u00fclent Sankur, A Sumru \u00d6zsoy, Tunga G\u00fcng\u00f6r, and Emre Sevin\u00e7. Natural language watermarking via morphosyntactic alterations. Computer Speech & Language, 23(1): 107\u2013125, 2009.   \n[25] Xupeng Miao, Gabriele Oliaro, Zhihao Zhang, Xinhao Cheng, Zeyu Wang, Rae Ying Yee Wong, Zhuoming Chen, Daiyaan Arfeen, Reyna Abhyankar, and Zhihao Jia. Specinfer: Accelerating generative llm serving with speculative inference and token tree verification. arXiv preprint arXiv:2305.09781, 2023.   \n[26] Giovanni Monea, Armand Joulin, and Edouard Grave. Pass: Parallel speculative sampling. arXiv preprint arXiv:2311.13581, 2023.   \n[27] Travis Munyer and Xin Zhong. Deeptextmark: Deep learning based text watermarking for detection of large language model generated text. arXiv preprint arXiv:2305.05773, 2023.   \n[28] Jie Ou, Yueming Chen, and Wenhong Tian. Lossless acceleration of large language model via adaptive n-gram parallel decoding. arXiv preprint arXiv:2404.08698, 2024.   \n[29] Lip Yee Por, KokSheik Wong, and Kok Onn Chee. Unispach: A text-based data hiding method using unicode space characters. Journal of Systems and Software, 85(5):1075\u20131082, 2012.   \n[30] Jie Ren, Han Xu, Yiding Liu, Yingqian Cui, Shuaiqiang Wang, Dawei Yin, and Jiliang Tang. A robust semantics-based watermark for large language model against paraphrasing. arXiv preprint arXiv:2311.08721, 2023.   \n[31] Stefano Giovanni Rizzo, Flavio Bertini, and Danilo Montesi. Content-preserving text watermarking through unicode homoglyph substitution. In Proceedings of the 20th International Database Engineering & Applications Symposium, pages 97\u2013104, 2016.   \n[32] Ryoma Sato, Yuki Takezawa, Han Bao, Kenta Niwa, and Makoto Yamada. Embarrassingly simple text watermarks. arXiv preprint arXiv:2310.08920, 2023.   \n[33] Abigail See, Peter J. Liu, and Christopher D. Manning. Get to the point: Summarization with pointer-generator networks. In Proceedings of the 55th Annual Meeting of the Association for Computational Linguistics (Volume 1: Long Papers), pages 1073\u20131083, Vancouver, Canada, July 2017. Association for Computational Linguistics. doi: 10.18653/v1/P17-1099.   \n[34] Benjamin Spector and Chris Re. Accelerating llm inference with staged speculative decoding. arXiv preprint arXiv:2308.04623, 2023.   \n[35] Hanshi Sun, Zhuoming Chen, Xinyu Yang, Yuandong Tian, and Beidi Chen. Triforce: Lossless acceleration of long sequence generation with hierarchical speculative decoding. arXiv preprint arXiv:2404.11912, 2024.   \n[36] Zhensu Sun, Xiaoning Du, Fu Song, Mingze Ni, and Li Li. Coprotector: Protect open-source code against unauthorized training usage with data poisoning. In Proceedings of the ACM Web Conference 2022, pages 652\u2013660, 2022.   \n[37] Zhensu Sun, Xiaoning Du, Fu Song, and Li Li. Codemark: Imperceptible watermarking for code datasets against neural code completion models. In Proceedings of the 31st ACM Joint European Software Engineering Conference and Symposium on the Foundations of Software Engineering, pages 1561\u20131572, 2023.   \n[38] Ziteng Sun, Jae Hun Ro, Ahmad Beirami, and Ananda Theertha Suresh. Optimal block-level draft verification for accelerating speculative decoding. arXiv preprint arXiv:2403.10444, 2024.   \n[39] Ruixiang Tang, Qizhang Feng, Ninghao Liu, Fan Yang, and Xia Hu. Did you train on my dataset? towards public dataset protection with cleanlabel backdoor watermarking. ACM SIGKDD Explorations Newsletter, 25(1):43\u201353, 2023.   \n[40] Mercan Topkara, Umut Topkara, and Mikhail J Atallah. Words are not enough: sentence level natural language watermarking. In Proceedings of the 4th ACM international workshop on Contents protection and security, pages 37\u201346, 2006.   \n[41] Umut Topkara, Mercan Topkara, and Mikhail J Atallah. The hiding virtues of ambiguity: quantifiably resilient watermarking of natural language text through synonym substitutions. In Proceedings of the 8th workshop on Multimedia and security, pages 164\u2013174, 2006.   \n[42] Hugo Touvron, Thibaut Lavril, Gautier Izacard, Xavier Martinet, Marie-Anne Lachaux, Timoth\u00e9e Lacroix, Baptiste Rozi\u00e8re, Naman Goyal, Eric Hambro, Faisal Azhar, et al. Llama: Open and efficient foundation language models. arXiv preprint arXiv:2302.13971, 2023.   \n[43] Lean Wang, Wenkai Yang, Deli Chen, Hao Zhou, Yankai Lin, Fandong Meng, Jie Zhou, and Xu Sun. Towards codable text watermarking for large language models. arXiv preprint arXiv:2307.15992, 2023.   \n[44] Yihan Wu, Zhengmian Hu, Hongyang Zhang, and Heng Huang. Dipmark: A stealthy, efficient and resilient watermark for large language models. arXiv preprint arXiv:2310.07710, 2023.   \n[45] Nan Yang, Tao Ge, Liang Wang, Binxing Jiao, Daxin Jiang, Linjun Yang, Rangan Majumder, and Furu Wei. Inference with reference: Lossless acceleration of large language models. arXiv preprint arXiv:2304.04487, 2023.   \n[46] Sen Yang, Shujian Huang, Xinyu Dai, and Jiajun Chen. Multi-candidate speculative decoding. arXiv preprint arXiv:2401.06706, 2024.   \n[47] Xi Yang, Jie Zhang, Kejiang Chen, Weiming Zhang, Zehua Ma, Feng Wang, and Nenghai Yu. Tracing text provenance via context-aware lexical substitution. In Proceedings of the AAAI Conference on Artificial Intelligence, volume 36, pages 11613\u201311621, 2022.   \n[48] Xi Yang, Kejiang Chen, Weiming Zhang, Chang Liu, Yuang Qi, Jie Zhang, Han Fang, and Nenghai Yu. Watermarking text generated by black-box language models. arXiv preprint arXiv:2305.08883, 2023.   \n[49] KiYoon Yoo, Wonhyuk Ahn, Jiho Jang, and Nojun Kwak. Robust multi-bit natural language watermarking through invariant features. In Proceedings of the 61st Annual Meeting of the Association for Computational Linguistics (Volume 1: Long Papers), pages 2092\u20132115, 2023.   \n[50] KiYoon Yoo, Wonhyuk Ahn, and Nojun Kwak. Advancing beyond identification: Multi-bit watermark for language models. arXiv preprint arXiv:2308.00221, 2023.   \n[51] Xuandong Zhao, Prabhanjan Ananth, Lei Li, and Yu-Xiang Wang. Provable robust watermarking for ai-generated text. arXiv preprint arXiv:2306.17439, 2023.   \n[52] Yongchao Zhou, Kaifeng Lyu, Ankit Singh Rawat, Aditya Krishna Menon, Afshin Rostamizadeh, Sanjiv Kumar, Jean-Fran\u00e7ois Kagy, and Rishabh Agarwal. Distillspec: Improving speculative decoding via knowledge distillation. arXiv preprint arXiv:2310.08461, 2023. ", "page_idx": 9}, {"type": "text", "text": "", "page_idx": 10}, {"type": "text", "text": "", "page_idx": 11}, {"type": "text", "text": "", "page_idx": 12}, {"type": "text", "text": "A Related Works ", "text_level": 1, "page_idx": 13}, {"type": "text", "text": "Our work lies at the intersection of two active research areas: speculative sampling for accelerated inference and watermarking techniques for language models. ", "page_idx": 13}, {"type": "text", "text": "A.1 Speculative Sampling for Accelerated Inference ", "text_level": 1, "page_idx": 13}, {"type": "text", "text": "In the domain of speculative sampling, a common approach is to use a smaller language model as the draft model [16, 5]. Efforts have been made to further increase the overlap between the draft and target models through distillation [52]. Other works focus on modifying the target model itself, such as adding \u201clook ahead\u201d tokens [26], introducing new heads to predict future tokens [4], reusing the computation of the large model to achieve a better latency-overlap trade-off for the draft model [19], or using the target model with partial key-value cache as the draft model [35]. Alternative approaches include using document retrieval [45, 9] or n-gram models [28] as the draft model. ", "page_idx": 13}, {"type": "text", "text": "When the draft sequence length is greater than one, vanilla speculative sampling is known to be suboptimal. Methods have been proposed to amend the verification process for the draft sequence, verifying the entire sequence at once instead of individual tokens, leading to a longer expected number of accepted tokens [38]. ", "page_idx": 13}, {"type": "text", "text": "An extension of speculative sampling is to change the sequence input to a tree input. While typical language models take a sequence as input, which is a path in the symbol tree space, some works modify the input to be a tree with multiple branches. A single forward pass can then obtain probabilities on multiple branches, gathering more information to help accelerate decoding. This requires modifying the transformer implementation to change the causal attention to tree attention [46, 25, 4, 34]. Speculative sampling can also be used repeatedly, with an additional draft model to accelerate the draft model itself [34]. ", "page_idx": 13}, {"type": "text", "text": "Our work is independent of the specific draft model used. While many recent advancements stem from faster and more accurate draft models, our method does not rely on any assumptions about the draft model. A better draft model can always be plugged in to provide faster acceleration. ", "page_idx": 13}, {"type": "text", "text": "The methods in Section 5 of the main text only consider the basic speculative sampling approach and do not take into account other variants such as verifying the entire sequence, tree verification, or multi-candidacy. However, our ideas can be extended to these variants and still maintain either the watermark strength or the sampling efficiency, as discussed in Appendix E. ", "page_idx": 13}, {"type": "text", "text": "A.2 Watermarking Techniques for Language Models ", "text_level": 1, "page_idx": 13}, {"type": "text", "text": "In the domain of watermarking for language models, various approaches have been explored. Some works attempt to edit existing text to embed watermarks [3, 29, 31, 32, 41, 27, 47\u201349, 2, 40, 24]. Others try to incorporate watermarks during the training phase [22, 39, 36, 37]. ", "page_idx": 13}, {"type": "text", "text": "More closely related to our work is the direction of modifying the sampling stage to directly generate watermarked results. Since the pioneering works of Aaronson [1] and Kirchenbauer et al. [13], watermarking techniques have seen significant development. ", "page_idx": 13}, {"type": "text", "text": "To address the bias introduced by watermarking, researchers have proposed skipping watermarking on low-entropy tokens [21, 43] or accumulating entropy during the generation process and only adding a watermark when the accumulated entropy exceeds a threshold [7]. Hu et al. [12] introduced a framework that includes unbiased reweighting and context code history to ensure that the output distribution is strictly unbiased. ", "page_idx": 13}, {"type": "text", "text": "Subsequently, many variants have been proposed, including multi-bit watermarks [50, 8] and more robust watermarking schemes [30, 20, 14, 51, 15, 11]. Efforts have also been made to search for better watermark detection methods [44, 18]. ", "page_idx": 13}, {"type": "text", "text": "Our work builds upon the unbiased watermarking framework of Hu et al. [12] and explores the trade-off between watermark strength and sampling efficiency when integrating watermarking with speculative sampling. To the best of our knowledge, this is the first work to investigate this intersection and provide theoretical insights and practical algorithms for navigating the inherent trade-offs. ", "page_idx": 13}, {"type": "text", "text": "B Proofs ", "text_level": 1, "page_idx": 14}, {"type": "text", "text": "Proof of Lemma $^3$ . Let $P=Q$ . Then we have ", "page_idx": 14}, {"type": "equation", "text": "$$\n1=\\alpha(P,Q)=\\mathbb{E}_{E\\sim P_{E}}\\left[\\sum_{i\\in\\Sigma}A(i|i)R_{E}^{\\prime}(Q)(i)\\right].\n$$", "text_format": "latex", "page_idx": 14}, {"type": "text", "text": "Note that for all $i\\in\\Sigma$ , $A(i|i)\\leq1$ , and thus ", "page_idx": 14}, {"type": "equation", "text": "$$\n\\sum_{i\\in\\Sigma}A(i|i)R_{E}^{\\prime}(Q)(i)\\leq\\sum_{i\\in\\Sigma}R_{E}^{\\prime}(Q)(i)=1.\n$$", "text_format": "latex", "page_idx": 14}, {"type": "text", "text": "Therefore, we must have $A(i|i)=1$ almost surely for random $E$ and for all $i\\in\\Sigma$ . Considering the unbiasedness requirement for the final output distribution, i.e., ", "page_idx": 14}, {"type": "equation", "text": "$$\n\\forall P\\in\\Delta_{\\Sigma},\\mathbb{E}_{E\\sim P_{E}}[A\\circ R_{E}^{\\prime}(Q)]=P,\n$$", "text_format": "latex", "page_idx": 14}, {"type": "text", "text": "we obtain $\\mathbb{E}_{E\\sim P_{E}}[R_{E}^{\\prime}(Q)]=P=Q$ . ", "page_idx": 14}, {"type": "text", "text": "Proof of Lemma 4. Let $P=Q$ . Following the proof of Lemma 3, we have $A(i|i)=1$ almost surely for random $E$ and for all $i\\in\\Sigma$ . Therefore, ", "page_idx": 14}, {"type": "equation", "text": "$$\n\\widehat{R}_{E}(P)=A\\circ R_{E}^{\\prime}(Q)=R_{E}^{\\prime}(Q).\n$$", "text_format": "latex", "page_idx": 14}, {"type": "text", "text": "Since $\\widehat{R}_{E}(P)=R_{E}(P)$ , we conclude that $R_{E}^{\\prime}(Q)=R_{E}(Q)$ ", "page_idx": 14}, {"type": "text", "text": "Lemma 8 (A Function Equation). Given n monotonically increasing functions $F_{i}:[0,1]\\to[0,1]$ for $i\\in\\{1,2,3,\\ldots,n\\}$ , i.e., $x\\geq x^{\\prime}\\implies F_{i}(x)\\geq F_{i}(x^{\\prime}),$ , satisfying ", "page_idx": 14}, {"type": "equation", "text": "$$\n\\begin{array}{l}{\\forall i\\in\\{1,2,3,\\ldots,n\\},F_{i}(0)=0,F_{i}(1)=1,}\\\\ {\\displaystyle\\sum_{i}x_{i}=1\\implies\\sum_{i}F_{i}(x_{i})=1,}\\end{array}\n$$", "text_format": "latex", "page_idx": 14}, {"type": "text", "text": "we have $F_{1}(x)=F_{i}(x)=x$ for all $i\\in\\{1,2,3,\\ldots,n\\}$ and $x\\in[0,1]$ . ", "page_idx": 14}, {"type": "text", "text": "Proof of Lemma 8. We first prove that $F_{1}(x)=F_{2}(x)$ for all $x\\in[0,1]$ . Let $x_{1}=0$ , $x_{2}=1-x_{3}$ , and $x_{i}=0$ for all $i\\geq4$ . We obtain ", "page_idx": 14}, {"type": "equation", "text": "$$\nF_{3}(x_{3})=1-F_{2}(1-x_{3}).\n$$", "text_format": "latex", "page_idx": 14}, {"type": "text", "text": "Next, let $x_{2}=0$ , $x_{3}=1-x_{1}$ , and $x_{i}=0$ for all $i\\geq4$ . This gives us ", "page_idx": 14}, {"type": "equation", "text": "$$\n\\begin{array}{r l}&{F_{1}(x_{1})=1-F_{3}(1-x_{1})}\\\\ &{\\qquad\\qquad=1-(1-F_{2}(1-(1-x_{1})))}\\\\ &{\\qquad\\quad=F_{2}(x_{1}).}\\end{array}\n$$", "text_format": "latex", "page_idx": 14}, {"type": "text", "text": "Similarly, we can show that $F_{1}(x)=F_{i}(x)$ for all $i\\in\\{1,2,3,\\ldots,n\\}$ and $x\\in[0,1]$ . ", "page_idx": 14}, {"type": "text", "text": "Next, we prove that for all $n\\in\\mathbb N$ and $b\\leq2^{n}$ , $\\begin{array}{r}{F_{1}(\\frac{b}{2^{n}})=\\frac{b}{2^{n}}}\\end{array}$ . First, let $\\textstyle x_{1}={\\frac{1}{2}}$ , $\\textstyle x_{2}={\\frac{1}{2}}$ , and $x_{i}=0$ for all $i\\geq3$ . We obtain $\\begin{array}{r}{F_{1}(\\frac{1}{2})=\\frac{1}{2}}\\end{array}$ . ", "page_idx": 14}, {"type": "text", "text": "Assume that for some $n$ , we have $\\begin{array}{r}{F_{1}(\\frac{b}{2^{n}})=\\frac{b}{2^{n}}}\\end{array}$ for all $b\\leq2^{n}$ . We will prove that $\\begin{array}{r}{F_{1}\\big(\\frac{b}{2^{n+1}}\\big)=\\frac{b}{2^{n+1}}}\\end{array}$ for all $b\\leq2^{n+1}$ . ", "page_idx": 14}, {"type": "text", "text": "For $b\\,\\leq\\,2^{n}$ , let $\\textstyle x_{1}\\,=\\,{\\frac{b}{2^{n+1}}}$ 2n+1 , x2 $\\textstyle x_{2}\\;=\\;{\\frac{b}{2^{n+1}}}$ , $\\begin{array}{r}{x_{3}\\,=\\,1\\,-\\,\\frac{b}{2^{n}}}\\end{array}$ , and $x_{i}\\,=\\,0$ for all $i\\geq4$ . We obtain $\\begin{array}{r}{F_{1}\\big(\\frac{b}{2^{n+1}}\\big)=\\frac{b}{2^{n+1}}}\\end{array}$ ", "page_idx": 14}, {"type": "text", "text": "For $2^{n}\\,\\leq\\,b\\,\\leq\\,2^{n+1}$ , let $\\scriptstyle x_{1}\\ =\\ {\\frac{b}{2^{n+1}}}$ 2n+1 , x2 = $\\begin{array}{r}{x_{2}\\,=\\,1\\,-\\,\\frac{b}{2^{n+1}}}\\end{array}$ 2nb+1 , and xi = 0 for all i \u2265 3. We obtain $\\begin{array}{r}{F_{1}\\big(\\frac{b}{2^{n+1}}\\big)=\\frac{b}{2^{n+1}}}\\end{array}$ ", "page_idx": 14}, {"type": "text", "text": "By mathematical induction, we have $\\begin{array}{r}{F_{1}(\\frac{b}{2^{n}})=\\frac{b}{2^{n}}}\\end{array}$ for all $n\\in\\mathbb N$ and $b\\leq2^{n}$ . ", "page_idx": 14}, {"type": "text", "text": "Since $F_{1}$ is monotonically increasing, for all $x\\in[0,1]$ and $n\\in\\mathbb N$ , we have ", "page_idx": 14}, {"type": "equation", "text": "$$\nF_{1}(\\frac{\\lfloor x2^{n}\\rfloor}{2^{n}})\\leq F_{1}(x)\\leq F_{1}(\\frac{\\lceil x2^{n}\\rceil}{2^{n}}).\n$$", "text_format": "latex", "page_idx": 14}, {"type": "text", "text": "Taking the limit as $n\\to\\infty$ , we obtain ", "page_idx": 15}, {"type": "equation", "text": "$$\n\\begin{array}{l}{\\displaystyle\\operatorname*{lim}_{n\\to\\infty}F_{1}(\\frac{\\lfloor x2^{n}\\rfloor}{2^{n}})=x,}\\\\ {\\displaystyle\\operatorname*{lim}_{n\\to\\infty}F_{1}(\\frac{\\lceil x2^{n}\\rceil}{2^{n}})=x.}\\end{array}\n$$", "text_format": "latex", "page_idx": 15}, {"type": "text", "text": "Therefore, $F_{1}(x)=x$ for all $x\\in[0,1]$ , and consequently, $F_{i}(x)=x$ for all $i\\in\\{1,2,3,\\dots,n\\}$ and $x\\in[0,1]$ . \u53e3 ", "page_idx": 15}, {"type": "text", "text": "Proof of Theorem 5. First, we have $\\widehat{R}_{E}(P)=(A\\circ R_{E}^{\\prime})(Q)=(A\\circ R_{E})(Q)$ . For any $j\\in\\Sigma$ , ", "page_idx": 15}, {"type": "equation", "text": "$$\n\\begin{array}{l}{{\\displaystyle\\hat{R}_{E}(P)(j)=\\sum_{i}A(j|i)R_{E}(Q)(i)}}\\\\ {{\\displaystyle\\qquad\\quad\\quad=\\operatorname*{min}(R_{E}(Q)(j),R_{E}(P)(j))}}\\\\ {{\\displaystyle\\qquad\\quad\\quad+\\sum_{i\\neq j}\\frac{\\left(R_{E}(Q)(i)-R_{E}(P)(i)\\right)_{+}\\left(R_{E}(P)(j)-R_{E}(Q)(j)\\right)_{+}}{\\sum_{z\\in\\Sigma}\\left(R_{E}(Q)(z)-R_{E}(P)(z)\\right)_{+}}}}\\\\ {{\\displaystyle\\qquad\\quad\\quad=\\operatorname*{min}(R_{E}(Q)(j),R_{E}(P)(j))+\\left(R_{E}(P)(j)-R_{E}(Q)(j)\\right)_{+}}}\\\\ {{\\displaystyle\\qquad\\quad\\quad=R_{E}(P)(j).}}\\end{array}\n$$", "text_format": "latex", "page_idx": 15}, {"type": "text", "text": "Therefore, $\\widehat{R}_{E}(P)=R_{E}(P)$ , which means the watermark strength is maintained. ", "page_idx": 15}, {"type": "text", "text": "To prove the unbiasedness of the generation distribution, note that for all $P\\in\\Delta_{\\Sigma}$ , ", "page_idx": 15}, {"type": "equation", "text": "$$\n\\mathbb{E}_{E\\sim P_{E}}[\\widehat{R}_{E}(P)]=\\mathbb{E}_{E\\sim P_{E}}[R_{E}(P)]=P,\n$$", "text_format": "latex", "page_idx": 15}, {"type": "text", "text": "where the last equality follows from the unbiasedness of the reweighting function $R_{E}$ . ", "page_idx": 15}, {"type": "text", "text": "Proof of Theorem $6$ . To prove that the sampling efficiency is maintained, we have ", "page_idx": 15}, {"type": "equation", "text": "$$\n\\begin{array}{r l}{\\mathbb{E}_{E\\sim P_{E}}\\left[\\displaystyle\\sum_{i\\in\\Sigma}A(i|i)R_{E}^{\\prime}(Q)(i)\\right]=\\mathbb{E}_{E\\sim P_{E}}\\left[\\displaystyle\\sum_{i\\in\\Sigma}A(i|i)R_{E}(Q)(i)\\right]}\\\\ {=\\displaystyle\\sum_{i\\in\\Sigma}A(i|i)\\mathbb{E}_{E\\sim P_{E}}[R_{E}(Q)(i)]}\\\\ {=\\displaystyle\\sum_{i\\in\\Sigma}A(i|i)Q(i)}\\\\ {=\\displaystyle\\sum_{i\\in\\Sigma}\\operatorname*{min}(Q(i),P(i))}\\\\ {=\\alpha(P,Q).}\\end{array}\n$$", "text_format": "latex", "page_idx": 15}, {"type": "text", "text": "To prove the unbiasedness of the generation distribution, we have for any $j\\in\\Sigma$ , ", "page_idx": 15}, {"type": "equation", "text": "$$\n\\begin{array}{r l}{\\mathbb{E}_{E\\sim P_{E}}[\\widehat{R}_{E}(P)](j)=\\mathbb{E}_{E\\sim P_{E}}\\left[\\displaystyle\\sum_{i}A(j|i)R_{E}(Q)(i)\\right]}&{}\\\\ {=\\displaystyle\\sum_{i}A(j|i)\\mathbb{E}_{E\\sim P_{E}}[R_{E}(Q)](i)}&{}\\\\ {=\\displaystyle\\sum_{i}A(j|i)Q(i)}&{}\\\\ {=\\operatorname*{min}(Q(j),P(j))+\\displaystyle\\sum_{i\\neq j}\\frac{(Q(i)-P(i))_{+}(P(j)-Q(j))_{+}}{\\sum_{z\\in\\mathbb{E}}(Q(z)-P(z))_{+}}}&{}\\\\ {=\\operatorname*{min}(Q(j),P(j))+(P(j)-Q(j))_{+}}&{}\\\\ {=P(j).}&{}\\end{array}\n$$", "text_format": "latex", "page_idx": 15}, {"type": "text", "text": "Therefore, $\\mathbb{E}_{E\\sim P_{E}}[\\widehat{R}_{E}(P)]\\;=\\;P$ for all $P\\ \\in\\ \\Delta_{\\Sigma}$ , which means the generation distribution is unbiased. \u53e3 ", "page_idx": 15}, {"type": "text", "text": "Algorithm 2 Basic Sampling Given generated sequence length $K$ , prompt $x_{1},\\ldots,x_{n}$ , target model $P(\\cdot|\\cdot)$ . Initialize empty output list: $o u t\\gets[]$ . for $t=1:K$ do Compute distribution $P_{t}(\\cdot)=P(\\cdot|x_{1},\\ldots,x_{n},x_{n+1},\\ldots,x_{n+t-1})$ . Sample token $x_{n+t}\\sim P_{t}$ . Set $o u t\\gets o u t+[x_{n+t}]$ . end for Return out as generated tokens. ", "page_idx": 16}, {"type": "text", "text": "Algorithm 3 Vanilla Speculative Sampling ", "text_level": 1, "page_idx": 16}, {"type": "text", "text": "Given draft sequence length $K$ , prompt $x_{1},\\ldots,x_{n}$ , target model $P(\\cdot|\\cdot)$ , and draft model $Q(\\cdot|\\cdot)$ .   \nfor $t=1:K$ do Compute distribution $Q_{t}(\\cdot)=Q(\\cdot|x_{1},\\ldots,x_{n},\\tilde{x}_{1},\\ldots,\\tilde{x}_{t-1})$ . Sample draft token $\\tilde{x}_{t}\\sim Q_{t}$ .   \nend for   \nfor $t=1:K+1$ in parallel do Compute distribution $P_{t}(\\cdot)=P(\\cdot|x_{1},\\ldots,x_{n},\\tilde{x}_{1},\\ldots,\\tilde{x}_{t-1})$ .   \nend for   \nInitialize empty output list: $o u t\\gets[]$ .   \nfor $t=1:K$ do Sample $r\\sim U[0,1]$ from a uniform distribution. if r < min(1, PQtt((x\u02dcx\u02dctt))) then Set $o u t\\leftarrow o u t+[\\tilde{x}_{t}]$ . else Sample $x_{n+t}\\sim(P_{t}-Q_{t})_{+}$ . Set $o u t\\gets o u t+[x_{n+t}]$ . Exit for loop. end if   \nend for   \nif $o u t=[\\Tilde{x}_{1},\\dots,\\Tilde{x}_{K}]$ then Sample $x_{n+K+1}\\sim P_{K+1}$ . Set $o u t\\leftarrow o u t+[x_{n+K+1}]$ .   \nend if   \nReturn out as generated tokens. ", "page_idx": 16}, {"type": "text", "text": "Algorithm 4 Vanilla Unbiased Watermark Method ", "text_level": 1, "page_idx": 16}, {"type": "text", "text": "Given generated sequence length $K$ , prompt $x_{1},\\ldots,x_{n}$ , target model $P(\\cdot|\\cdot)$ , code history cch as   \na list of context code, context code function $c c:\\Sigma^{*}\\to C$ , watermark code generation function   \n$\\hat{E}:C\\times Z\\to\\mathcal{E}$ , reweighting functions $R:{\\mathcal{E}}\\times\\Delta_{\\Sigma}\\to\\Delta_{\\Sigma}$ , and key for watermark $z\\in Z$ .   \nInitialize empty output list: $o u t\\gets[]$ .   \nfor $t=1:K$ do Compute context code $c_{t}=c c(x_{1},\\ldots,x_{n},x_{n+1},\\ldots,x_{n+t-1})$ , watermark code $E_{t}=\\hat{E}(c_{t},z)$ . $s k i p p e d_{t}=\\left\\{\\begin{array}{l l}{\\begin{array}{r l r}\\end{array}}\\end{array}\\right.$ true $c_{t}$ exists in cch, Check skipped Set $c c h\\gets c c h+[c_{t}]$ . false $c_{t}$ doesn\u2019t exists in cch. Compute distribution $P_{t}(\\cdot)=P(\\cdot|x_{1},\\ldots,x_{n},x_{n+1},\\ldots,x_{n+t-1}).$ . Let Pt = $\\mathfrak{P}_{t}=\\left\\{\\overset{\\displaystyle P_{t}}{\\romannumeral1}\\quad\\quad\\quad\\quad s k i p p e d_{t}=\\mathrm{true},\\mathfrak{\\quad}}\\\\ {R_{E_{t}}(P_{t})\\quad s k i p p e d_{t}=\\mathrm{false}}\\end{array}\\right.$ skippedt = true, Sample token xn+t \u223cPt. Set out \u2190out + [xn+t].   \nend for   \nReturn out as generated tokens. ", "page_idx": 16}, {"type": "text", "text": "D U Score, DeltaGubel Reweight, and Gamma Reweight ", "text_level": 1, "page_idx": 16}, {"type": "text", "text": "In this section, we provide detailed definitions of the U score, DeltaGumbel reweight, and Gamma reweight schemes, which are used in the main text to compute the P-value for detecting watermarks. ", "page_idx": 16}, {"type": "text", "text": "D.1 DeltaGumbel Reweight ", "text_level": 1, "page_idx": 17}, {"type": "text", "text": "In the DeltaGumbel reweight scheme, the watermark code $E$ is a list of $|\\Sigma|$ independent and identically distributed standard Gumbel variables. The reweighting function is defined as: ", "page_idx": 17}, {"type": "equation", "text": "$$\nR_{E}(P):=\\delta_{a^{*}},\\qquad a^{*}:=\\mathrm{argmax}_{a}\\{\\log P(a)\\;+\\;E(a)\\}\n$$", "text_format": "latex", "page_idx": 17}, {"type": "text", "text": "where $\\delta_{a^{*}}$ is the Dirac delta function centered at $a^{*}$ . ", "page_idx": 17}, {"type": "text", "text": "The U score for the DeltaGumbel reweight is defined as: ", "page_idx": 17}, {"type": "equation", "text": "$$\nU=\\exp(-\\exp(-E(x)))\\in[0,1].\n$$", "text_format": "latex", "page_idx": 17}, {"type": "text", "text": "If there is no watermark added while generating $x$ , in other word, if the token $x$ is independent with $E$ , then the random $U$ is uniformly distribution in $[0,1]$ . ", "page_idx": 17}, {"type": "text", "text": "The logarithm of the moment-generating function (MGF) of the $\\mathrm{U}$ score for the DeltaGumbel reweight is given by: ", "page_idx": 17}, {"type": "equation", "text": "$$\n\\log\\mathbb{E}[\\exp(\\lambda U)]=-\\log\\left(\\lambda\\right)+\\log\\left(e^{\\lambda}-1\\right)\\!.\n$$", "text_format": "latex", "page_idx": 17}, {"type": "text", "text": "D.2 Gamma Reweight ", "text_level": 1, "page_idx": 17}, {"type": "text", "text": "In the Gamma reweight scheme, the watermark code $E$ is a random bijection from $\\Sigma$ to the set $\\{0,1,2,\\ldots,|\\Sigma|-1\\}$ . The reweighting function is defined as: ", "page_idx": 17}, {"type": "equation", "text": "$$\n\\begin{array}{r l}&{\\quad\\quad R_{E}(P)(t):=A_{E,P}(E(t))-A_{E,P}(E(t)-1),}\\\\ &{A_{E,P}(i):=\\operatorname*{max}\\left\\{2\\left(\\displaystyle\\sum_{a\\in\\Sigma}\\mathbf{1}(E(a)\\leq i)P(a)\\right)-1,0\\right\\}.}\\end{array}\n$$", "text_format": "latex", "page_idx": 17}, {"type": "text", "text": "The U score for the Gamma reweight is defined as: ", "page_idx": 17}, {"type": "equation", "text": "$$\nU=\\frac{E(x)+\\frac{1}{2}}{|\\Sigma|}\\in[0,1].\n$$", "text_format": "latex", "page_idx": 17}, {"type": "text", "text": "If there is no watermark added while generating $x$ , in other word, if the token $x$ is independent with $E$ $U$ $\\begin{array}{r}{\\{\\frac{\\frac{1}{2}}{|\\Sigma|},\\frac{\\frac{3}{2}}{|\\Sigma|},\\dots,\\frac{|\\Sigma|-\\frac{1}{2}}{|\\Sigma|}\\}}\\end{array}$ ", "page_idx": 17}, {"type": "text", "text": "The logarithm of the moment-generating function (MGF) of the $\\mathrm{U}$ score for the Gamma reweight is given by: ", "page_idx": 17}, {"type": "equation", "text": "$$\n\\log\\mathbb{E}[\\exp(\\lambda U)]=-\\log\\left(2|\\Sigma|\\sinh(\\frac{\\lambda}{2|\\Sigma|})\\right)+\\log\\left(e^{\\lambda}-1\\right).\n$$", "text_format": "latex", "page_idx": 17}, {"type": "text", "text": "Both the DeltaGumbel reweight and Gamma reweight schemes are unbiased [12], meaning that for any distribution $P\\in\\Delta_{\\Sigma}$ , we have: ", "page_idx": 17}, {"type": "equation", "text": "$$\n\\mathbb{E}_{E\\sim P_{E}}[R_{E}(P)]=P.\n$$", "text_format": "latex", "page_idx": 17}, {"type": "text", "text": "The U scores defined for these reweight schemes are likelihood-agnostic, which means that they do not depend on the original distribution $P$ . This property makes them possibly more robust to perturbations compared to likelihood-based scores such as the LLR score. ", "page_idx": 17}, {"type": "text", "text": "To compute the $\\mathbf{P}_{}$ -value for detecting watermarks using the U score, we can substitute the corresponding MGF into Equation (1). ", "page_idx": 17}, {"type": "text", "text": "E Extension to Variants of Speculative Sampling ", "text_level": 1, "page_idx": 17}, {"type": "text", "text": "The analysis and process presented in Section 5 focus on the basic speculative sampling approach, where a single draft token is sampled and then accepted or rejected. Algorithm 1 apply such process multiple times, accepting or rejecting tokens one by one, similar to vanilla speculative sampling. ", "page_idx": 17}, {"type": "text", "text": "Recent developments in speculative sampling have introduced various new techniques, such as verifying the entire sequence, tree verification, or multi-candidacy (see Appendix A for details). ", "page_idx": 17}, {"type": "text", "text": "While Algorithm 1 in Section 5 does not explicitly consider these variants, the underlying ideas can be directly extended to general speculative sampling approaches. ", "page_idx": 18}, {"type": "text", "text": "To maintain the watermark strength, the intuition is to apply the watermark to the draft tokens by sampling them from the watermarked draft model distribution, denoted as $Q_{w}$ . Then, the watermarked target distribution $P_{w}$ is computed, and speculative sampling is performed, treating $Q_{w}$ as the draft model and $P_{w}$ as the target model. Since speculative sampling ensures that the generated content follows the distribution of the target model, the final generated results will be drawn from the distribution $P_{w}$ . Consequently, the watermark strength remains unchanged compared to directly sampling from $P_{w}$ . ", "page_idx": 18}, {"type": "text", "text": "To maintain the sampling efficiency, the intuition is to apply the watermark to the draft tokens by sampling them from the watermarked draft model distribution $Q_{w}$ . Then, speculative sampling is performed, treating $Q$ as the draft model and $P$ as the target model. Under the expectation of random watermark codes, the draft tokens follow the distribution $Q$ . Therefore, the efficiency of speculative sampling remains unchanged compared to directly sampling draft tokens from $Q$ . ", "page_idx": 18}, {"type": "text", "text": "These arguments do not depend on the specific form of speculative sampling, and do not assume the structure of the draft tokens and draft models, making the ideas presented in Section 5 applicable to various speculative sampling variants. ", "page_idx": 18}, {"type": "text", "text": "We acknowledge that experimental validations would be helpful to demonstrate the effectiveness of the extended methods in practice. However, due to implementation/computation cost and the focus of this paper on the foundational theory, we only present a high-level discussion and left out the empirical validations for extended methods. ", "page_idx": 18}, {"type": "text", "text": "F Broader Impacts ", "text_level": 1, "page_idx": 18}, {"type": "text", "text": "This paper presents work whose goal is to accelerate the generation speed of existing watermarking methods for large language models. There are several potential positive societal impacts of our work. By making watermarking techniques more practical and efficient, it may encourage their wider adoption. This can help protect the intellectual property rights. ", "page_idx": 18}, {"type": "text", "text": "However, there are also potential negative societal impacts to consider. Although our unbiased watermarking approach ensures the validity of the model outputs is not compromised, there is a risk that watermarking techniques could be abused. For example, unbiased watermarks are undetectable, which could enable tracking and surveillance, raising privacy concerns. ", "page_idx": 18}, {"type": "text", "text": "To mitigate potential negative impacts, it is important that watermarking techniques are used responsibly. This includes transparency about the use of watermarks, obtaining user consent where applicable, and putting safeguards in place to prevent misuse. ", "page_idx": 18}, {"type": "text", "text": "In conclusion, while our work on accelerating watermarking for language models has the potential to encourage wider adoption and protect intellectual property, it is important to carefully consider and address potential negative societal impacts to ensure the technology is used responsibly and ethically. ", "page_idx": 18}, {"type": "text", "text": "G Limitation ", "text_level": 1, "page_idx": 18}, {"type": "text", "text": "Our work makes significant contributions to the field of watermarking and speculative sampling for large language models, but it also has several limitations. ", "page_idx": 18}, {"type": "text", "text": "In terms of theoretical analysis, the no-go theorem assumes a specific two reweight framework. Although this framework is general, it is possible that other frameworks or methods may lead to different theoretical results. This paper represents the first exploration in this direction, and the two reweight framework is also the first attempt. Future work may discover more powerful frameworks that yield different insights. ", "page_idx": 18}, {"type": "text", "text": "Regarding experimental validation, we use relatively small language models and basic draft model. While our experiments verify the effectiveness of the theory, the acceleration ratio may not represent the state-of-the-art. Speculative sampling techniques have been developing rapidly in recent times. If combined with the latest advances, it should be possible to achieve even higher Average Accepted ", "page_idx": 18}, {"type": "text", "text": "Tokens Per Step (AATPS) and lower Per Token Time (PTT), though it is not directly related to our main contribution. ", "page_idx": 19}, {"type": "text", "text": "The choice of draft sequence length is critical in the deployment. Most of the existing methods select the optimal draft sequence length based on trial and error. This paper does not make contributions to determining the optimal draft sequence length. However, it should be noted that the maintain watermark strength (MWS) method proposed in this paper reduces the speculative efficiency, which also affects the selection of the optimal draft sequence length. Care should be taken in the deployment to optimally select this parameter. ", "page_idx": 19}, {"type": "text", "text": "If the maintain watermark strength (MWS) method is used, the inference speed will decrease slightly. This creates a side channel, and users may infer from this whether the backend service uses the MWS algorithm, which compromises the undetectability of the watermark. ", "page_idx": 19}, {"type": "text", "text": "Despite these limitations, our work provides valuable insights and advances the state-of-the-art in watermarking and speculative sampling techniques for large language models. We hope our findings will stimulate further research to realize the full potential of these techniques. ", "page_idx": 19}, {"type": "text", "text": "H Additional Experiment Results ", "text_level": 1, "page_idx": 19}, {"type": "text", "text": "(a) DeltaGumbel Reweight ", "text_level": 1, "page_idx": 20}, {"type": "image", "img_path": "6YKMBUiIsG/tmp/24c6acf384c47a1e07de86a4680ebd959588fe7511c0ff0887f262ab340a70d3.jpg", "img_caption": [], "img_footnote": [], "page_idx": 20}, {"type": "text", "text": "Figure 3: Text summarization task with LLaMa-13b model [42] as target model and LLaMa- $.68\\mathrm{m}$ model [25] as reference model. ", "page_idx": 20}, {"type": "text", "text": "(a) DeltaGumbel Reweight ", "text_level": 1, "page_idx": 21}, {"type": "image", "img_path": "6YKMBUiIsG/tmp/e71d88bac663b1e17221bac37b1801ce22def4ab5180868980993f3bfec66736.jpg", "img_caption": [], "img_footnote": [], "page_idx": 21}, {"type": "text", "text": "Figure 4: Open-ended text generation task with LLaMa-7b model [42] as target model and LLaMa$68\\mathrm{m}$ model [25] as reference model. ", "page_idx": 21}, {"type": "text", "text": "(a) DeltaGumbel Reweight ", "text_level": 1, "page_idx": 22}, {"type": "image", "img_path": "6YKMBUiIsG/tmp/b318721c1a66ee8e1ebaf7115e81bcfb0cbfa17958b61ae4d859bfffefcfd8c3.jpg", "img_caption": [], "img_footnote": [], "page_idx": 22}, {"type": "text", "text": "Figure 5: Open-ended text generation task with LLaMa-13b model [42] as target model and LLaMa$68\\mathrm{m}$ model [25] as reference model. ", "page_idx": 22}, {"type": "table", "img_path": "6YKMBUiIsG/tmp/f637c10d080f19ff5380466c7f9581047b21a680c33057f833b86f876fd4fb86.jpg", "table_caption": [], "table_footnote": ["Table 1: Text summarization task with LLaMa-7b model [42] as target model and LLaMa-68m model [25] as reference model. "], "page_idx": 23}, {"type": "table", "img_path": "6YKMBUiIsG/tmp/274503af924214c523c4468430922224164b957e484e151a826379fd4736e8ce.jpg", "table_caption": [], "table_footnote": ["Table 2: Text summarization task with LLaMa-13b model [42] as target model and LLaMa-68m model [25] as reference model. "], "page_idx": 24}, {"type": "table", "img_path": "6YKMBUiIsG/tmp/c0e97eaddff83b00e7db82a87be985e87c55fb63cc8785430716052bbadcc342.jpg", "table_caption": [], "table_footnote": ["Table 3: Open-ended text generation task with LLaMa-7b model [42] as target model and LLaMa$68\\mathrm{m}$ model [25] as reference model. "], "page_idx": 25}, {"type": "table", "img_path": "6YKMBUiIsG/tmp/0f574a225036181a8b1761d647b5817dd0153d95d4dcbcebad06691432c0ad29.jpg", "table_caption": [], "table_footnote": ["Table 4: Open-ended text generation task with LLaMa-13b model [42] as target model and LLaMa$68\\mathrm{m}$ model [25] as reference model. "], "page_idx": 26}, {"type": "text", "text": "NeurIPS Paper Checklist ", "text_level": 1, "page_idx": 27}, {"type": "text", "text": "1. Claims ", "text_level": 1, "page_idx": 27}, {"type": "text", "text": "Question: Do the main claims made in the abstract and introduction accurately reflect the paper\u2019s contributions and scope? ", "page_idx": 27}, {"type": "text", "text": "Answer: [Yes] ", "page_idx": 27}, {"type": "text", "text": "Justification: We summarize the main contributions at the end of Section 1. ", "page_idx": 27}, {"type": "text", "text": "Guidelines: ", "page_idx": 27}, {"type": "text", "text": "\u2022 The answer NA means that the abstract and introduction do not include the claims made in the paper.   \n\u2022 The abstract and/or introduction should clearly state the claims made, including the contributions made in the paper and important assumptions and limitations. A No or NA answer to this question will not be perceived well by the reviewers.   \n\u2022 The claims made should match theoretical and experimental results, and reflect how much the results can be expected to generalize to other settings.   \n\u2022 It is fine to include aspirational goals as motivation as long as it is clear that these goals are not attained by the paper. ", "page_idx": 27}, {"type": "text", "text": "2. Limitations ", "text_level": 1, "page_idx": 27}, {"type": "text", "text": "Question: Does the paper discuss the limitations of the work performed by the authors? ", "page_idx": 27}, {"type": "text", "text": "Answer: [Yes] ", "text_level": 1, "page_idx": 27}, {"type": "text", "text": "Justification: See Appendix G. ", "page_idx": 27}, {"type": "text", "text": "Guidelines: ", "page_idx": 27}, {"type": "text", "text": "\u2022 The answer NA means that the paper has no limitation while the answer No means that the paper has limitations, but those are not discussed in the paper.   \n\u2022 The authors are encouraged to create a separate \"Limitations\" section in their paper.   \n\u2022 The paper should point out any strong assumptions and how robust the results are to violations of these assumptions (e.g., independence assumptions, noiseless settings, model well-specification, asymptotic approximations only holding locally). The authors should reflect on how these assumptions might be violated in practice and what the implications would be.   \n\u2022 The authors should reflect on the scope of the claims made, e.g., if the approach was only tested on a few datasets or with a few runs. In general, empirical results often depend on implicit assumptions, which should be articulated.   \n\u2022 The authors should reflect on the factors that influence the performance of the approach. For example, a facial recognition algorithm may perform poorly when image resolution is low or images are taken in low lighting. Or a speech-to-text system might not be used reliably to provide closed captions for online lectures because it fails to handle technical jargon.   \n\u2022 The authors should discuss the computational efficiency of the proposed algorithms and how they scale with dataset size.   \n\u2022 If applicable, the authors should discuss possible limitations of their approach to address problems of privacy and fairness.   \n\u2022 While the authors might fear that complete honesty about limitations might be used by reviewers as grounds for rejection, a worse outcome might be that reviewers discover limitations that aren\u2019t acknowledged in the paper. The authors should use their best judgment and recognize that individual actions in favor of transparency play an important role in developing norms that preserve the integrity of the community. Reviewers will be specifically instructed to not penalize honesty concerning limitations. ", "page_idx": 27}, {"type": "text", "text": "3. Theory Assumptions and Proofs ", "text_level": 1, "page_idx": 27}, {"type": "text", "text": "Question: For each theoretical result, does the paper provide the full set of assumptions and a complete (and correct) proof? ", "page_idx": 27}, {"type": "text", "text": "Answer: [Yes] ", "page_idx": 27}, {"type": "text", "text": "Justification: The conditions under which our theory holds are clearly stated in Theorems 1, 5 and 6 are clearly stated. ", "page_idx": 28}, {"type": "text", "text": "Guidelines: ", "page_idx": 28}, {"type": "text", "text": "\u2022 The answer NA means that the paper does not include theoretical results.   \n\u2022 All the theorems, formulas, and proofs in the paper should be numbered and crossreferenced.   \n\u2022 All assumptions should be clearly stated or referenced in the statement of any theorems.   \n\u2022 The proofs can either appear in the main paper or the supplemental material, but if they appear in the supplemental material, the authors are encouraged to provide a short proof sketch to provide intuition.   \n\u2022 Inversely, any informal proof provided in the core of the paper should be complemented by formal proofs provided in appendix or supplemental material.   \n\u2022 Theorems and Lemmas that the proof relies upon should be properly referenced. ", "page_idx": 28}, {"type": "text", "text": "4. Experimental Result Reproducibility ", "text_level": 1, "page_idx": 28}, {"type": "text", "text": "Question: Does the paper fully disclose all the information needed to reproduce the main experimental results of the paper to the extent that it affects the main claims and/or conclusions of the paper (regardless of whether the code and data are provided or not)? ", "page_idx": 28}, {"type": "text", "text": "Answer: [Yes] ", "page_idx": 28}, {"type": "text", "text": "Justification: All code is provided in the supplementary. ", "page_idx": 28}, {"type": "text", "text": "Guidelines: ", "page_idx": 28}, {"type": "text", "text": "\u2022 The answer NA means that the paper does not include experiments.   \n\u2022 If the paper includes experiments, a No answer to this question will not be perceived well by the reviewers: Making the paper reproducible is important, regardless of whether the code and data are provided or not.   \n\u2022 If the contribution is a dataset and/or model, the authors should describe the steps taken to make their results reproducible or verifiable.   \n\u2022 Depending on the contribution, reproducibility can be accomplished in various ways. For example, if the contribution is a novel architecture, describing the architecture fully might suffice, or if the contribution is a specific model and empirical evaluation, it may be necessary to either make it possible for others to replicate the model with the same dataset, or provide access to the model. In general. releasing code and data is often one good way to accomplish this, but reproducibility can also be provided via detailed instructions for how to replicate the results, access to a hosted model (e.g., in the case of a large language model), releasing of a model checkpoint, or other means that are appropriate to the research performed.   \n\u2022 While NeurIPS does not require releasing code, the conference does require all submissions to provide some reasonable avenue for reproducibility, which may depend on the nature of the contribution. For example (a) If the contribution is primarily a new algorithm, the paper should make it clear how to reproduce that algorithm. (b) If the contribution is primarily a new model architecture, the paper should describe the architecture clearly and fully. (c) If the contribution is a new model (e.g., a large language model), then there should either be a way to access this model for reproducing the results or a way to reproduce the model (e.g., with an open-source dataset or instructions for how to construct the dataset). (d) We recognize that reproducibility may be tricky in some cases, in which case authors are welcome to describe the particular way they provide for reproducibility. In the case of closed-source models, it may be that access to the model is limited in some way (e.g., to registered users), but it should be possible for other researchers to have some path to reproducing or verifying the results. ", "page_idx": 28}, {"type": "text", "text": "5. Open access to data and code ", "text_level": 1, "page_idx": 28}, {"type": "text", "text": "Question: Does the paper provide open access to the data and code, with sufficient instructions to faithfully reproduce the main experimental results, as described in supplemental material? ", "page_idx": 28}, {"type": "text", "text": "Answer: [Yes] ", "page_idx": 29}, {"type": "text", "text": "Justification: All code is provided in the supplementary. Data can be obtained online. Guidelines: ", "page_idx": 29}, {"type": "text", "text": "\u2022 The answer NA means that paper does not include experiments requiring code.   \n\u2022 Please see the NeurIPS code and data submission guidelines (https://nips.cc/ public/guides/CodeSubmissionPolicy) for more details.   \n\u2022 While we encourage the release of code and data, we understand that this might not be possible, so \u201cNo\u201d is an acceptable answer. Papers cannot be rejected simply for not including code, unless this is central to the contribution (e.g., for a new open-source benchmark).   \n\u2022 The instructions should contain the exact command and environment needed to run to reproduce the results. See the NeurIPS code and data submission guidelines (https: //nips.cc/public/guides/CodeSubmissionPolicy) for more details.   \n\u2022 The authors should provide instructions on data access and preparation, including how to access the raw data, preprocessed data, intermediate data, and generated data, etc.   \n\u2022 The authors should provide scripts to reproduce all experimental results for the new proposed method and baselines. If only a subset of experiments are reproducible, they should state which ones are omitted from the script and why.   \n\u2022 At submission time, to preserve anonymity, the authors should release anonymized versions (if applicable).   \n\u2022 Providing as much information as possible in supplemental material (appended to the paper) is recommended, but including URLs to data and code is permitted. ", "page_idx": 29}, {"type": "text", "text": "6. Experimental Setting/Details ", "text_level": 1, "page_idx": 29}, {"type": "text", "text": "Question: Does the paper specify all the training and test details (e.g., data splits, hyperparameters, how they were chosen, type of optimizer, etc.) necessary to understand the results? ", "page_idx": 29}, {"type": "text", "text": "Answer: [Yes] ", "page_idx": 29}, {"type": "text", "text": "Justification: The definition of algorithm and metrics used in the experiments are reported in the paper. Code is provided. ", "page_idx": 29}, {"type": "text", "text": "Guidelines: ", "page_idx": 29}, {"type": "text", "text": "\u2022 The answer NA means that the paper does not include experiments. \u2022 The experimental setting should be presented in the core of the paper to a level of detail that is necessary to appreciate the results and make sense of them. \u2022 The full details can be provided either with the code, in appendix, or as supplemental material. ", "page_idx": 29}, {"type": "text", "text": "7. Experiment Statistical Significance ", "text_level": 1, "page_idx": 29}, {"type": "text", "text": "Question: Does the paper report error bars suitably and correctly defined or other appropriate information about the statistical significance of the experiments? ", "page_idx": 29}, {"type": "text", "text": "Answer: [Yes] ", "text_level": 1, "page_idx": 29}, {"type": "text", "text": "Justification: We report $3\\sigma$ interval in Figure 2 and Appendix H. ", "page_idx": 29}, {"type": "text", "text": "Guidelines: ", "page_idx": 29}, {"type": "text", "text": "\u2022 The answer NA means that the paper does not include experiments.   \n\u2022 The authors should answer \"Yes\" if the results are accompanied by error bars, confidence intervals, or statistical significance tests, at least for the experiments that support the main claims of the paper.   \n\u2022 The factors of variability that the error bars are capturing should be clearly stated (for example, train/test split, initialization, random drawing of some parameter, or overall run with given experimental conditions).   \n\u2022 The method for calculating the error bars should be explained (closed form formula, call to a library function, bootstrap, etc.)   \n\u2022 The assumptions made should be given (e.g., Normally distributed errors).   \n\u2022 It should be clear whether the error bar is the standard deviation or the standard error of the mean.   \n\u2022 It is OK to report 1-sigma error bars, but one should state it. The authors should preferably report a 2-sigma error bar than state that they have a $96\\%$ CI, if the hypothesis of Normality of errors is not verified.   \n\u2022 For asymmetric distributions, the authors should be careful not to show in tables or figures symmetric error bars that would yield results that are out of range (e.g. negative error rates).   \n\u2022 If error bars are reported in tables or plots, The authors should explain in the text how they were calculated and reference the corresponding figures or tables in the text. ", "page_idx": 29}, {"type": "text", "text": "", "page_idx": 30}, {"type": "text", "text": "8. Experiments Compute Resources ", "text_level": 1, "page_idx": 30}, {"type": "text", "text": "Question: For each experiment, does the paper provide sufficient information on the computer resources (type of compute workers, memory, time of execution) needed to reproduce the experiments? ", "page_idx": 30}, {"type": "text", "text": "Answer: [Yes] ", "page_idx": 30}, {"type": "text", "text": "Justification: As reported in Section 6, the total computational cost for reproducing all the experiments in this paper is approximately 1200 A6000 GPU hours. ", "page_idx": 30}, {"type": "text", "text": "Guidelines: ", "page_idx": 30}, {"type": "text", "text": "\u2022 The answer NA means that the paper does not include experiments.   \n\u2022 The paper should indicate the type of compute workers CPU or GPU, internal cluster, or cloud provider, including relevant memory and storage.   \n\u2022 The paper should provide the amount of compute required for each of the individual experimental runs as well as estimate the total compute.   \n\u2022 The paper should disclose whether the full research project required more compute than the experiments reported in the paper (e.g., preliminary or failed experiments that didn\u2019t make it into the paper). ", "page_idx": 30}, {"type": "text", "text": "9. Code Of Ethics ", "text_level": 1, "page_idx": 30}, {"type": "text", "text": "Question: Does the research conducted in the paper conform, in every respect, with the NeurIPS Code of Ethics https://neurips.cc/public/EthicsGuidelines? ", "page_idx": 30}, {"type": "text", "text": "Answer: [Yes] ", "page_idx": 30}, {"type": "text", "text": "Justification: We have reviewed the NeurIPS Code of Ethics. ", "page_idx": 30}, {"type": "text", "text": "Guidelines: ", "page_idx": 30}, {"type": "text", "text": "\u2022 The answer NA means that the authors have not reviewed the NeurIPS Code of Ethics.   \n\u2022 If the authors answer No, they should explain the special circumstances that require a deviation from the Code of Ethics.   \n\u2022 The authors should make sure to preserve anonymity (e.g., if there is a special consideration due to laws or regulations in their jurisdiction). ", "page_idx": 30}, {"type": "text", "text": "10. Broader Impacts ", "text_level": 1, "page_idx": 30}, {"type": "text", "text": "Question: Does the paper discuss both potential positive societal impacts and negative societal impacts of the work performed? ", "page_idx": 30}, {"type": "text", "text": "Answer: [Yes] ", "page_idx": 30}, {"type": "text", "text": "Justification: See Appendix F. ", "page_idx": 30}, {"type": "text", "text": "Guidelines: ", "page_idx": 30}, {"type": "text", "text": "\u2022 The answer NA means that there is no societal impact of the work performed.   \n\u2022 If the authors answer NA or No, they should explain why their work has no societal impact or why the paper does not address societal impact.   \n\u2022 Examples of negative societal impacts include potential malicious or unintended uses (e.g., disinformation, generating fake profiles, surveillance), fairness considerations (e.g., deployment of technologies that could make decisions that unfairly impact specific groups), privacy considerations, and security considerations.   \n\u2022 The conference expects that many papers will be foundational research and not tied to particular applications, let alone deployments. However, if there is a direct path to any negative applications, the authors should point it out. For example, it is legitimate to point out that an improvement in the quality of generative models could be used to generate deepfakes for disinformation. On the other hand, it is not needed to point out that a generic algorithm for optimizing neural networks could enable people to train models that generate Deepfakes faster.   \n\u2022 The authors should consider possible harms that could arise when the technology is being used as intended and functioning correctly, harms that could arise when the technology is being used as intended but gives incorrect results, and harms following from (intentional or unintentional) misuse of the technology.   \n\u2022 If there are negative societal impacts, the authors could also discuss possible mitigation strategies (e.g., gated release of models, providing defenses in addition to attacks, mechanisms for monitoring misuse, mechanisms to monitor how a system learns from feedback over time, improving the efficiency and accessibility of ML). ", "page_idx": 30}, {"type": "text", "text": "", "page_idx": 31}, {"type": "text", "text": "11. Safeguards ", "text_level": 1, "page_idx": 31}, {"type": "text", "text": "Question: Does the paper describe safeguards that have been put in place for responsible release of data or models that have a high risk for misuse (e.g., pretrained language models, image generators, or scraped datasets)? ", "page_idx": 31}, {"type": "text", "text": "Answer: [NA] ", "page_idx": 31}, {"type": "text", "text": "Justification: This paper doesn\u2019t release new data or model. ", "page_idx": 31}, {"type": "text", "text": "Guidelines: ", "page_idx": 31}, {"type": "text", "text": "\u2022 The answer NA means that the paper poses no such risks.   \n\u2022 Released models that have a high risk for misuse or dual-use should be released with necessary safeguards to allow for controlled use of the model, for example by requiring that users adhere to usage guidelines or restrictions to access the model or implementing safety filters.   \n\u2022 Datasets that have been scraped from the Internet could pose safety risks. The authors should describe how they avoided releasing unsafe images.   \n\u2022 We recognize that providing effective safeguards is challenging, and many papers do not require this, but we encourage authors to take this into account and make a best faith effort. ", "page_idx": 31}, {"type": "text", "text": "12. Licenses for existing assets ", "text_level": 1, "page_idx": 31}, {"type": "text", "text": "Question: Are the creators or original owners of assets (e.g., code, data, models), used in the paper, properly credited and are the license and terms of use explicitly mentioned and properly respected? ", "page_idx": 31}, {"type": "text", "text": "Answer: [Yes] ", "text_level": 1, "page_idx": 31}, {"type": "text", "text": "Justification: We cite See et al. [33], Hermann et al. [10] for CNN_DAILYMAIL dataset. Guidelines: ", "page_idx": 31}, {"type": "text", "text": "\u2022 The answer NA means that the paper does not use existing assets.   \n\u2022 The authors should cite the original paper that produced the code package or dataset.   \n\u2022 The authors should state which version of the asset is used and, if possible, include a URL.   \n\u2022 The name of the license (e.g., CC-BY 4.0) should be included for each asset.   \n\u2022 For scraped data from a particular source (e.g., website), the copyright and terms of service of that source should be provided.   \n\u2022 If assets are released, the license, copyright information, and terms of use in the package should be provided. For popular datasets, paperswithcode.com/datasets has curated licenses for some datasets. Their licensing guide can help determine the license of a dataset.   \n\u2022 For existing datasets that are re-packaged, both the original license and the license of the derived asset (if it has changed) should be provided. ", "page_idx": 31}, {"type": "text", "text": "\u2022 If this information is not available online, the authors are encouraged to reach out to the asset\u2019s creators. ", "page_idx": 32}, {"type": "text", "text": "13. New Assets ", "text_level": 1, "page_idx": 32}, {"type": "text", "text": "Question: Are new assets introduced in the paper well documented and is the documentation provided alongside the assets? ", "page_idx": 32}, {"type": "text", "text": "Answer: [NA] ", "page_idx": 32}, {"type": "text", "text": "Justification: This paper does not release new assets. ", "page_idx": 32}, {"type": "text", "text": "Guidelines: ", "page_idx": 32}, {"type": "text", "text": "\u2022 The answer NA means that the paper does not release new assets.   \n\u2022 Researchers should communicate the details of the dataset/code/model as part of their submissions via structured templates. This includes details about training, license, limitations, etc.   \n\u2022 The paper should discuss whether and how consent was obtained from people whose asset is used.   \n\u2022 At submission time, remember to anonymize your assets (if applicable). You can either create an anonymized URL or include an anonymized zip file. ", "page_idx": 32}, {"type": "text", "text": "14. Crowdsourcing and Research with Human Subjects ", "text_level": 1, "page_idx": 32}, {"type": "text", "text": "Question: For crowdsourcing experiments and research with human subjects, does the paper include the full text of instructions given to participants and screenshots, if applicable, as well as details about compensation (if any)? ", "page_idx": 32}, {"type": "text", "text": "Answer: [NA] ", "page_idx": 32}, {"type": "text", "text": "Justification: No human subject is involved in this study. ", "page_idx": 32}, {"type": "text", "text": "Guidelines: ", "page_idx": 32}, {"type": "text", "text": "\u2022 The answer NA means that the paper does not involve crowdsourcing nor research with human subjects.   \n\u2022 Including this information in the supplemental material is fine, but if the main contribution of the paper involves human subjects, then as much detail as possible should be included in the main paper.   \n\u2022 According to the NeurIPS Code of Ethics, workers involved in data collection, curation, or other labor should be paid at least the minimum wage in the country of the data collector. ", "page_idx": 32}, {"type": "text", "text": "15. Institutional Review Board (IRB) Approvals or Equivalent for Research with Human Subjects ", "text_level": 1, "page_idx": 32}, {"type": "text", "text": "Question: Does the paper describe potential risks incurred by study participants, whether such risks were disclosed to the subjects, and whether Institutional Review Board (IRB) approvals (or an equivalent approval/review based on the requirements of your country or institution) were obtained? ", "page_idx": 32}, {"type": "text", "text": "Answer: [NA] ", "page_idx": 32}, {"type": "text", "text": "Justification: No human subject is involved in this study. ", "page_idx": 32}, {"type": "text", "text": "Guidelines: ", "page_idx": 32}, {"type": "text", "text": "\u2022 The answer NA means that the paper does not involve crowdsourcing nor research with human subjects.   \n\u2022 Depending on the country in which research is conducted, IRB approval (or equivalent) may be required for any human subjects research. If you obtained IRB approval, you should clearly state this in the paper.   \n\u2022 We recognize that the procedures for this may vary significantly between institutions and locations, and we expect authors to adhere to the NeurIPS Code of Ethics and the guidelines for their institution.   \n\u2022 For initial submissions, do not include any information that would break anonymity (if applicable), such as the institution conducting the review. ", "page_idx": 32}]